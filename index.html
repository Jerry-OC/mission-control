<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cody Design Build â€” Mission Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050508;
    --bg2: #0d0d14;
    --card: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.07);
    --accent: #f97316;
    --accent2: #fb923c;
    --text: #e8e8f0;
    --muted: #6b7280;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; }

  /* â”€â”€â”€ AUTH GATE â”€â”€â”€ */
  #auth-overlay {
    position:fixed; inset:0; z-index:9999;
    background:var(--bg);
    display:flex; align-items:center; justify-content:center;
    animation:fadeIn 0.3s ease;
  }
  #auth-overlay.hidden { display:none; }

  .auth-box {
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:20px;
    padding:3rem 2.5rem;
    width:100%;
    max-width:400px;
    backdrop-filter:blur(24px);
    box-shadow:0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .auth-box::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--accent), var(--accent2), var(--purple));
  }
  .auth-logo {
    font-size:1.1rem; font-weight:700; color:var(--accent);
    letter-spacing:-0.02em; margin-bottom:0.25rem;
  }
  .auth-logo span { color:var(--text); font-weight:400; }
  .auth-title {
    font-size:1.5rem; font-weight:700; letter-spacing:-0.03em;
    margin:1.25rem 0 0.4rem;
  }
  .auth-subtitle { font-size:0.82rem; color:var(--muted); margin-bottom:2rem; }

  .auth-field {
    position:relative; margin-bottom:1rem;
  }
  .auth-field input {
    width:100%;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:10px;
    padding:0.8rem 1rem;
    font-size:1rem;
    font-family:'Inter',sans-serif;
    color:var(--text);
    outline:none;
    transition:border-color 0.2s, box-shadow 0.2s;
    letter-spacing:0.1em;
    text-align:center;
  }
  .auth-field input::placeholder { letter-spacing:normal; color:var(--muted); }
  .auth-field input:focus {
    border-color:rgba(249,115,22,0.5);
    box-shadow:0 0 0 3px rgba(249,115,22,0.1);
  }
  .auth-field label {
    display:block; font-size:0.72rem; font-weight:600;
    text-transform:uppercase; letter-spacing:0.08em;
    color:var(--muted); margin-bottom:0.5rem; text-align:left;
  }

  .auth-btn {
    width:100%; padding:0.85rem;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    border:none; border-radius:10px;
    font-size:0.9rem; font-weight:600;
    font-family:'Inter',sans-serif;
    color:#fff; cursor:pointer;
    transition:opacity 0.15s, transform 0.1s;
    letter-spacing:0.01em;
  }
  .auth-btn:hover { opacity:0.9; transform:translateY(-1px); }
  .auth-btn:active { transform:translateY(0); }
  .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

  .auth-error {
    margin-top:0.75rem; padding:0.6rem 1rem;
    background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2);
    border-radius:8px; font-size:0.8rem; color:var(--red);
    display:none;
  }
  .auth-error.show { display:block; }

  .auth-spinner {
    display:inline-block; width:14px; height:14px;
    border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin 0.6s linear infinite;
    vertical-align:middle; margin-right:0.4rem;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  .auth-footer {
    margin-top:1.5rem; font-size:0.72rem; color:var(--muted);
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  header {
    position:sticky; top:0; z-index:100;
    background:rgba(5,5,8,0.85);
    backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
    padding:0 2rem;
    display:flex; align-items:center; justify-content:space-between;
    height:60px;
  }
  .logo { font-size:1rem; font-weight:700; color:var(--accent); letter-spacing:-0.02em; }
  .logo span { color:var(--text); font-weight:400; }
  nav { display:flex; gap:0.25rem; }
  nav button {
    background:none; border:none; color:var(--muted);
    padding:0.4rem 0.9rem; border-radius:6px;
    font-size:0.85rem; font-family:'Inter',sans-serif;
    cursor:pointer; transition:all 0.15s;
  }
  nav button:hover { color:var(--text); background:var(--card); }
  nav button.active { color:var(--accent); background:rgba(249,115,22,0.1); }
  .header-right { display:flex; align-items:center; gap:1rem; }
  #clock { font-size:0.8rem; color:var(--muted); font-variant-numeric:tabular-nums; }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  #signout-btn {
    font-size:0.75rem; color:var(--muted); cursor:pointer;
    background:none; border:none; font-family:'Inter',sans-serif;
    padding:0.25rem 0.5rem; border-radius:4px;
    transition:color 0.15s, background 0.15s;
  }
  #signout-btn:hover { color:var(--red); background:rgba(239,68,68,0.08); }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  main { max-width:1400px; margin:0 auto; padding:2rem; }

  /* â”€â”€â”€ TAB PANELS â”€â”€â”€ */
  .tab-panel { display:none; animation:fadeIn 0.2s ease; }
  .tab-panel.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* â”€â”€â”€ CARDS â”€â”€â”€ */
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:1.25rem;
    backdrop-filter:blur(10px);
  }
  .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
  .card-title { font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); }

  /* â”€â”€â”€ METRICS GRID â”€â”€â”€ */
  .metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:1.5rem; }
  .metric-card {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; padding:1.25rem; position:relative; overflow:hidden;
  }
  .metric-bar { position:absolute; top:0; left:0; right:0; height:3px; }
  .metric-icon { font-size:1.4rem; margin-bottom:0.5rem; }
  .metric-label { font-size:0.75rem; color:var(--muted); margin-bottom:0.25rem; }
  .metric-value { font-size:1.8rem; font-weight:700; letter-spacing:-0.02em; }
  .metric-sub { font-size:0.75rem; color:var(--muted); margin-top:0.25rem; }
  .trend-up { color:var(--green); }
  .trend-dn { color:var(--red); }

  /* â”€â”€â”€ GRIDS â”€â”€â”€ */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1rem; }

  /* â”€â”€â”€ TABLES â”€â”€â”€ */
  table { width:100%; border-collapse:collapse; }
  th { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); padding:0.5rem 0.75rem; text-align:left; border-bottom:1px solid var(--border); }
  td { padding:0.65rem 0.75rem; font-size:0.85rem; border-bottom:1px solid rgba(255,255,255,0.03); }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:rgba(255,255,255,0.02); }

  /* â”€â”€â”€ BADGES â”€â”€â”€ */
  .badge { display:inline-flex; align-items:center; gap:0.3rem; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.72rem; font-weight:600; }
  .badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
  .badge-yellow { background:rgba(234,179,8,0.15); color:var(--yellow); }
  .badge-red { background:rgba(239,68,68,0.15); color:var(--red); }
  .badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
  .badge-orange { background:rgba(249,115,22,0.15); color:var(--accent); }
  .badge-muted { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* â”€â”€â”€ PROGRESS â”€â”€â”€ */
  .progress-bar { background:rgba(255,255,255,0.06); border-radius:4px; height:6px; overflow:hidden; }
  .progress-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }

  /* â”€â”€â”€ PRIORITIES â”€â”€â”€ */
  .priority-item { display:flex; align-items:center; gap:0.75rem; padding:0.6rem 0; border-bottom:1px solid var(--border); }
  .priority-item:last-child { border-bottom:none; }
  .priority-item input[type=checkbox] { accent-color:var(--accent); width:16px; height:16px; cursor:pointer; }
  .priority-item label { font-size:0.875rem; cursor:pointer; flex:1; }
  .priority-item label.done { text-decoration:line-through; color:var(--muted); }

  /* â”€â”€â”€ AGENT CARDS â”€â”€â”€ */
  .agent-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:1rem; }
  @media(max-width:700px){ .agent-grid { grid-template-columns:1fr; } }
  .agent-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; transition:border-color 0.2s; }
  .agent-card.agent-active { border-color:rgba(34,197,94,0.3); }
  .agent-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:0.75rem; }
  .agent-emoji { font-size:1.8rem; }
  .agent-name { font-weight:600; font-size:1rem; }
  .agent-role { font-size:0.75rem; color:var(--muted); }
  .agent-status-row { display:flex; align-items:center; gap:0.4rem; font-size:0.78rem; margin-bottom:0.5rem; }
  .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .dot-green { background:var(--green); box-shadow:0 0 6px var(--green); animation:pulse-green 2s infinite; }
  .dot-yellow { background:var(--yellow); }
  .dot-gray { background:var(--muted); }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 4px var(--green);} 50%{box-shadow:0 0 10px var(--green);} }
  .agent-last-active { font-size:0.7rem; color:var(--muted); margin-bottom:0.75rem; }
  .agent-caps { display:flex; flex-wrap:wrap; gap:0.35rem; margin-bottom:0.85rem; }
  .agent-model-row { display:flex; align-items:center; gap:0.5rem; margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); }
  .agent-model-label { font-size:0.72rem; color:var(--muted); white-space:nowrap; }
  .model-select { flex:1; background:var(--bg2); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:0.25rem 0.4rem; font-size:0.72rem; font-family:'Inter',sans-serif; cursor:pointer; }
  .model-select:focus { outline:none; border-color:var(--accent); }
  .model-save-btn { font-size:0.7rem; padding:0.25rem 0.6rem; border-radius:6px; border:1px solid var(--accent); background:transparent; color:var(--accent); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .model-save-btn:hover { background:rgba(249,115,22,0.15); }
  .model-save-btn:disabled { opacity:0.4; cursor:default; }
  .agent-offline-note { font-size:0.7rem; color:var(--muted); font-style:italic; margin-top:0.4rem; }
  .agents-live-badge { display:flex; align-items:center; gap:0.4rem; font-size:0.72rem; color:var(--muted); }
  .agents-live-badge .dot { width:5px; height:5px; }

  /* â”€â”€â”€ INBOX ITEMS â”€â”€â”€ */
  .inbox-item { display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); }
  .inbox-left { display:flex; flex-direction:column; gap:0.2rem; }
  .inbox-vendor { font-size:0.875rem; font-weight:500; }
  .inbox-desc { font-size:0.75rem; color:var(--muted); }
  .inbox-amount { font-size:1rem; font-weight:600; }
  .inbox-amount.debit { color:var(--red); }
  .inbox-amount.credit { color:var(--green); }

  /* â”€â”€â”€ SECTION HEADERS â”€â”€â”€ */
  h2 { font-size:1.2rem; font-weight:700; margin-bottom:1rem; letter-spacing:-0.02em; }
  h3 { font-size:0.95rem; font-weight:600; margin-bottom:0.75rem; }

  /* â”€â”€â”€ WELCOME BAR â”€â”€â”€ */
  .welcome { margin-bottom:1.5rem; }
  .welcome h1 { font-size:1.6rem; font-weight:700; letter-spacing:-0.03em; }
  .welcome p { color:var(--muted); font-size:0.875rem; margin-top:0.25rem; }

  /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
  .divider { border:none; border-top:1px solid var(--border); margin:1rem 0; }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
  .btn { background:var(--accent); color:#fff; border:none; padding:0.5rem 1rem; border-radius:8px; font-size:0.8rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:opacity 0.15s; }
  .btn:hover { opacity:0.85; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-ghost:hover { background:var(--card); }

  /* â”€â”€â”€ JOB CARD â”€â”€â”€ */
  .job-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; margin-bottom:0.75rem; transition:border-color 0.2s; }
  .job-card:hover { border-color:rgba(255,255,255,0.12); }
  .job-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
  .job-name { font-weight:600; font-size:0.95rem; }
  .job-number { font-size:0.75rem; color:var(--muted); margin-top:0.15rem; }
  .job-budget-row { display:flex; justify-content:space-between; font-size:0.78rem; margin-bottom:0.4rem; }
  .job-budget-row span { color:var(--muted); }
  .job-budget-row strong { color:var(--text); }

  /* â”€â”€â”€ LAST UPDATED â”€â”€â”€ */
  #last-updated {
    font-size:0.72rem; color:var(--muted);
    text-align:right; margin-bottom:0.75rem;
    transition:opacity 0.3s;
  }

  /* â”€â”€â”€ LOADING / ERROR STATES â”€â”€â”€ */
  .state-loading { text-align:center; padding:2rem; color:var(--muted); font-size:0.85rem; }
  .state-error { text-align:center; padding:1.5rem; color:var(--red); font-size:0.82rem; background:rgba(239,68,68,0.06); border-radius:8px; border:1px solid rgba(239,68,68,0.15); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH GATE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-logo">CDB <span>Mission Control</span></div>
    <h2 class="auth-title">Welcome back</h2>
    <p class="auth-subtitle">Enter your access code to continue</p>

    <div class="auth-field">
      <label for="auth-code-input">Access Code</label>
      <input
        type="password"
        id="auth-code-input"
        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        autocomplete="off"
        spellcheck="false"
        autofocus
      >
    </div>

    <button class="auth-btn" id="auth-submit-btn" onclick="submitAuth()">
      Request Access
    </button>

    <div class="auth-error" id="auth-error"></div>

    <div class="auth-footer">Cody Design Build Inc. Â· Private System</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP (hidden until authed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none">

<header>
  <div class="logo">CDB <span>Mission Control</span></div>
  <nav>
    <button class="active" onclick="showTab('dashboard',this)">ğŸ“Š Dashboard</button>
    <button onclick="showTab('jobs',this)">ğŸ—ï¸ Jobs</button>
    <button onclick="showTab('inbox',this)">ğŸ“¥ Cost Inbox</button>
    <button onclick="showTab('revenue',this)">ğŸ’° Revenue</button>
    <button onclick="showTab('agents',this)">ğŸ¤– Agents</button>
  </nav>
  <div class="header-right">
    <span id="clock"></span>
    <div class="status-dot"></div>
    <button id="signout-btn" onclick="signOut()" title="Sign out">Sign out</button>
  </div>
</header>

<main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-dashboard" class="tab-panel active">
  <div class="welcome">
    <h1 id="greeting">Good morning, David ğŸ‘‹</h1>
    <p id="date-line">Loading...</p>
  </div>

  <div id="last-updated"></div>

  <div class="metrics">
    <!-- Active Jobs -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      <div class="metric-icon">ğŸ—ï¸</div>
      <div class="metric-label">Active Jobs</div>
      <div class="metric-value" id="metric-jobs-count">â€”</div>
      <div class="metric-sub" id="metric-jobs-value">loadingâ€¦</div>
    </div>
    <!-- Cost Inbox -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">ğŸ“¥</div>
      <div class="metric-label">Cost Inbox</div>
      <div class="metric-value" id="metric-inbox-count">â€”</div>
      <div class="metric-sub">transactions to code</div>
    </div>
    <!-- Open Invoices -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">ğŸ’µ</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="metric-invoices-owed">â€”</div>
      <div class="metric-sub" id="metric-invoices-sub">loadingâ€¦</div>
    </div>
    <!-- Draft Bills (static) -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--purple),#c084fc)"></div>
      <div class="metric-icon">ğŸ“‹</div>
      <div class="metric-label">Draft Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 vendor bills pending</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header">
        <span class="card-title">Top Priorities</span>
        <button class="btn btn-ghost" style="font-size:0.72rem;padding:0.25rem 0.6rem" onclick="addPriority()">+ Add</button>
      </div>
      <div id="priorities">
        <div class="priority-item"><input type="checkbox" id="p1" onchange="toggleDone(this)"><label for="p1">Fix Phil's pairing â€” OpenClaw menubar app</label></div>
        <div class="priority-item"><input type="checkbox" id="p2" onchange="toggleDone(this)"><label for="p2">Code this week's Plaid transactions</label></div>
        <div class="priority-item"><input type="checkbox" id="p3" onchange="toggleDone(this)"><label for="p3">Send invoice to Balboa client</label></div>
        <div class="priority-item"><input type="checkbox" id="p4" onchange="toggleDone(this)"><label for="p4">Approve Graham Plastering bill ($9K)</label></div>
        <div class="priority-item"><input type="checkbox" id="p5" onchange="toggleDone(this)"><label for="p5">Invite assistant@codydesignbuild.com to Airtable</label></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><span class="card-title">Activity Feed</span></div>
      <div id="activity-feed" style="font-size:0.82rem;">
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Jerry pulled Plaid transactions</span><span style="color:var(--muted)">just now</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>JT API skill built + tested</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Phil agent created (pairing pending)</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>memory-lancedb enabled</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0"><span>Google Workspace connected</span><span style="color:var(--muted)">today</span></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOBS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-jobs" class="tab-panel">
  <h2>Active Jobs</h2>
  <div id="jobs-list">
    <div class="state-loading">Loading jobsâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COST INBOX TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-inbox" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
    <h2 style="margin:0">Cost Inbox â€” Plaid Transactions</h2>
    <span class="badge badge-red" id="inbox-badge">â€”</span>
  </div>

  <div class="card" style="margin-bottom:1rem">
    <div style="font-size:0.82rem;color:var(--muted)">
      These are bank transactions pulled from <strong style="color:var(--text)">Business Checking ...4687</strong> via Plaid that haven't been coded to a job yet.
    </div>
  </div>

  <div id="inbox-list">
    <div class="state-loading">Loading transactionsâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REVENUE TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-revenue" class="tab-panel">
  <h2>Revenue Overview</h2>
  <div class="metrics" style="grid-template-columns:repeat(3,1fr)">
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">ğŸ“Š</div>
      <div class="metric-label">Total Pipeline</div>
      <div class="metric-value" id="rev-pipeline">â€”</div>
      <div class="metric-sub" id="rev-pipeline-sub">loadingâ€¦</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--yellow),#fde047)"></div>
      <div class="metric-icon">ğŸ§¾</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="rev-open-invoices">â€”</div>
      <div class="metric-sub" id="rev-invoices-sub">loadingâ€¦</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">ğŸ“¤</div>
      <div class="metric-label">Draft Vendor Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 bills to approve</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span class="card-title">Open Customer Invoices</span></div>
    <table>
      <thead><tr><th>Job</th><th>Invoice</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody id="invoice-rows">
        <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">Draft Vendor Bills</span></div>
    <table>
      <thead><tr><th>Vendor</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>Graham Plastering</td><td>$9,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
        <tr><td>Other</td><td>$32,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AGENTS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-agents" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">
    <h2 style="margin:0">Agent Command Center</h2>
    <div class="agents-live-badge" id="agents-live-badge">
      <div class="dot dot-gray"></div><span>Connectingâ€¦</span>
    </div>
  </div>

  <div class="agent-grid" id="agent-grid">
    <div style="color:var(--muted);font-size:0.85rem;padding:2rem;grid-column:1/-1;text-align:center">Loading agentsâ€¦</div>
  </div>

  <div class="card" id="system-status-card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">System Status</span></div>
    <table>
      <thead><tr><th>Component</th><th>Status</th><th>Detail</th></tr></thead>
      <tbody id="system-status-body">
        <tr><td>Gateway</td><td><span class="badge badge-muted">Checkingâ€¦</span></td><td></td></tr>
      </tbody>
    </table>
  </div>
</div>

</main>
</div><!-- /#app -->

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TOKEN_KEY = 'mc_token';

function getToken() {
  return localStorage.getItem(TOKEN_KEY);
}

function showApp() {
  document.getElementById('auth-overlay').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
  loadData();
}

function showAuthOverlay() {
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('app').style.display = 'none';
  setTimeout(() => document.getElementById('auth-code-input').focus(), 100);
}

function setAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}

function clearAuthError() {
  document.getElementById('auth-error').classList.remove('show');
}

async function submitAuth() {
  const input = document.getElementById('auth-code-input');
  const btn   = document.getElementById('auth-submit-btn');
  const code  = input.value.trim();

  if (!code) { setAuthError('Please enter your access code.'); return; }

  clearAuthError();
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Verifyingâ€¦';

  try {
    const res  = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code }),
    });
    const data = await res.json();

    if (data.ok && data.token) {
      localStorage.setItem(TOKEN_KEY, data.token);
      input.value = '';
      showApp();
    } else {
      setAuthError(data.error || 'Access denied. Check your code and try again.');
      input.value = '';
      input.focus();
    }
  } catch (err) {
    setAuthError('Connection error â€” please try again.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Request Access';
  }
}

function signOut() {
  localStorage.removeItem(TOKEN_KEY);
  showAuthOverlay();
}

// Allow Enter key on the access code input
document.getElementById('auth-code-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitAuth();
});

// Boot: check token
(function bootAuth() {
  const token = getToken();
  if (token) {
    // Token exists â€” trust it and show app (server validates on every API call)
    showApp();
  } else {
    showAuthOverlay();
  }
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK & GREETING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateClock() {
  const now = new Date();
  const clockEl = document.getElementById('clock');
  if (clockEl) {
    clockEl.textContent = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }
  const hour = now.getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  const greetEl = document.getElementById('greeting');
  if (greetEl) greetEl.textContent = `${greeting}, David ğŸ‘‹`;
  const dateEl = document.getElementById('date-line');
  if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' Â· Cody Design Build Inc.';
}
updateClock();
setInterval(updateClock, 1000);


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRIORITIES (localStorage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleDone(cb) {
  cb.nextElementSibling.classList.toggle('done', cb.checked);
  savePriorities();
}
function addPriority() {
  const text = prompt('New priority:');
  if (!text) return;
  const id  = 'p' + Date.now();
  const div = document.createElement('div');
  div.className = 'priority-item';
  div.innerHTML = `<input type="checkbox" id="${id}" onchange="toggleDone(this)"><label for="${id}">${text}</label>`;
  document.getElementById('priorities').appendChild(div);
  savePriorities();
}
function savePriorities() {
  const items = [...document.querySelectorAll('#priorities .priority-item')].map(el => ({
    text: el.querySelector('label').textContent,
    done: el.querySelector('input').checked,
  }));
  localStorage.setItem('mc_priorities', JSON.stringify(items));
}
function loadPriorities() {
  const saved = localStorage.getItem('mc_priorities');
  if (!saved) return;
  try {
    const items     = JSON.parse(saved);
    const container = document.getElementById('priorities');
    container.innerHTML = '';
    items.forEach((item, i) => {
      const id  = 'p' + i;
      const div = document.createElement('div');
      div.className = 'priority-item';
      div.innerHTML = `<input type="checkbox" id="${id}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"><label for="${id}" class="${item.done ? 'done' : ''}">${item.text}</label>`;
      container.appendChild(div);
    });
  } catch(e) {}
}
loadPriorities();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURRENCY FORMATTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtCurrency(n) {
  if (n === null || n === undefined || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1_000_000) {
    return sign + '$' + (abs / 1_000_000).toFixed(2).replace(/\.?0+$/, '') + 'M';
  }
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function fmtCurrencyFull(n) {
  if (n === null || n === undefined || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtDate(str) {
  if (!str) return 'â€”';
  try {
    return new Date(str).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
  } catch { return str; }
}

function progressColor(pct) {
  if (pct >= 90) return 'var(--red)';
  if (pct >= 70) return 'var(--yellow)';
  return 'var(--accent)';
}

function invoiceStatusBadge(status) {
  if (!status) return '<span class="badge badge-muted">Unknown</span>';
  const s = status.toLowerCase();
  if (s.includes('paid'))    return '<span class="badge badge-green">Paid</span>';
  if (s.includes('partial')) return '<span class="badge badge-blue">Partial</span>';
  if (s.includes('draft'))   return '<span class="badge badge-orange">Draft</span>';
  if (s.includes('void'))    return '<span class="badge badge-muted">Void</span>';
  return `<span class="badge badge-yellow">${status}</span>`;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderJobs(data) {
  const container = document.getElementById('jobs-list');
  const jobs = data.jobs || [];

  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No active jobs found.</div>';
    return;
  }

  container.innerHTML = jobs.map(job => {
    const contractValue = Number(job.contractValue) || 0;
    const billed        = Number(job.billed)        || 0;
    const owed          = Number(job.owed)           || 0;
    const pct           = contractValue > 0 ? Math.min(100, Math.round((billed / contractValue) * 100)) : 0;
    const color         = progressColor(pct);
    const customer      = job.customer || 'â€”';
    const jobNum        = job.number   ? `Job #${job.number}` : (job.id || '');

    return `
      <div class="job-card">
        <div class="job-header">
          <div>
            <div class="job-name">${escHtml(job.name || 'Untitled Job')}</div>
            <div class="job-number">${escHtml(jobNum)} Â· ${escHtml(customer)}</div>
          </div>
          <span class="badge badge-green">Active</span>
        </div>
        <div class="job-budget-row"><span>Contract Value</span><strong>${fmtCurrency(contractValue)}</strong></div>
        <div class="job-budget-row"><span>Billed So Far</span><strong>${fmtCurrency(billed)}</strong></div>
        <div class="job-budget-row"><span>Outstanding</span><strong style="color:${owed > 0 ? 'var(--yellow)' : 'var(--muted)'}">${fmtCurrency(owed)}</strong></div>
        <div class="progress-bar" style="margin-top:0.6rem">
          <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.4rem">${pct}% billed of contract</div>
      </div>`;
  }).join('');
}

function renderInbox(data) {
  const transactions = data.transactions || [];
  const count        = data.count ?? transactions.length;
  const totalAmt     = data.totalAmount;

  // Update header badge
  document.getElementById('inbox-badge').textContent =
    count > 0 ? `${count} uncoded` : '0 uncoded';

  const container = document.getElementById('inbox-list');

  if (!transactions.length) {
    container.innerHTML = '<div class="state-loading">No uncoded transactions â€” inbox is clear! âœ…</div>';
    return;
  }

  container.innerHTML = transactions.map(tx => {
    const amount   = Number(tx.amount) || 0;
    const isDebit  = amount < 0;
    const cls      = isDebit ? 'debit' : 'credit';
    const dateStr  = fmtDate(tx.date);
    const account  = tx.account ? ` Â· ${escHtml(tx.account)}` : '';

    return `
      <div class="inbox-item">
        <div class="inbox-left">
          <div class="inbox-vendor">${escHtml(tx.name || 'â€”')}</div>
          <div class="inbox-desc">${dateStr}${account}</div>
        </div>
        <div class="inbox-amount ${cls}">${isDebit ? '-' : '+'}${fmtCurrency(Math.abs(amount))}</div>
      </div>`;
  }).join('');
}

function renderInvoices(data) {
  const invoices = data.invoices || [];
  const tbody    = document.getElementById('invoice-rows');

  if (!invoices.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">No open invoices.</td></tr>';
    return;
  }

  tbody.innerHTML = invoices.map(inv => {
    const jobName = inv.jobName || 'â€”';
    const invName = inv.name   || (inv.number ? `Invoice #${inv.number}` : 'â€”');
    const total   = fmtCurrency(Number(inv.total) || 0);
    const date    = fmtDate(inv.date);
    const badge   = invoiceStatusBadge(inv.status);
    return `<tr>
      <td>${escHtml(jobName)}</td>
      <td>${escHtml(invName)}</td>
      <td style="color:var(--muted);font-size:0.78rem">${date}</td>
      <td>${total}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE DATA LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  const token = getToken();

  const headers = token
    ? { 'Authorization': `Bearer ${token}` }
    : {};

  let jobsData, inboxData, invoicesData;

  try {
    [jobsData, inboxData, invoicesData] = await Promise.all([
      fetch('/api/jobs',     { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/inbox',    { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/invoices', { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
    ]);
  } catch (e) {
    console.error('loadData failed:', e);
  }

  // â”€â”€ JOBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (jobsData) {
    const count = jobsData.total ?? (jobsData.jobs || []).length;
    const val   = Number(jobsData.totalValue) || 0;

    document.getElementById('metric-jobs-count').textContent = count !== null ? count : 'â€”';
    document.getElementById('metric-jobs-value').textContent =
      val > 0 ? `${fmtCurrency(val)} total value` : 'no value data';

    // Revenue tab pipeline
    const revPipeline = document.getElementById('rev-pipeline');
    if (revPipeline) revPipeline.textContent = val > 0 ? fmtCurrency(val) : 'â€”';
    const revPipelineSub = document.getElementById('rev-pipeline-sub');
    if (revPipelineSub) revPipelineSub.textContent = `${count} active job${count !== 1 ? 's' : ''}`;

    renderJobs(jobsData);
  } else {
    document.getElementById('metric-jobs-count').textContent = 'â€”';
    document.getElementById('metric-jobs-value').textContent = 'failed to load';
    document.getElementById('jobs-list').innerHTML =
      '<div class="state-error">Could not load jobs â€” API unavailable.</div>';
  }

  // â”€â”€ INBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (inboxData) {
    const count = inboxData.count ?? (inboxData.transactions || []).length;
    document.getElementById('metric-inbox-count').textContent = count;
    renderInbox(inboxData);
  } else {
    document.getElementById('metric-inbox-count').textContent = 'â€”';
    document.getElementById('inbox-list').innerHTML =
      '<div class="state-error">Could not load inbox â€” API unavailable.</div>';
    document.getElementById('inbox-badge').textContent = 'error';
  }

  // â”€â”€ INVOICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (invoicesData) {
    const owed  = Number(invoicesData.totalOwed) || 0;
    const count = invoicesData.count ?? (invoicesData.invoices || []).length;

    document.getElementById('metric-invoices-owed').textContent = fmtCurrency(owed);
    document.getElementById('metric-invoices-sub').textContent =
      `${count} invoice${count !== 1 ? 's' : ''} outstanding`;

    // Revenue tab open invoices
    const revOwed = document.getElementById('rev-open-invoices');
    if (revOwed) revOwed.textContent = fmtCurrency(owed);
    const revInvSub = document.getElementById('rev-invoices-sub');
    if (revInvSub) revInvSub.textContent = `${count} invoice${count !== 1 ? 's' : ''} pending`;

    renderInvoices(invoicesData);
  } else {
    document.getElementById('metric-invoices-owed').textContent = 'â€”';
    document.getElementById('metric-invoices-sub').textContent = 'failed to load';
    document.getElementById('invoice-rows').innerHTML =
      '<tr><td colspan="5" style="text-align:center;color:var(--red);padding:1.5rem">Could not load invoices â€” API unavailable.</td></tr>';
  }

  // â”€â”€ LAST UPDATED TIMESTAMP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ts = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
  const lastUpdatedEl = document.getElementById('last-updated');
  if (lastUpdatedEl) {
    lastUpdatedEl.textContent = `Last updated: ${ts}`;
  }
}

// Auto-refresh every 5 minutes
setInterval(loadData, 5 * 60 * 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AGENTS â€” Live Status + Model Switcher
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LOCAL_API = 'http://127.0.0.1:18900';
const MODELS = [
  { id: 'anthropic/claude-sonnet-4-6',  label: 'Claude Sonnet 4.6 (default)' },
  { id: 'anthropic/claude-opus-4-5',    label: 'Claude Opus 4.5' },
  { id: 'anthropic/claude-haiku-4-5',   label: 'Claude Haiku 4.5' },
  { id: 'openai/gpt-4o',                label: 'GPT-4o' },
  { id: 'openai/gpt-4o-mini',           label: 'GPT-4o Mini' },
  { id: 'openai/o3-mini',               label: 'o3-mini' },
];

let agentsData = null;          // last fetched payload
let agentModelDraft = {};       // { agentId: selectedModel } â€” unsaved changes
let localAvailable = false;

function fmtAgo(seconds) {
  if (!seconds) return 'never';
  if (seconds < 60) return `${seconds}s ago`;
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function statusMeta(agent) {
  if (!agent.gatewayUp) return { dot: 'dot-gray',   label: 'Offline',  color: 'var(--muted)' };
  if (agent.status === 'active')  return { dot: 'dot-green',  label: 'Active',   color: 'var(--green)' };
  if (agent.status === 'recent')  return { dot: 'dot-yellow', label: 'Idle',     color: 'var(--yellow)' };
  return { dot: 'dot-gray',   label: 'Idle',     color: 'var(--muted)' };
}

function renderAgentCard(agent) {
  const sm = statusMeta(agent);
  const draft = agentModelDraft[agent.id] ?? agent.model;
  const isDirty = draft !== agent.model;
  const channelStr = agent.channel ? ` Â· ${agent.channel}` : '';

  const modelOptions = MODELS.map(m =>
    `<option value="${m.id}" ${draft === m.id ? 'selected' : ''}>${m.label}</option>`
  ).join('');

  const caps = (agent.capabilities || [])
    .map(c => `<span class="badge badge-muted">${c}</span>`)
    .join('');

  return `
  <div class="agent-card ${agent.status === 'active' ? 'agent-active' : ''}" id="card-${agent.id}">
    <div class="agent-header">
      <div class="agent-emoji">${agent.emoji}</div>
      <div>
        <div class="agent-name">${agent.name}</div>
        <div class="agent-role">${agent.role}</div>
      </div>
    </div>
    <div class="agent-status-row">
      <div class="dot ${sm.dot}"></div>
      <span style="color:${sm.color}">${sm.label}</span>
      <span style="color:var(--muted)">${channelStr}</span>
    </div>
    <div class="agent-last-active">Last active: ${fmtAgo(agent.lastActiveAgo)}</div>
    <div class="agent-caps">${caps}</div>
    <div class="agent-model-row">
      <span class="agent-model-label">Model</span>
      <select class="model-select" id="model-select-${agent.id}"
        onchange="onModelChange('${agent.id}', this.value)">
        ${modelOptions}
      </select>
      <button class="model-save-btn" id="model-save-${agent.id}"
        onclick="saveModel('${agent.id}')"
        ${isDirty ? '' : 'disabled'}>
        Save
      </button>
    </div>
  </div>`;
}

function renderAgents(data) {
  const grid = document.getElementById('agent-grid');
  if (!grid) return;
  grid.innerHTML = data.agents.map(renderAgentCard).join('');

  // System status table
  const tbody = document.getElementById('system-status-body');
  if (tbody) {
    const gw = data.gatewayStatus === 'running';
    tbody.innerHTML = `
      <tr><td>Gateway</td>
          <td><span class="badge ${gw ? 'badge-green' : 'badge-red'}">${gw ? 'Running' : 'Stopped'}</span></td>
          <td style="color:var(--muted);font-size:0.78rem">ws://127.0.0.1:18789 Â· Telegram connected</td></tr>
      <tr><td>Memory</td>
          <td><span class="badge badge-green">Active</span></td>
          <td style="color:var(--muted);font-size:0.78rem">memory-lancedb Â· text-embedding-3-small</td></tr>
      <tr><td>JT API</td>
          <td><span class="badge badge-green">Working</span></td>
          <td style="color:var(--muted);font-size:0.78rem">Pave Â· grant key valid Â· Org 22NeVb7CK2sW</td></tr>
      <tr><td>Google Workspace</td>
          <td><span class="badge badge-green">Connected</span></td>
          <td style="color:var(--muted);font-size:0.78rem">assistant@codydesignbuild.com</td></tr>
      <tr><td>Local Status API</td>
          <td><span class="badge badge-green">Online</span></td>
          <td style="color:var(--muted);font-size:0.78rem">127.0.0.1:18900 Â· live data</td></tr>`;
  }
}

function renderAgentsFallback() {
  const grid = document.getElementById('agent-grid');
  if (grid) {
    grid.innerHTML = `<div style="color:var(--muted);font-size:0.82rem;padding:1.5rem;grid-column:1/-1;text-align:center">
      âš ï¸ Local status server unreachable (port 18900).<br>
      Live status only available when on the Mac mini or local network.
    </div>`;
  }
}

function setLiveBadge(live) {
  const badge = document.getElementById('agents-live-badge');
  if (!badge) return;
  badge.innerHTML = live
    ? `<div class="dot dot-green"></div><span style="color:var(--green)">Live</span>`
    : `<div class="dot dot-gray"></div><span>Offline â€” remote view</span>`;
}

async function fetchAgents() {
  try {
    const res = await fetch(`${LOCAL_API}/api/agents`, { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    agentsData = data;
    localAvailable = true;
    setLiveBadge(true);
    renderAgents(data);
  } catch {
    localAvailable = false;
    setLiveBadge(false);
    if (!agentsData) renderAgentsFallback();
  }
}

function onModelChange(agentId, value) {
  agentModelDraft[agentId] = value;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) btn.disabled = (value === (agentsData?.agents?.find(a => a.id === agentId)?.model));
}

async function saveModel(agentId) {
  const model = agentModelDraft[agentId];
  if (!model) return;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
  try {
    const res = await fetch(`${LOCAL_API}/api/agents/${agentId}/model`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model }),
      signal: AbortSignal.timeout(5000),
    });
    const data = await res.json();
    if (data.ok) {
      delete agentModelDraft[agentId];
      if (btn) { btn.textContent = 'âœ“ Saved'; setTimeout(() => { if (btn) { btn.textContent = 'Save'; } }, 2000); }
      // Refresh agents after a tick
      setTimeout(fetchAgents, 300);
    } else {
      if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
    }
  } catch {
    if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
  }
}

// Initial load + poll every 10 seconds
fetchAgents();
setInterval(fetchAgents, 10 * 1000);
</script>
</body>
</html>
