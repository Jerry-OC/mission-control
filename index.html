<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš€</text></svg>" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050508;
    --bg2: #0d0d14;
    --card: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.07);
    --accent: #f97316;
    --accent2: #fb923c;
    --text: #e8e8f0;
    --muted: #6b7280;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html { font-size:17px; }
  body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; }

  /* â”€â”€â”€ AUTH GATE â”€â”€â”€ */
  #auth-overlay {
    position:fixed; inset:0; z-index:9999;
    background:var(--bg);
    display:flex; align-items:center; justify-content:center;
    animation:fadeIn 0.3s ease;
  }
  #auth-overlay.hidden { display:none; }

  .auth-box {
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:20px;
    padding:3rem 2.5rem;
    width:100%;
    max-width:400px;
    backdrop-filter:blur(24px);
    box-shadow:0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .auth-box::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--accent), var(--accent2), var(--purple));
  }
  .auth-logo {
    font-size:1.1rem; font-weight:700; color:var(--accent);
    letter-spacing:-0.02em; margin-bottom:0.25rem;
  }
  .auth-logo span { color:var(--text); font-weight:400; }
  .auth-title {
    font-size:1.5rem; font-weight:700; letter-spacing:-0.03em;
    margin:1.25rem 0 0.4rem;
  }
  .auth-subtitle { font-size:0.82rem; color:var(--muted); margin-bottom:2rem; }

  .auth-field {
    position:relative; margin-bottom:1rem;
  }
  .auth-field input {
    width:100%;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:10px;
    padding:0.8rem 1rem;
    font-size:1rem;
    font-family:'Inter',sans-serif;
    color:var(--text);
    outline:none;
    transition:border-color 0.2s, box-shadow 0.2s;
    letter-spacing:0.1em;
    text-align:center;
  }
  .auth-field input::placeholder { letter-spacing:normal; color:var(--muted); }
  .auth-field input:focus {
    border-color:rgba(249,115,22,0.5);
    box-shadow:0 0 0 3px rgba(249,115,22,0.1);
  }
  .auth-field label {
    display:block; font-size:0.72rem; font-weight:600;
    text-transform:uppercase; letter-spacing:0.08em;
    color:var(--muted); margin-bottom:0.5rem; text-align:left;
  }

  .auth-btn {
    width:100%; padding:0.85rem;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    border:none; border-radius:10px;
    font-size:0.9rem; font-weight:600;
    font-family:'Inter',sans-serif;
    color:#fff; cursor:pointer;
    transition:opacity 0.15s, transform 0.1s;
    letter-spacing:0.01em;
  }
  .auth-btn:hover { opacity:0.9; transform:translateY(-1px); }
  .auth-btn:active { transform:translateY(0); }
  .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

  .auth-error {
    margin-top:0.75rem; padding:0.6rem 1rem;
    background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2);
    border-radius:8px; font-size:0.8rem; color:var(--red);
    display:none;
  }
  .auth-error.show { display:block; }

  .auth-spinner {
    display:inline-block; width:14px; height:14px;
    border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin 0.6s linear infinite;
    vertical-align:middle; margin-right:0.4rem;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  .auth-footer {
    margin-top:1.5rem; font-size:0.72rem; color:var(--muted);
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  header {
    position:sticky; top:0; z-index:100;
    background:rgba(5,5,8,0.85);
    backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
    padding:0 2rem;
    display:flex; align-items:center; justify-content:space-between;
    height:60px;
  }
  .logo { font-size:1rem; font-weight:700; color:var(--accent); letter-spacing:-0.02em; }
  .logo span { color:var(--text); font-weight:400; }
  nav { display:flex; gap:0.25rem; }
  nav button {
    background:none; border:none; color:var(--muted);
    padding:0.4rem 0.9rem; border-radius:6px;
    font-size:0.85rem; font-family:'Inter',sans-serif;
    cursor:pointer; transition:all 0.15s;
  }
  nav button:hover { color:var(--text); background:var(--card); }
  nav button.active { color:var(--accent); background:rgba(249,115,22,0.1); }
  .header-right { display:flex; align-items:center; gap:1rem; }
  #clock { font-size:0.8rem; color:var(--muted); font-variant-numeric:tabular-nums; }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  #signout-btn {
    font-size:0.75rem; color:var(--muted); cursor:pointer;
    background:none; border:none; font-family:'Inter',sans-serif;
    padding:0.25rem 0.5rem; border-radius:4px;
    transition:color 0.15s, background 0.15s;
  }
  #signout-btn:hover { color:var(--red); background:rgba(239,68,68,0.08); }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  main { max-width:1400px; margin:0 auto; padding:2rem; }

  /* â”€â”€â”€ TAB PANELS â”€â”€â”€ */
  .tab-panel { display:none; animation:fadeIn 0.2s ease; }
  .tab-panel.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* â”€â”€â”€ CARDS â”€â”€â”€ */
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:1.25rem;
    backdrop-filter:blur(10px);
  }
  .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
  .card-title { font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); }

  /* â”€â”€â”€ METRICS GRID â”€â”€â”€ */
  .metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:1.5rem; }
  .metric-card {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; padding:1.25rem; position:relative; overflow:hidden;
  }
  .metric-bar { position:absolute; top:0; left:0; right:0; height:3px; }
  .metric-icon { font-size:1.4rem; margin-bottom:0.5rem; }
  .metric-label { font-size:0.75rem; color:var(--muted); margin-bottom:0.25rem; }
  .metric-value { font-size:1.8rem; font-weight:700; letter-spacing:-0.02em; }
  .metric-sub { font-size:0.75rem; color:var(--muted); margin-top:0.25rem; }
  .trend-up { color:var(--green); }
  .trend-dn { color:var(--red); }

  /* â”€â”€â”€ GRIDS â”€â”€â”€ */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1rem; }

  /* â”€â”€â”€ TABLES â”€â”€â”€ */
  table { width:100%; border-collapse:collapse; }
  th { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); padding:0.5rem 0.75rem; text-align:left; border-bottom:1px solid var(--border); }
  td { padding:0.65rem 0.75rem; font-size:0.85rem; border-bottom:1px solid rgba(255,255,255,0.03); }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:rgba(255,255,255,0.02); }

  /* â”€â”€â”€ BADGES â”€â”€â”€ */
  .badge { display:inline-flex; align-items:center; gap:0.3rem; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.72rem; font-weight:600; }
  .badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
  .badge-yellow { background:rgba(234,179,8,0.15); color:var(--yellow); }
  .badge-red { background:rgba(239,68,68,0.15); color:var(--red); }
  .badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
  .badge-orange { background:rgba(249,115,22,0.15); color:var(--accent); }
  .badge-muted { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* â”€â”€â”€ PROGRESS â”€â”€â”€ */
  .progress-bar { background:rgba(255,255,255,0.06); border-radius:4px; height:6px; overflow:hidden; }
  .progress-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }

  /* â”€â”€â”€ PRIORITIES â”€â”€â”€ */
  .priority-item { display:flex; align-items:center; gap:0.75rem; padding:0.6rem 0; border-bottom:1px solid var(--border); }
  .priority-item:last-child { border-bottom:none; }
  .priority-item input[type=checkbox] { accent-color:var(--accent); width:16px; height:16px; cursor:pointer; }
  .priority-item label { font-size:0.875rem; cursor:pointer; flex:1; }
  .priority-item label.done { text-decoration:line-through; color:var(--muted); }

  /* â”€â”€â”€ AGENT CARDS â”€â”€â”€ */
  .agent-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:1rem; }
  @media(max-width:700px){ .agent-grid { grid-template-columns:1fr; } }
  .agent-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; transition:border-color 0.2s; }
  .agent-card.agent-active { border-color:rgba(34,197,94,0.3); }
  .agent-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:0.75rem; }
  .agent-emoji { font-size:1.8rem; }
  .agent-name { font-weight:600; font-size:1rem; }
  .agent-role { font-size:0.75rem; color:var(--muted); }
  .agent-status-row { display:flex; align-items:center; gap:0.4rem; font-size:0.78rem; margin-bottom:0.5rem; }
  .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .dot-green { background:var(--green); box-shadow:0 0 6px var(--green); animation:pulse-green 2s infinite; }
  .dot-yellow { background:var(--yellow); }
  .dot-gray { background:var(--muted); }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 4px var(--green);} 50%{box-shadow:0 0 10px var(--green);} }
  .agent-last-active { font-size:0.7rem; color:var(--muted); margin-bottom:0.75rem; }
  .agent-caps { display:flex; flex-wrap:wrap; gap:0.35rem; margin-bottom:0.85rem; }
  .agent-model-row { display:flex; align-items:center; gap:0.5rem; margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); }
  .agent-model-label { font-size:0.72rem; color:var(--muted); white-space:nowrap; }
  .model-select { flex:1; background:var(--bg2); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:0.25rem 0.4rem; font-size:0.72rem; font-family:'Inter',sans-serif; cursor:pointer; }
  .model-select:focus { outline:none; border-color:var(--accent); }
  .model-save-btn { font-size:0.7rem; padding:0.25rem 0.6rem; border-radius:6px; border:1px solid var(--accent); background:transparent; color:var(--accent); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .model-save-btn:hover { background:rgba(249,115,22,0.15); }
  .model-save-btn:disabled { opacity:0.4; cursor:default; }
  .agent-offline-note { font-size:0.7rem; color:var(--muted); font-style:italic; margin-top:0.4rem; }
  .agents-live-badge { display:flex; align-items:center; gap:0.4rem; font-size:0.72rem; color:var(--muted); }
  .agents-live-badge .dot { width:5px; height:5px; }

  /* â”€â”€â”€ TRANSACTION CODING UI â”€â”€â”€ */
  .inbox-header { display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:1rem; max-width:680px; }
  .inbox-header h2 { margin:0; flex:1; }
  .inbox-remaining { font-size:0.82rem; color:var(--muted); white-space:nowrap; }
  .inbox-filter-pills { display:flex; gap:0.35rem; flex-wrap:wrap; margin-bottom:1rem; max-width:680px; }

  .tx-list { display:flex; flex-direction:column; gap:0.5rem; max-width:680px; }
  .tx-card {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; overflow:hidden;
    transition:border-color 0.15s, box-shadow 0.2s;
  }
  .tx-card.status-uncoded { border-color:rgba(255,255,255,0.12); }
  .tx-card.status-coded   { border-color:rgba(34,197,94,0.25); background:rgba(34,197,94,0.04); }
  .tx-card.status-review  { border-color:rgba(234,179,8,0.3);  background:rgba(234,179,8,0.04); }
  .tx-card.status-excluded{ border-color:rgba(107,114,128,0.2); opacity:0.55; }
  .tx-card.flash-green { box-shadow:0 0 0 2px var(--green); animation:flashGreen 0.6s ease forwards; }
  .tx-card.flash-yellow { box-shadow:0 0 0 2px var(--yellow); animation:flashYellow 0.6s ease forwards; }
  @keyframes flashGreen  { 0%{box-shadow:0 0 0 3px var(--green)} 100%{box-shadow:0 0 0 0 transparent} }
  @keyframes flashYellow { 0%{box-shadow:0 0 0 3px var(--yellow)} 100%{box-shadow:0 0 0 0 transparent} }

  .tx-card-header {
    display:flex; align-items:center; gap:0.75rem;
    padding:0.85rem 1rem; cursor:pointer;
    user-select:none;
  }
  .tx-card-header:hover { background:rgba(255,255,255,0.02); }
  .tx-merchant { flex:1; min-width:0; }
  .tx-merchant-name { font-size:0.9rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tx-meta { font-size:0.72rem; color:var(--muted); margin-top:0.15rem; }
  .tx-amount { font-size:1.25rem; font-weight:700; color:var(--accent); white-space:nowrap; flex-shrink:0; }
  .tx-amount.negative { color:var(--red); }
  .tx-status-pill { flex-shrink:0; font-size:0.65rem; padding:0.15rem 0.5rem; border-radius:20px; font-weight:600; }
  .tx-status-pill.uncoded  { background:rgba(255,255,255,0.08); color:var(--muted); }
  .tx-status-pill.coded    { background:rgba(34,197,94,0.15);  color:var(--green); }
  .tx-status-pill.review   { background:rgba(234,179,8,0.15);  color:var(--yellow); }
  .tx-status-pill.excluded { background:rgba(107,114,128,0.12);color:var(--muted); }
  .tx-chevron { font-size:0.75rem; color:var(--muted); flex-shrink:0; transition:transform 0.2s; }
  .tx-card.expanded .tx-chevron { transform:rotate(180deg); }

  .tx-coding {
    display:none; padding:0 1rem 1rem;
    border-top:1px solid var(--border);
    background:rgba(255,255,255,0.01);
  }
  .tx-coding.open { display:block; }
  .tx-full-desc { font-size:0.78rem; color:var(--muted); padding:0.65rem 0 0.85rem; line-height:1.4; }
  .tx-coding-row { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; margin-bottom:0.6rem; }
  @media(max-width:520px) { .tx-coding-row { grid-template-columns:1fr; } }
  .tx-coding label { display:block; font-size:0.68rem; color:var(--muted); margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:0.06em; }
  .tx-coding select, .tx-coding input[type=text] {
    width:100%; background:rgba(255,255,255,0.05);
    border:1px solid var(--border); color:var(--text);
    border-radius:8px; padding:0.48rem 0.65rem;
    font-size:0.83rem; font-family:'Inter',sans-serif;
    transition:border-color 0.15s;
  }
  .tx-coding select:focus, .tx-coding input[type=text]:focus {
    outline:none; border-color:var(--accent);
  }
  .tx-coding select { color-scheme:dark; }
  .tx-coding select option { background:#1a1a2e; color:#e2e8f0; }
  .tx-existing { font-size:0.75rem; color:var(--muted); margin-top:0.2rem; display:flex; align-items:center; gap:0.3rem; }
  .tx-existing strong { color:var(--text); }
  .tx-coding-actions { display:flex; gap:0.5rem; margin-top:0.75rem; flex-wrap:wrap; }
  .btn-code { background:var(--accent); color:#fff; border:none; padding:0.5rem 1.2rem; border-radius:8px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:opacity 0.15s; }
  .btn-code:hover { opacity:0.85; }
  .btn-code:disabled { opacity:0.4; cursor:default; }
  .btn-review { background:rgba(234,179,8,0.15); color:var(--yellow); border:1px solid rgba(234,179,8,0.3); padding:0.5rem 1rem; border-radius:8px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .btn-review:hover { background:rgba(234,179,8,0.25); }
  .btn-exclude { background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.3); padding:0.5rem 1rem; border-radius:8px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .btn-exclude:hover { background:rgba(239,68,68,0.25); }
  .tx-rule-prompt { margin-top:0.75rem; padding:0.65rem 0.9rem; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; font-size:0.82rem; color:var(--muted); display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; }
  .tx-rule-prompt strong { color:var(--text); }
  .btn-rule-yes { background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.3); padding:0.3rem 0.75rem; border-radius:6px; font-size:0.78rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; }
  .btn-rule-yes:hover { background:rgba(239,68,68,0.25); }
  .btn-rule-no { background:transparent; color:var(--muted); border:1px solid var(--border); padding:0.3rem 0.75rem; border-radius:6px; font-size:0.78rem; cursor:pointer; font-family:'Inter',sans-serif; }
  .btn-rule-no:hover { color:var(--text); }
  .tx-suggest { font-size:0.72rem; color:var(--accent); margin-top:0.3rem; cursor:pointer; display:none; }
  .tx-suggest:hover { text-decoration:underline; }
  .tx-load-more { text-align:center; margin-top:1rem; max-width:680px; }
  .tx-load-more button { background:transparent; border:1px solid var(--border); color:var(--muted); padding:0.5rem 1.5rem; border-radius:8px; font-family:'Inter',sans-serif; font-size:0.82rem; cursor:pointer; transition:all 0.15s; }
  .tx-load-more button:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }

  /* â”€â”€â”€ SECTION HEADERS â”€â”€â”€ */
  h2 { font-size:1.2rem; font-weight:700; margin-bottom:1rem; letter-spacing:-0.02em; }
  h3 { font-size:0.95rem; font-weight:600; margin-bottom:0.75rem; }

  /* â”€â”€â”€ WELCOME BAR â”€â”€â”€ */
  .welcome { margin-bottom:1.5rem; }
  .welcome h1 { font-size:1.6rem; font-weight:700; letter-spacing:-0.03em; }
  .welcome p { color:var(--muted); font-size:0.875rem; margin-top:0.25rem; }

  /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
  .divider { border:none; border-top:1px solid var(--border); margin:1rem 0; }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
  .btn { background:var(--accent); color:#fff; border:none; padding:0.5rem 1rem; border-radius:8px; font-size:0.8rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:opacity 0.15s; }
  .btn:hover { opacity:0.85; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-ghost:hover { background:var(--card); }

  /* â”€â”€â”€ JOB CARD â”€â”€â”€ */
  .job-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; margin-bottom:0.75rem; transition:border-color 0.2s; }
  .job-card:hover { border-color:rgba(255,255,255,0.12); }
  .job-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
  .job-name { font-weight:600; font-size:0.95rem; }
  .job-number { font-size:0.75rem; color:var(--muted); margin-top:0.15rem; }
  .job-budget-row { display:flex; justify-content:space-between; font-size:0.78rem; margin-bottom:0.4rem; }
  .job-budget-row span { color:var(--muted); }
  .job-budget-row strong { color:var(--text); }

  /* â”€â”€â”€ LAST UPDATED â”€â”€â”€ */
  #last-updated {
    font-size:0.72rem; color:var(--muted);
    text-align:right; margin-bottom:0.75rem;
    transition:opacity 0.3s;
  }

  /* â”€â”€â”€ LOADING / ERROR STATES â”€â”€â”€ */
  .state-loading { text-align:center; padding:2rem; color:var(--muted); font-size:0.85rem; }
  .state-error { text-align:center; padding:1.5rem; color:var(--red); font-size:0.82rem; background:rgba(239,68,68,0.06); border-radius:8px; border:1px solid rgba(239,68,68,0.15); }

  /* â”€â”€â”€ TASKS â”€â”€â”€ */
  .tasks-header { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem; }
  .tasks-header h2 { margin:0; flex:1; }
  .view-toggle { display:flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .view-btn { padding:0.3rem 0.75rem; background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:0.78rem; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .view-btn.active { background:var(--accent); color:#fff; }

  /* Project switcher */
  .project-switcher { display:flex; gap:0; align-items:center; overflow-x:auto; padding-bottom:0.6rem; margin-bottom:1rem; scrollbar-width:none; }
  .project-switcher::-webkit-scrollbar { display:none; }
  .proj-sep { width:1px; background:var(--border); height:20px; margin:0 0.5rem; flex-shrink:0; }
  .proj-pill { display:flex; align-items:center; gap:0.3rem; padding:0.28rem 0.65rem; border-radius:20px; font-size:0.75rem; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; flex-shrink:0; }
  .proj-pill:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }
  .proj-pill.active { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }
  .proj-pill.group { font-weight:600; }
  .proj-add { font-size:0.75rem; padding:0.28rem 0.65rem; border-radius:20px; border:1px dashed rgba(255,255,255,0.15); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; white-space:nowrap; flex-shrink:0; transition:all 0.15s; }
  .proj-add:hover { border-color:var(--accent); color:var(--accent); }

  /* Kanban */
  .kanban-board { display:grid; grid-template-columns:repeat(4,1fr); gap:0.85rem; align-items:start; }
  @media(max-width:900px){ .kanban-board { grid-template-columns:repeat(2,1fr); } }
  @media(max-width:500px){ .kanban-board { grid-template-columns:1fr; } }
  .kanban-col { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:0.85rem; min-height:180px; }
  .kanban-col-header { font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.75rem; display:flex; align-items:center; gap:0.5rem; }
  .kanban-count { font-size:0.68rem; padding:0.1rem 0.45rem; border-radius:20px; font-weight:500; }
  .task-card { background:var(--card); border:1px solid var(--border); border-radius:9px; padding:0.75rem; margin-bottom:0.55rem; cursor:grab; transition:border-color 0.15s,transform 0.12s,opacity 0.15s; }
  .task-card:hover { border-color:rgba(255,255,255,0.14); transform:translateY(-1px); }
  .task-card.dragging { opacity:0.35; cursor:grabbing; transform:scale(0.97); }
  .task-card-name { font-size:0.82rem; font-weight:500; margin-bottom:0.4rem; line-height:1.35; cursor:pointer; }
  .task-card-meta { display:flex; flex-wrap:wrap; gap:0.3rem; align-items:center; }
  .task-card-tag { font-size:0.68rem; color:var(--muted); }
  .task-card-actions { display:flex; gap:0.3rem; margin-top:0.5rem; padding-top:0.45rem; border-top:1px solid var(--border); }
  .status-btn { font-size:0.65rem; padding:0.15rem 0.45rem; border-radius:20px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .status-btn:hover { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }
  .kanban-col.drag-over,.mini-col.drag-over { border-color:var(--accent); background:rgba(249,115,22,0.06); border-radius:7px; }

  /* Multi-board (Jobs group view) */
  .multi-board { display:flex; flex-direction:column; gap:1.5rem; }
  .mini-board { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
  .mini-board-header { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02); }
  .mini-board-title { font-size:0.88rem; font-weight:600; display:flex; align-items:center; gap:0.5rem; }
  .mini-board-add { font-size:0.72rem; color:var(--muted); cursor:pointer; border:1px solid var(--border); border-radius:6px; padding:0.2rem 0.5rem; background:transparent; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .mini-board-add:hover { border-color:var(--accent); color:var(--accent); }
  .mini-kanban { display:grid; grid-template-columns:repeat(4,1fr); gap:0.6rem; padding:0.75rem; }
  @media(max-width:800px){ .mini-kanban { grid-template-columns:repeat(2,1fr); } }
  .mini-col { min-height:80px; }
  .mini-col-header { font-size:0.65rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.3rem; }
  .mini-card { background:var(--card); border:1px solid var(--border); border-radius:7px; padding:0.5rem 0.6rem; margin-bottom:0.4rem; font-size:0.75rem; cursor:pointer; transition:border-color 0.12s; line-height:1.3; }
  .mini-card:hover { border-color:rgba(255,255,255,0.14); }
  .mini-card-meta { display:flex; gap:0.25rem; margin-top:0.3rem; flex-wrap:wrap; }
  .mini-empty { font-size:0.68rem; color:rgba(107,114,128,0.5); padding:0.25rem 0; }

  /* List view */
  .tasks-list-group { margin-bottom:1.5rem; }
  .tasks-list-group-header { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); margin-bottom:0.5rem; padding-bottom:0.35rem; border-bottom:1px solid var(--border); }
  .task-row { display:flex; align-items:center; gap:0.6rem; padding:0.6rem 0.5rem; border-radius:7px; cursor:pointer; transition:background 0.12s; }
  .task-row:hover { background:rgba(255,255,255,0.04); }
  .task-row-check { width:16px; height:16px; border-radius:50%; border:1.5px solid var(--border); flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.15s; cursor:pointer; font-size:0.65rem; }
  .task-row-check.done { background:var(--green); border-color:var(--green); }
  .task-row-name { flex:1; font-size:0.83rem; }
  .task-row-name.done-text { text-decoration:line-through; color:var(--muted); }
  .task-row-right { display:flex; align-items:center; gap:0.4rem; }

  /* Priority badges */
  .pri-urgent { background:rgba(239,68,68,0.15);  color:#f87171; border:1px solid rgba(239,68,68,0.25); }
  .pri-high   { background:rgba(234,179,8,0.15);  color:#fbbf24; border:1px solid rgba(234,179,8,0.25); }
  .pri-medium { background:rgba(59,130,246,0.15); color:#60a5fa; border:1px solid rgba(59,130,246,0.25); }
  .pri-low    { background:rgba(107,114,128,0.12);color:var(--muted); border:1px solid var(--border); }
  .pri-badge  { font-size:0.63rem; padding:0.1rem 0.42rem; border-radius:20px; font-weight:500; white-space:nowrap; }

  /* Overdue tasks */
  .task-card.task-overdue { border-color:rgba(239,68,68,0.4); }
  .task-card.task-overdue:hover { border-color:rgba(239,68,68,0.6); }
  .mini-card.task-overdue { border-color:rgba(239,68,68,0.4); }
  .due-overdue { color:var(--red) !important; }
  .overdue-pip { display:inline-block; width:6px; height:6px; border-radius:50%; background:var(--red); margin-right:3px; vertical-align:middle; }

  /* Kanban column accent colors */
  .col-todo .kanban-col-header,.mini-col.col-todo .mini-col-header { color:#60a5fa; }
  .col-todo .kanban-count { background:rgba(59,130,246,0.15); color:#60a5fa; }
  .col-progress .kanban-col-header,.mini-col.col-progress .mini-col-header { color:#fbbf24; }
  .col-progress .kanban-count { background:rgba(234,179,8,0.15); color:#fbbf24; }
  .col-blocked .kanban-col-header,.mini-col.col-blocked .mini-col-header { color:#f87171; }
  .col-blocked .kanban-count { background:rgba(239,68,68,0.15); color:#f87171; }
  .col-done .kanban-col-header,.mini-col.col-done .mini-col-header { color:var(--muted); }
  .col-done .kanban-count { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* Modal */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:500; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.15s ease; }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:var(--bg2); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:1.75rem; width:100%; max-width:480px; max-height:90vh; overflow-y:auto; }
  .modal-title { font-size:1rem; font-weight:600; margin-bottom:1.25rem; }
  .form-row { margin-bottom:0.85rem; }
  .form-label { font-size:0.72rem; color:var(--muted); margin-bottom:0.3rem; display:block; }
  .form-input { width:100%; background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.5rem 0.65rem; font-size:0.83rem; font-family:'Inter',sans-serif; transition:border-color 0.15s; }
  .form-input:focus { outline:none; border-color:var(--accent); }
  select.form-input { color-scheme:dark; }
  select.form-input option { background:#1a1a2e; color:#e2e8f0; }
  .form-row-2col { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; }
  .modal-footer { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1.25rem; }
  .btn-cancel { padding:0.45rem 1rem; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; font-size:0.82rem; }
  .btn-cancel:hover { background:rgba(255,255,255,0.04); }
  .inline-add { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; border:1px dashed rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; color:var(--muted); font-size:0.78rem; transition:all 0.15s; margin-top:0.4rem; }
  .inline-add:hover { border-color:var(--accent); color:var(--accent); }
  /* â”€â”€â”€ CONTACTS â”€â”€â”€ */
  .contacts-header { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem; max-width:680px; }
  .contacts-header h2 { margin:0; flex:1; }
  .contacts-search-wrap { position:relative; flex:1; min-width:180px; max-width:320px; }
  .contacts-search { width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.45rem 0.65rem 0.45rem 2rem; font-size:0.83rem; font-family:'Inter',sans-serif; }
  .contacts-search:focus { outline:none; border-color:var(--accent); }
  .contacts-search-icon { position:absolute; left:0.6rem; top:50%; transform:translateY(-50%); color:var(--muted); font-size:0.8rem; pointer-events:none; }
  .contacts-type-pills { display:flex; gap:0.35rem; flex-wrap:wrap; margin-bottom:1rem; max-width:680px; }
  .pill { display:inline-flex; align-items:center; padding:0.28rem 0.75rem; border-radius:20px; font-size:0.75rem; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .pill:hover { border-color:rgba(255,255,255,0.25); color:var(--text); }
  .pill.active            { border-color:var(--accent);           color:var(--accent);  background:rgba(249,115,22,0.12); }
  .pill-client.active     { border-color:#34d399; color:#34d399;  background:rgba(52,211,153,0.1); }
  .pill-sub.active        { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.12); }
  .pill-vendor.active     { border-color:#60a5fa; color:#60a5fa;  background:rgba(96,165,250,0.1); }
  .pill-personal.active   { border-color:#c084fc; color:#c084fc;  background:rgba(192,132,252,0.1); }
  .pill-professional.active{ border-color:#fbbf24; color:#fbbf24; background:rgba(251,191,36,0.1); }
  .contacts-list { display:flex; flex-direction:column; gap:0.55rem; max-width:680px; }
  .contact-card { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:border-color 0.15s; }
  .contact-card:hover { border-color:rgba(255,255,255,0.12); }
  .contact-card-header { display:flex; align-items:center; gap:0.75rem; padding:0.85rem 1rem; cursor:pointer; }
  .contact-avatar { width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,var(--accent),#c2410c); display:flex; align-items:center; justify-content:center; font-size:0.9rem; font-weight:600; flex-shrink:0; color:#fff; }
  .contact-card-name { font-size:0.88rem; font-weight:600; }
  .contact-card-sub { font-size:0.72rem; color:var(--muted); margin-top:0.1rem; }
  .contact-card-badges { display:flex; gap:0.25rem; flex-wrap:wrap; margin-top:0.3rem; }
  .contact-badge { font-size:0.6rem; padding:0.08rem 0.4rem; border-radius:20px; border:1px solid var(--border); color:var(--muted); white-space:nowrap; }
  .contact-badge.type-client       { border-color:rgba(16,185,129,0.4); color:#34d399; }
  .contact-badge.type-subcontractor{ border-color:rgba(249,115,22,0.4); color:#fb923c; }
  .contact-badge.type-vendor        { border-color:rgba(59,130,246,0.4); color:#60a5fa; }
  .contact-badge.type-personal      { border-color:rgba(168,85,247,0.4); color:#c084fc; }
  .contact-badge.type-professional  { border-color:rgba(234,179,8,0.4);  color:#fbbf24; }
  .contact-expand { display:none; padding:0 1rem 1rem; border-top:1px solid var(--border); }
  .contact-expand.open { display:block; }
  .contact-field { display:flex; align-items:center; gap:0; padding:0.35rem 0; border-bottom:1px solid rgba(255,255,255,0.04); }
  .contact-field:last-child { border-bottom:none; }
  .contact-field-label { font-size:0.65rem; color:var(--muted); width:72px; flex-shrink:0; text-transform:uppercase; letter-spacing:0.04em; }
  .contact-field-value { font-size:0.82rem; display:inline-flex; align-items:center; gap:0.4rem; flex-wrap:wrap; }
  .contact-field-value a { color:var(--text); text-decoration:none; }
  .contact-field-value a:hover { color:var(--accent); }
  .copy-btn { font-size:0.68rem; font-weight:600; letter-spacing:0.05em; padding:0.18rem 0.55rem; border-radius:5px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; transition:all 0.15s; flex-shrink:0; font-family:'Inter',sans-serif; }
  .copy-btn:hover { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.08); }
  #copy-toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(10px); background:#1e1e2e; color:#e8e8f0; border:1px solid rgba(255,255,255,0.15); border-radius:10px; padding:0.6rem 1.4rem; font-size:0.9rem; font-weight:600; font-family:'Inter',sans-serif; pointer-events:none; opacity:0; transition:opacity 0.15s ease, transform 0.15s ease; z-index:9999; box-shadow:0 4px 24px rgba(0,0,0,0.5); }
  #copy-toast.show { opacity:1; transform:translateX(-50%) translateY(0); animation:toastOut 1.6s ease forwards; }
  @keyframes toastOut { 0%{opacity:1;transform:translateX(-50%) translateY(0)} 70%{opacity:1;transform:translateX(-50%) translateY(0)} 100%{opacity:0;transform:translateX(-50%) translateY(8px)} }
  .contact-expand-actions { display:flex; gap:0.5rem; margin-top:0.85rem; }
  .contact-empty { text-align:center; color:var(--muted); padding:3rem 1rem; font-size:0.85rem; }
  .contacts-count { font-size:0.72rem; color:var(--muted); margin-bottom:0.75rem; }

  /* â”€â”€â”€ SPLIT BUTTON â”€â”€â”€ */
  .btn-split { background:rgba(139,92,246,0.15); color:#a78bfa; border:1px solid rgba(139,92,246,0.3); padding:0.5rem 1rem; border-radius:8px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .btn-split:hover { background:rgba(139,92,246,0.25); }

  /* â”€â”€â”€ SPLIT MODAL â”€â”€â”€ */
  .split-row { display:grid; grid-template-columns:1fr 1fr 7rem 1.75rem; gap:0.5rem; align-items:end; margin-bottom:0.7rem; }
  @media(max-width:520px) { .split-row { grid-template-columns:1fr 1fr; gap:0.4rem; } }
  .split-row-label { font-size:0.68rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.25rem; }
  .split-row select { width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.48rem 0.65rem; font-size:0.83rem; font-family:'Inter',sans-serif; color-scheme:dark; transition:border-color 0.15s; box-sizing:border-box; }
  .split-row select:focus { outline:none; border-color:var(--accent); }
  .split-row select option { background:#1a1a2e; color:#e2e8f0; }
  .split-amount { width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.48rem 0.65rem; font-size:0.83rem; font-family:'Inter',sans-serif; box-sizing:border-box; transition:border-color 0.15s; }
  .split-amount:focus { outline:none; border-color:var(--accent); }
  .btn-split-remove { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem; padding:0; line-height:1; align-self:center; margin-bottom:0.1rem; }
  .btn-split-remove:hover { color:#f87171; }
  .btn-split-remove:disabled { opacity:0.25; cursor:default; }
  .split-divider { border:none; border-top:1px solid var(--border); margin:0.25rem 0 0.75rem; }
  .split-remaining-bar { display:flex; justify-content:space-between; align-items:center; font-size:0.82rem; padding:0.5rem 0.75rem; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; margin:0.5rem 0; color:var(--muted); transition:border-color 0.2s, color 0.2s; }
  .split-remaining-bar.ok   { border-color:rgba(34,197,94,0.4);  color:var(--green); }
  .split-remaining-bar.over { border-color:rgba(239,68,68,0.4);  color:#f87171; }
  .btn-split-add { background:none; border:none; color:var(--accent); cursor:pointer; font-size:0.8rem; font-family:'Inter',sans-serif; padding:0.2rem 0; display:inline-block; }
  .btn-split-add:hover { text-decoration:underline; }

  /* â”€â”€â”€ ESTIMATING TAB â”€â”€â”€ */
  .est-header { display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:1rem; }
  .est-header h2 { margin:0; flex:1; }
  .est-job-select {
    background:rgba(255,255,255,0.05); border:1px solid var(--border);
    color:var(--text); border-radius:8px; padding:0.45rem 0.75rem;
    font-size:0.83rem; font-family:'Inter',sans-serif;
    color-scheme:dark; min-width:220px; cursor:pointer;
  }
  .est-job-select:focus { outline:none; border-color:var(--accent); }
  .est-job-select option { background:#1a1a2e; color:#e2e8f0; }

  /* Job summary metrics */
  .est-metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:0.75rem; margin-bottom:1.5rem; }
  @media(max-width:700px) { .est-metrics { grid-template-columns:repeat(2,1fr); } }

  /* Orders list */
  .order-list { display:flex; flex-direction:column; gap:0.75rem; }
  .order-card {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; overflow:hidden; transition:border-color 0.2s;
  }
  .order-card.order-signed { border-color:rgba(34,197,94,0.3); }
  .order-card.order-sent   { border-color:rgba(59,130,246,0.3); }

  .order-card-header {
    display:flex; align-items:center; gap:0.75rem;
    padding:0.9rem 1.1rem; cursor:pointer; user-select:none;
  }
  .order-card-header:hover { background:rgba(255,255,255,0.02); }
  .order-card-title { flex:1; min-width:0; }
  .order-card-name { font-size:0.92rem; font-weight:600; }
  .order-card-meta { font-size:0.72rem; color:var(--muted); margin-top:0.1rem; }
  .order-card-totals { display:flex; gap:1.25rem; align-items:center; flex-shrink:0; }
  .order-card-totals span { font-size:0.78rem; color:var(--muted); }
  .order-card-totals strong { color:var(--text); font-weight:600; }
  .order-price-highlight { font-size:1.05rem; font-weight:700; color:var(--accent); }
  .order-chevron { font-size:0.75rem; color:var(--muted); transition:transform 0.2s; flex-shrink:0; }
  .order-card.expanded .order-chevron { transform:rotate(180deg); }
  .order-header-actions { display:flex; gap:0.35rem; flex-shrink:0; }
  .btn-icon {
    background:none; border:1px solid var(--border); border-radius:6px;
    padding:0.22rem 0.55rem; font-size:0.72rem; cursor:pointer;
    font-family:'Inter',sans-serif; color:var(--muted); transition:all 0.15s;
  }
  .btn-icon:hover { border-color:rgba(255,255,255,0.25); color:var(--text); }
  .btn-icon.danger:hover { border-color:rgba(239,68,68,0.4); color:#f87171; }

  /* Line items panel */
  .order-body {
    display:none; border-top:1px solid var(--border);
    background:rgba(255,255,255,0.01);
  }
  .order-body.open { display:block; }
  .order-body-inner { padding:0.85rem 1.1rem 1rem; }

  /* Line item table */
  .li-table { width:100%; border-collapse:collapse; margin-bottom:0.75rem; }
  .li-table th {
    font-size:0.65rem; font-weight:600; text-transform:uppercase;
    letter-spacing:0.07em; color:var(--muted);
    padding:0.35rem 0.5rem; text-align:left;
    border-bottom:1px solid var(--border);
  }
  .li-table th.num { text-align:right; }
  .li-table td { padding:0.5rem 0.5rem; font-size:0.83rem; border-bottom:1px solid rgba(255,255,255,0.03); vertical-align:middle; }
  .li-table tr:last-child td { border-bottom:none; }
  .li-table tr:hover td { background:rgba(255,255,255,0.015); }
  .li-table td.num { text-align:right; font-variant-numeric:tabular-nums; }
  .li-table td.num-muted { text-align:right; color:var(--muted); font-size:0.78rem; }
  .li-name-cell { font-weight:500; }
  .li-desc-cell { font-size:0.75rem; color:var(--muted); line-height:1.3; }
  .li-price-cell { font-weight:600; color:var(--accent); }
  .li-actions { display:flex; gap:0.25rem; justify-content:flex-end; white-space:nowrap; }

  /* Inline edit row */
  .li-table tr.li-editing td { background:rgba(249,115,22,0.04); }
  .li-input {
    width:100%; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.15);
    color:var(--text); border-radius:6px; padding:0.3rem 0.45rem;
    font-size:0.82rem; font-family:'Inter',sans-serif;
    transition:border-color 0.15s; box-sizing:border-box;
  }
  .li-input:focus { outline:none; border-color:var(--accent); }
  .li-input.num { text-align:right; }
  .li-input-wide { min-width:140px; }
  .li-input-narrow { max-width:70px; }
  .li-save-btn {
    background:var(--accent); color:#fff; border:none; border-radius:6px;
    padding:0.28rem 0.6rem; font-size:0.72rem; font-weight:600;
    cursor:pointer; font-family:'Inter',sans-serif; white-space:nowrap;
  }
  .li-save-btn:disabled { opacity:0.5; cursor:default; }
  .li-cancel-btn {
    background:transparent; color:var(--muted); border:1px solid var(--border);
    border-radius:6px; padding:0.28rem 0.55rem; font-size:0.72rem;
    cursor:pointer; font-family:'Inter',sans-serif;
  }

  /* Add line item row */
  .li-add-row { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
  .btn-add-li {
    display:inline-flex; align-items:center; gap:0.35rem;
    background:none; border:1px dashed rgba(255,255,255,0.12);
    color:var(--muted); border-radius:8px; padding:0.45rem 0.85rem;
    font-size:0.78rem; cursor:pointer; font-family:'Inter',sans-serif;
    transition:all 0.15s;
  }
  .btn-add-li:hover { border-color:var(--accent); color:var(--accent); }

  /* Order totals footer */
  .order-totals-footer {
    display:flex; justify-content:flex-end; gap:2rem;
    padding:0.65rem 0.5rem 0; border-top:1px solid var(--border);
    margin-top:0.25rem; flex-wrap:wrap;
  }
  .order-total-item { font-size:0.8rem; }
  .order-total-item span { color:var(--muted); }
  .order-total-item strong { color:var(--text); font-variant-numeric:tabular-nums; }
  .order-total-item.price strong { color:var(--accent); font-size:0.95rem; }

  /* Outline button variant */
  .btn-outline {
    background:transparent; border:1px solid rgba(255,255,255,0.2);
    color:var(--muted); border-radius:8px; padding:0.45rem 0.9rem;
    font-size:0.82rem; font-weight:600; cursor:pointer;
    font-family:'Inter',sans-serif; transition:all 0.15s;
  }
  .btn-outline:hover { border-color:var(--accent); color:var(--accent); }

  /* Estimating modals (order + job) â€” shared overlay */
  #new-order-modal.hidden, #new-job-modal.hidden { display:none; }
  #new-order-modal, #new-job-modal {
    position:fixed; inset:0; z-index:900;
    background:rgba(0,0,0,0.6); backdrop-filter:blur(6px);
    display:flex; align-items:center; justify-content:center;
    padding:1rem;
  }
  .new-order-box {
    background:#0f0f1a; border:1px solid rgba(255,255,255,0.12);
    border-radius:16px; padding:1.75rem; width:100%; max-width:460px;
    box-shadow:0 32px 80px rgba(0,0,0,0.7);
  }
  .new-order-box h3 { margin:0 0 1.25rem; font-size:1rem; }

  /* Status change dropdown on order header */
  .order-status-select {
    background:none; border:none; font-family:'Inter',sans-serif;
    font-size:0.72rem; cursor:pointer; padding:0; color:inherit;
  }
  .order-status-select:focus { outline:none; }

  /* Empty state */
  .est-empty { text-align:center; padding:3rem 1rem; color:var(--muted); font-size:0.85rem; }
  .est-empty .est-empty-icon { font-size:2.5rem; margin-bottom:0.75rem; }

  /* â”€â”€ Order Groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .order-group {
    border:1px solid rgba(255,255,255,0.07); border-radius:10px;
    margin-bottom:0.85rem; overflow:hidden;
  }
  .order-group-header {
    display:flex; align-items:center; gap:0.5rem;
    padding:0.55rem 0.75rem; background:rgba(255,255,255,0.03);
    border-bottom:1px solid rgba(255,255,255,0.06);
  }
  .group-name {
    flex:1; font-size:0.82rem; font-weight:600; letter-spacing:0.01em;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .group-name-input {
    flex:1; background:rgba(255,255,255,0.07); border:1px solid var(--accent);
    color:var(--text); border-radius:5px; padding:0.2rem 0.4rem;
    font-size:0.82rem; font-weight:600; font-family:'Inter',sans-serif;
    outline:none;
  }
  .group-total {
    font-size:0.78rem; font-weight:700; color:var(--accent);
    font-variant-numeric:tabular-nums; white-space:nowrap; margin-right:0.25rem;
  }
  .group-order-btn {
    background:none; border:1px solid rgba(255,255,255,0.1); border-radius:5px;
    color:var(--muted); cursor:pointer; font-size:0.7rem; padding:0.15rem 0.4rem;
    font-family:'Inter',sans-serif; transition:all 0.12s; line-height:1;
  }
  .group-order-btn:hover { border-color:rgba(255,255,255,0.25); color:var(--text); }
  .group-order-btn:disabled { opacity:0.25; cursor:default; }
  .group-delete-btn {
    background:none; border:1px solid rgba(255,255,255,0.1); border-radius:5px;
    color:var(--muted); cursor:pointer; font-size:0.7rem; padding:0.15rem 0.4rem;
    font-family:'Inter',sans-serif; transition:all 0.12s; line-height:1;
  }
  .group-delete-btn:hover { border-color:rgba(239,68,68,0.4); color:#f87171; }
  .group-rename-btn {
    background:none; border:1px solid rgba(255,255,255,0.1); border-radius:5px;
    color:var(--muted); cursor:pointer; font-size:0.7rem; padding:0.15rem 0.4rem;
    font-family:'Inter',sans-serif; transition:all 0.12s; line-height:1;
  }
  .group-rename-btn:hover { border-color:rgba(255,255,255,0.25); color:var(--text); }
  .group-body { padding:0.5rem 0.75rem 0.6rem; }
  .cost-cat-label {
    font-size:0.62rem; font-weight:600; text-transform:uppercase;
    letter-spacing:0.08em; color:var(--muted); padding:0.4rem 0 0.2rem;
    border-bottom:1px solid rgba(255,255,255,0.04); margin-bottom:0.2rem;
    display:flex; align-items:center; justify-content:space-between;
  }
  .cost-cat-label .cat-subtotal {
    font-variant-numeric:tabular-nums; font-size:0.67rem; color:var(--muted);
  }
  .group-ungrouped-header {
    font-size:0.72rem; color:var(--muted); padding:0.5rem 0 0.3rem;
    font-style:italic;
  }
  .btn-add-group {
    display:inline-flex; align-items:center; gap:0.35rem;
    background:none; border:1px dashed rgba(249,115,22,0.25);
    color:rgba(249,115,22,0.6); border-radius:8px; padding:0.4rem 0.85rem;
    font-size:0.78rem; cursor:pointer; font-family:'Inter',sans-serif;
    transition:all 0.15s; margin-top:0.5rem;
  }
  .btn-add-group:hover { border-color:var(--accent); color:var(--accent); }

  /* Cost code select in line item rows */
  .li-cc-select {
    background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12);
    color:var(--text); border-radius:5px; padding:0.22rem 0.35rem;
    font-size:0.75rem; font-family:'Inter',sans-serif; color-scheme:dark;
    max-width:170px; cursor:pointer;
  }
  .li-cc-select:focus { outline:none; border-color:var(--accent); }
  .li-cc-select option { background:#1a1a2e; }
  .li-cc-badge {
    display:inline-block; font-size:0.65rem; padding:0.1rem 0.35rem;
    background:rgba(255,255,255,0.06); border-radius:4px;
    color:var(--muted); white-space:nowrap;
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH GATE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-logo">CDB <span>Mission Control</span></div>
    <h2 class="auth-title">Welcome back</h2>
    <p class="auth-subtitle">Enter your access code to continue</p>

    <div class="auth-field">
      <label for="auth-code-input">Access Code</label>
      <input
        type="password"
        id="auth-code-input"
        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        autocomplete="off"
        spellcheck="false"
        autofocus
      >
    </div>

    <button class="auth-btn" id="auth-submit-btn" onclick="submitAuth()">
      Request Access
    </button>

    <div class="auth-error" id="auth-error"></div>

    <div class="auth-footer">Cody Design Build Inc. Â· Private System</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP (hidden until authed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none">

<header>
  <div class="logo">CDB <span>Mission Control</span></div>
  <nav>
    <button class="active" onclick="showTab('dashboard',this)">ðŸ“Š Dashboard</button>
    <button onclick="showTab('jobs',this)">ðŸ—ï¸ Jobs</button>
    <button onclick="showTab('inbox',this)">ðŸ“¥ Cost Inbox</button>
    <button onclick="showTab('revenue',this)">ðŸ’° Revenue</button>
    <button onclick="showTab('agents',this)">ðŸ¤– Agents</button>
    <button onclick="showTab('tasks',this)">âœ… Tasks</button>
    <button onclick="showTab('contacts',this)">ðŸ‘¥ Contacts</button>
    <button onclick="showTab('estimating',this)">ðŸ“‹ Estimating</button>
  </nav>
  <div class="header-right">
    <span id="clock"></span>
    <div class="status-dot"></div>
    <button id="signout-btn" onclick="signOut()" title="Sign out">Sign out</button>
  </div>
</header>

<main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-dashboard" class="tab-panel active">
  <div class="welcome">
    <h1 id="greeting">Good morning, David ðŸ‘‹</h1>
    <p id="date-line">Loading...</p>
  </div>

  <div id="last-updated"></div>

  <div class="metrics">
    <!-- Active Jobs -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      <div class="metric-icon">ðŸ—ï¸</div>
      <div class="metric-label">Active Jobs</div>
      <div class="metric-value" id="metric-jobs-count">â€”</div>
      <div class="metric-sub" id="metric-jobs-value">loadingâ€¦</div>
    </div>
    <!-- Cost Inbox -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">ðŸ“¥</div>
      <div class="metric-label">Cost Inbox</div>
      <div class="metric-value" id="metric-inbox-count">â€”</div>
      <div class="metric-sub">transactions to code</div>
    </div>
    <!-- Open Invoices -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">ðŸ’µ</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="metric-invoices-owed">â€”</div>
      <div class="metric-sub" id="metric-invoices-sub">loadingâ€¦</div>
    </div>
    <!-- Draft Bills (static) -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--purple),#c084fc)"></div>
      <div class="metric-icon">ðŸ“‹</div>
      <div class="metric-label">Draft Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 vendor bills pending</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header">
        <span class="card-title">Top Priorities</span>
        <button class="btn btn-ghost" style="font-size:0.72rem;padding:0.25rem 0.6rem" onclick="addPriority()">+ Add</button>
      </div>
      <div id="priorities">
        <div class="priority-item"><input type="checkbox" id="p1" onchange="toggleDone(this)"><label for="p1">Fix Phil's pairing â€” OpenClaw menubar app</label></div>
        <div class="priority-item"><input type="checkbox" id="p2" onchange="toggleDone(this)"><label for="p2">Code this week's Plaid transactions</label></div>
        <div class="priority-item"><input type="checkbox" id="p3" onchange="toggleDone(this)"><label for="p3">Send invoice to Balboa client</label></div>
        <div class="priority-item"><input type="checkbox" id="p4" onchange="toggleDone(this)"><label for="p4">Approve Graham Plastering bill ($9K)</label></div>
        <div class="priority-item"><input type="checkbox" id="p5" onchange="toggleDone(this)"><label for="p5">Invite assistant@codydesignbuild.com to Airtable</label></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><span class="card-title">Activity Feed</span></div>
      <div id="activity-feed" style="font-size:0.82rem;">
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Jerry pulled Plaid transactions</span><span style="color:var(--muted)">just now</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>JT API skill built + tested</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Phil agent created (pairing pending)</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>memory-lancedb enabled</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0"><span>Google Workspace connected</span><span style="color:var(--muted)">today</span></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOBS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-jobs" class="tab-panel">
  <h2>Active Jobs</h2>
  <div id="jobs-list">
    <div class="state-loading">Loading jobsâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COST INBOX TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-inbox" class="tab-panel">
  <div class="inbox-header">
    <h2>ðŸ’¸ Cost Inbox</h2>
    <span class="inbox-remaining" id="inbox-remaining">Loadingâ€¦</span>
    <button onclick="inboxLoaded=false; loadInbox(true)" style="background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:0.3rem 0.65rem;font-size:0.82rem;cursor:pointer;" title="Refresh">â†º</button>
  </div>

  <div class="inbox-filter-pills">
    <button class="pill active" id="inbox-pill-uncoded" onclick="setInboxFilter('uncoded',this)">Uncoded</button>
    <button class="pill" id="inbox-pill-all"     onclick="setInboxFilter('all',this)">All</button>
    <button class="pill" id="inbox-pill-coded"   onclick="setInboxFilter('coded',this)">Coded</button>
    <button class="pill" id="inbox-pill-review"  onclick="setInboxFilter('review',this)">Review</button>
    <button class="pill" id="inbox-pill-excluded" onclick="setInboxFilter('excluded',this)">Excluded</button>
  </div>

  <div id="inbox-list" class="tx-list">
    <div class="state-loading">Loading transactionsâ€¦</div>
  </div>

  <div class="tx-load-more" id="inbox-load-more" style="display:none">
    <button onclick="loadMoreTransactions()">Load More</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REVENUE TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-revenue" class="tab-panel">
  <h2>Revenue Overview</h2>
  <div class="metrics" style="grid-template-columns:repeat(3,1fr)">
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">ðŸ“Š</div>
      <div class="metric-label">Total Pipeline</div>
      <div class="metric-value" id="rev-pipeline">â€”</div>
      <div class="metric-sub" id="rev-pipeline-sub">loadingâ€¦</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--yellow),#fde047)"></div>
      <div class="metric-icon">ðŸ§¾</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="rev-open-invoices">â€”</div>
      <div class="metric-sub" id="rev-invoices-sub">loadingâ€¦</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">ðŸ“¤</div>
      <div class="metric-label">Draft Vendor Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 bills to approve</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span class="card-title">Open Customer Invoices</span></div>
    <table>
      <thead><tr><th>Job</th><th>Invoice</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody id="invoice-rows">
        <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">Draft Vendor Bills</span></div>
    <table>
      <thead><tr><th>Vendor</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>Graham Plastering</td><td>$9,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
        <tr><td>Other</td><td>$32,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AGENTS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-agents" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">
    <h2 style="margin:0">Agent Command Center</h2>
    <div class="agents-live-badge" id="agents-live-badge">
      <div class="dot dot-gray"></div><span>Connectingâ€¦</span>
    </div>
  </div>

  <div class="agent-grid" id="agent-grid">
    <div style="color:var(--muted);font-size:0.85rem;padding:2rem;grid-column:1/-1;text-align:center">Loading agentsâ€¦</div>
  </div>

  <div class="card" id="system-status-card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">System Status</span></div>
    <table>
      <thead><tr><th>Component</th><th>Status</th><th>Detail</th></tr></thead>
      <tbody id="system-status-body">
        <tr><td>Gateway</td><td><span class="badge badge-muted">Checkingâ€¦</span></td><td></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTACTS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-contacts" class="tab-panel">
  <div class="contacts-header">
    <h2>ðŸ‘¥ Contacts</h2>
    <div class="contacts-search-wrap">
      <span class="contacts-search-icon">ðŸ”</span>
      <input class="contacts-search" id="contacts-search" placeholder="Search name, company, phoneâ€¦" oninput="debounceContactSearch()" />
    </div>
    <button class="btn" onclick="openAddContact()">+ Add</button>
  </div>

  <div class="contacts-type-pills" id="contacts-type-pills">
    <button class="pill active"              onclick="setContactFilter('',this)">All</button>
    <button class="pill pill-client"         onclick="setContactFilter('client',this)">Clients</button>
    <button class="pill pill-sub"            onclick="setContactFilter('subcontractor',this)">Subs</button>
    <button class="pill pill-vendor"         onclick="setContactFilter('vendor',this)">Vendors</button>
    <button class="pill pill-personal"       onclick="setContactFilter('personal',this)">Personal</button>
    <button class="pill pill-professional"   onclick="setContactFilter('professional',this)">Professional</button>
  </div>

  <div class="contacts-count" id="contacts-count"></div>
  <div class="contacts-list" id="contacts-list">
    <div class="state-loading">Loading contactsâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD/EDIT CONTACT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="contact-modal">
  <div class="modal-box" style="max-width:520px">
    <div class="modal-title" id="contact-modal-title">New Contact</div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">First name</label><input class="form-input" id="cm-first" placeholder="John" /></div>
      <div class="form-row"><label class="form-label">Last name</label><input class="form-input" id="cm-last" placeholder="Martinez" /></div>
    </div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">Phone</label><input class="form-input" id="cm-phone" placeholder="+1 415 555 1234" /></div>
      <div class="form-row"><label class="form-label">Email</label><input class="form-input" id="cm-email" placeholder="john@example.com" /></div>
    </div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">Company</label><input class="form-input" id="cm-company" placeholder="Coastal Plumbing" /></div>
      <div class="form-row"><label class="form-label">Title / Role</label><input class="form-input" id="cm-title" placeholder="Owner" /></div>
    </div>
    <div class="form-row">
      <label class="form-label">Types (comma-separated)</label>
      <input class="form-input" id="cm-types" placeholder="subcontractor, client, personalâ€¦" />
    </div>
    <div class="form-row">
      <label class="form-label">Trades / Specialty (comma-separated)</label>
      <input class="form-input" id="cm-trades" placeholder="Plumber, Electricianâ€¦" />
    </div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">Rating (1â€“5)</label><input class="form-input" id="cm-rating" type="number" min="1" max="5" /></div>
      <div class="form-row"><label class="form-label">Source</label><input class="form-input" id="cm-source" placeholder="referral, Googleâ€¦" /></div>
    </div>
    <div class="form-row"><label class="form-label">Notes</label><textarea class="form-input" id="cm-notes" rows="2"></textarea></div>
    <div class="form-row" style="display:flex;align-items:center;gap:0.5rem">
      <input type="checkbox" id="cm-verified" style="accent-color:var(--accent)" />
      <label class="form-label" style="margin:0" for="cm-verified">Verified contact</label>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="cm-delete-btn" style="color:var(--red);border-color:rgba(239,68,68,0.3);display:none" onclick="deleteCurrentContact()">Delete</button>
      <button class="btn-cancel" onclick="closeContactModal()">Cancel</button>
      <button class="btn" id="cm-submit-btn" onclick="submitContactModal()">Add Contact</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TASKS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-tasks" class="tab-panel">

  <div class="tasks-header">
    <h2>âœ… Tasks</h2>
    <div class="view-toggle">
      <button class="view-btn active" id="view-kanban-btn" onclick="setTaskView('kanban')">â¬œ Kanban</button>
      <button class="view-btn" id="view-list-btn" onclick="setTaskView('list')">â˜° List</button>
    </div>
    <button class="btn" onclick="openAddTask()">+ Add Task</button>
  </div>

  <!-- Project switcher -->
  <div class="project-switcher" id="project-switcher"><!-- rendered by JS --></div>

  <!-- Content area -->
  <div id="tasks-content">
    <div class="state-loading">Loading tasksâ€¦</div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ESTIMATING TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-estimating" class="tab-panel">

  <!-- Header row: title + job picker + action buttons -->
  <div class="est-header">
    <h2 style="margin:0">ðŸ“‹ Estimating</h2>
    <select class="est-job-select" id="est-job-select" onchange="estSelectJob(this.value)">
      <option value="">â€” Select a job â€”</option>
    </select>
    <button class="btn-outline" onclick="openNewJobModal()" title="Add a new estimating job to Supabase">+ New Job</button>
    <button class="btn" onclick="openNewOrderModal()" id="est-new-order-btn" disabled>+ New Order</button>
  </div>

  <!-- Job-level metrics (hidden until a job is selected) -->
  <div class="est-metrics" id="est-metrics" style="display:none">
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--muted),rgba(107,114,128,0.4))"></div>
      <div class="metric-icon">ðŸ—ï¸</div>
      <div class="metric-label">Est. Cost</div>
      <div class="metric-value" id="est-metric-cost">â€”</div>
      <div class="metric-sub">all orders</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      <div class="metric-icon">ðŸ’°</div>
      <div class="metric-label">Est. Price</div>
      <div class="metric-value" id="est-metric-price">â€”</div>
      <div class="metric-sub" id="est-metric-margin-sub">â€”</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">âœï¸</div>
      <div class="metric-label">Contract Value</div>
      <div class="metric-value" id="est-metric-contract">â€”</div>
      <div class="metric-sub" id="est-metric-contract-sub">signed only</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--blue),#60a5fa)"></div>
      <div class="metric-icon">ðŸ“„</div>
      <div class="metric-label">Orders</div>
      <div class="metric-value" id="est-metric-orders">â€”</div>
      <div class="metric-sub" id="est-metric-orders-sub">â€”</div>
    </div>
  </div>

  <!-- Orders list -->
  <div id="est-orders-area">
    <div class="est-empty">
      <div class="est-empty-icon">ðŸ“‹</div>
      <div>Select a job to see its estimates</div>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NEW ORDER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="new-order-modal" class="hidden">
  <div class="new-order-box" onclick="event.stopPropagation()">
    <h3 id="new-order-modal-title">New Order</h3>
    <div class="form-row" style="margin-bottom:0.75rem">
      <label class="form-label">Name *</label>
      <input class="form-input" id="no-name" placeholder="e.g. Proposal v1, Change Order #2" />
    </div>
    <div class="form-row-2col" style="margin-bottom:0.75rem">
      <div>
        <label class="form-label">Type</label>
        <select class="form-input" id="no-type">
          <option value="Proposal">Proposal</option>
          <option value="Change Order">Change Order</option>
        </select>
      </div>
      <div>
        <label class="form-label">Status</label>
        <select class="form-input" id="no-status">
          <option value="Draft">Draft</option>
          <option value="Sent">Sent</option>
          <option value="Signed">Signed</option>
        </select>
      </div>
    </div>
    <div class="form-row" style="margin-bottom:1.25rem">
      <label class="form-label">Notes</label>
      <input class="form-input" id="no-notes" placeholder="Optional" />
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeNewOrderModal()">Cancel</button>
      <button class="btn" id="no-save-btn" onclick="submitNewOrder()">Create Order</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NEW ESTIMATING JOB MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="new-job-modal" class="hidden">
  <div class="new-order-box" onclick="event.stopPropagation()">
    <h3>New Estimating Job</h3>
    <div class="form-row" style="margin-bottom:0.75rem">
      <label class="form-label">Job Name *</label>
      <input class="form-input" id="nj-name" placeholder="e.g. 714 Taraval Kitchen Remodel" />
    </div>
    <div class="form-row-2col" style="margin-bottom:0.75rem">
      <div>
        <label class="form-label">Status</label>
        <select class="form-input" id="nj-status">
          <option value="estimating">Estimating</option>
          <option value="lead">Lead</option>
          <option value="proposed">Proposed</option>
          <option value="active">Active</option>
        </select>
      </div>
      <div>
        <label class="form-label">City</label>
        <input class="form-input" id="nj-city" placeholder="San Francisco" />
      </div>
    </div>
    <div class="form-row" style="margin-bottom:1.25rem">
      <label class="form-label">Address (optional)</label>
      <input class="form-input" id="nj-address" placeholder="123 Main St" />
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeNewJobModal()">Cancel</button>
      <button class="btn" id="nj-save-btn" onclick="submitNewJob()">Create Job</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD / EDIT TASK MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="add-task-modal">
  <div class="modal-box">
    <div class="modal-title">New Task</div>
    <div class="form-row">
      <label class="form-label">Task name *</label>
      <input class="form-input" id="t-name" placeholder="What needs to be done?" />
    </div>
    <div class="form-row">
      <label class="form-label">Description</label>
      <textarea class="form-input" id="t-desc" rows="2" placeholder="Optional detailsâ€¦"></textarea>
    </div>
    <div class="form-row-2col">
      <div class="form-row">
        <label class="form-label">Status</label>
        <select class="form-input" id="t-status">
          <option value="To Do">To Do</option>
          <option value="In Progress">In Progress</option>
          <option value="Blocked">Blocked</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Priority</label>
        <select class="form-input" id="t-priority">
          <option value="Low">Low</option>
          <option value="Medium" selected>Medium</option>
          <option value="High">High</option>
          <option value="Urgent">Urgent</option>
        </select>
      </div>
    </div>
    <div class="form-row-2col">
      <div class="form-row">
        <label class="form-label">Project</label>
        <select class="form-input" id="t-project">
          <!-- populated by JS -->
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Assignee</label>
        <select class="form-input" id="t-assignee">
          <option value="">Unassigned</option>
          <option value="David">David</option>
          <option value="Jerry">Jerry</option>
          <option value="Phil">Phil</option>
          <option value="Bobby">Bobby</option>
          <option value="Mickey">Mickey</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">Due Date</label>
      <input class="form-input" type="date" id="t-due" style="max-width:200px" />
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="add-task-delete-btn" style="color:var(--red);border-color:rgba(239,68,68,0.3);display:none" onclick="deleteCurrentTask()">Delete</button>
      <button class="btn-cancel" onclick="closeAddTask()">Cancel</button>
      <button class="btn" id="add-task-submit-btn" onclick="submitAddTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NEW PROJECT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="new-project-modal">
  <div class="modal-box" style="max-width:380px">
    <div class="modal-title">New Project</div>
    <div class="form-row">
      <label class="form-label">Project name *</label>
      <input class="form-input" id="np-name" placeholder="e.g. Oakland Kitchen, Siri Shortcut" />
    </div>
    <div class="form-row">
      <label class="form-label">Type</label>
      <select class="form-input" id="np-type">
        <option value="jobs">ðŸ—ï¸ Construction Job</option>
        <option value="dev">ðŸ’» Dev / Tech</option>
        <option value="org">ðŸ¢ Org / Admin</option>
        <option value="other">ðŸ“Œ Other</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeNewProject()">Cancel</button>
      <button class="btn" onclick="submitNewProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPLIT TRANSACTION MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="split-modal">
  <div class="modal-box" style="max-width:600px">
    <div class="modal-title">âœ‚ï¸ Split Transaction</div>
    <div id="split-modal-info" style="font-size:0.84rem;color:var(--muted);margin-bottom:1.1rem;line-height:1.5"></div>

    <div id="split-rows-container"></div>

    <button class="btn-split-add" onclick="addSplitRow()">+ Add another split</button>

    <div class="split-remaining-bar" id="split-remaining-bar">
      <span>Remaining</span>
      <span id="split-remaining-val">â€”</span>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSplitModal()">Cancel</button>
      <button class="btn" id="split-confirm-btn" onclick="submitSplit()" disabled>Confirm Split</button>
    </div>
  </div>
</div>

</main>
</div><!-- /#app -->

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TOKEN_KEY = 'mc_token';

function getToken() {
  return localStorage.getItem(TOKEN_KEY);
}

/** Returns headers object with Authorization + optional Content-Type */
function authHeaders(json = false) {
  const t = getToken();
  const h = {};
  if (t) h['Authorization'] = `Bearer ${t}`;
  if (json) h['Content-Type'] = 'application/json';
  return h;
}

function showApp() {
  document.getElementById('auth-overlay').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
  loadData();
  // Restore last active tab â€” defer slightly so the DOM is ready
  const hash    = window.location.hash.replace('#', '');
  const lastTab = hash || localStorage.getItem('mc_active_tab') || 'dashboard';
  const tabs    = ['dashboard','jobs','inbox','revenue','agents','tasks','contacts','estimating'];
  const target  = tabs.includes(lastTab) ? lastTab : 'dashboard';
  if (target !== 'dashboard') {
    setTimeout(() => {
      const btn = [...document.querySelectorAll('nav button')].find(b => b.getAttribute('onclick')?.includes(`'${target}'`));
      if (btn) showTab(target, btn);
    }, 50);
  }
}

function showAuthOverlay() {
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('app').style.display = 'none';
  setTimeout(() => document.getElementById('auth-code-input').focus(), 100);
}

function setAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}

function clearAuthError() {
  document.getElementById('auth-error').classList.remove('show');
}

async function submitAuth() {
  const input = document.getElementById('auth-code-input');
  const btn   = document.getElementById('auth-submit-btn');
  const code  = input.value.trim();

  if (!code) { setAuthError('Please enter your access code.'); return; }

  clearAuthError();
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Verifyingâ€¦';

  try {
    const res  = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code }),
    });
    const data = await res.json();

    if (data.ok && data.token) {
      localStorage.setItem(TOKEN_KEY, data.token);
      input.value = '';
      showApp();
    } else {
      setAuthError(data.error || 'Access denied. Check your code and try again.');
      input.value = '';
      input.focus();
    }
  } catch (err) {
    setAuthError('Connection error â€” please try again.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Request Access';
  }
}

function signOut() {
  localStorage.removeItem(TOKEN_KEY);
  showAuthOverlay();
}

// Allow Enter key on the access code input
document.getElementById('auth-code-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitAuth();
});

// Boot: check token
(function bootAuth() {
  const token = getToken();
  if (token) {
    // Token exists â€” trust it and show app (server validates on every API call)
    showApp();
  } else {
    showAuthOverlay();
  }
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK & GREETING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateClock() {
  const now = new Date();
  const clockEl = document.getElementById('clock');
  if (clockEl) {
    clockEl.textContent = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }
  const hour = now.getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  const greetEl = document.getElementById('greeting');
  if (greetEl) greetEl.textContent = `${greeting}, David ðŸ‘‹`;
  const dateEl = document.getElementById('date-line');
  if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' Â· Cody Design Build Inc.';
}
updateClock();
setInterval(updateClock, 1000);


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  localStorage.setItem('mc_active_tab', name);
  history.replaceState(null, '', '#' + name);
  if (name === 'tasks') fetchTasks();
  if (name === 'agents') fetchAgents();
  if (name === 'contacts') fetchContacts(contactSearchTerm, contactFilter);
  if (name === 'inbox')      loadInbox(true);
  if (name === 'estimating') loadEstimating();
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRIORITIES (localStorage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleDone(cb) {
  cb.nextElementSibling.classList.toggle('done', cb.checked);
  savePriorities();
}
function addPriority() {
  const text = prompt('New priority:');
  if (!text) return;
  const id  = 'p' + Date.now();
  const div = document.createElement('div');
  div.className = 'priority-item';
  div.innerHTML = `<input type="checkbox" id="${id}" onchange="toggleDone(this)"><label for="${id}">${text}</label>`;
  document.getElementById('priorities').appendChild(div);
  savePriorities();
}
function savePriorities() {
  const items = [...document.querySelectorAll('#priorities .priority-item')].map(el => ({
    text: el.querySelector('label').textContent,
    done: el.querySelector('input').checked,
  }));
  localStorage.setItem('mc_priorities', JSON.stringify(items));
}
function loadPriorities() {
  const saved = localStorage.getItem('mc_priorities');
  if (!saved) return;
  try {
    const items     = JSON.parse(saved);
    const container = document.getElementById('priorities');
    container.innerHTML = '';
    items.forEach((item, i) => {
      const id  = 'p' + i;
      const div = document.createElement('div');
      div.className = 'priority-item';
      div.innerHTML = `<input type="checkbox" id="${id}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"><label for="${id}" class="${item.done ? 'done' : ''}">${item.text}</label>`;
      container.appendChild(div);
    });
  } catch(e) {}
}
loadPriorities();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURRENCY FORMATTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtCurrency(n) {
  if (n === null || n === undefined || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1_000_000) {
    return sign + '$' + (abs / 1_000_000).toFixed(2).replace(/\.?0+$/, '') + 'M';
  }
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function fmtCurrencyFull(n) {
  if (n === null || n === undefined || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtDate(str) {
  if (!str) return 'â€”';
  try {
    // Append T12:00:00 so bare YYYY-MM-DD dates aren't parsed as UTC midnight
    // (which shifts to the previous day in US timezones)
    const d = str.includes('T') ? new Date(str) : new Date(str + 'T12:00:00');
    return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
  } catch { return str; }
}

function progressColor(pct) {
  if (pct >= 90) return 'var(--red)';
  if (pct >= 70) return 'var(--yellow)';
  return 'var(--accent)';
}

function invoiceStatusBadge(status) {
  if (!status) return '<span class="badge badge-muted">Unknown</span>';
  const s = status.toLowerCase();
  if (s.includes('paid'))    return '<span class="badge badge-green">Paid</span>';
  if (s.includes('partial')) return '<span class="badge badge-blue">Partial</span>';
  if (s.includes('draft'))   return '<span class="badge badge-orange">Draft</span>';
  if (s.includes('void'))    return '<span class="badge badge-muted">Void</span>';
  return `<span class="badge badge-yellow">${status}</span>`;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderJobs(data) {
  const container = document.getElementById('jobs-list');
  const jobs = data.jobs || [];

  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No active jobs found.</div>';
    return;
  }

  container.innerHTML = jobs.map(job => {
    const contractValue = Number(job.contractValue) || 0;
    const billed        = Number(job.billed)        || 0;
    const owed          = Number(job.owed)           || 0;
    const pct           = contractValue > 0 ? Math.min(100, Math.round((billed / contractValue) * 100)) : 0;
    const color         = progressColor(pct);
    const customer      = job.customer || 'â€”';
    const jobNum        = job.number   ? `Job #${job.number}` : (job.id || '');

    return `
      <div class="job-card">
        <div class="job-header">
          <div>
            <div class="job-name">${escHtml(job.name || 'Untitled Job')}</div>
            <div class="job-number">${escHtml(jobNum)} Â· ${escHtml(customer)}</div>
          </div>
          <span class="badge badge-green">Active</span>
        </div>
        <div class="job-budget-row"><span>Contract Value</span><strong>${fmtCurrency(contractValue)}</strong></div>
        <div class="job-budget-row"><span>Billed So Far</span><strong>${fmtCurrency(billed)}</strong></div>
        <div class="job-budget-row"><span>Outstanding</span><strong style="color:${owed > 0 ? 'var(--yellow)' : 'var(--muted)'}">${fmtCurrency(owed)}</strong></div>
        <div class="progress-bar" style="margin-top:0.6rem">
          <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.4rem">${pct}% billed of contract</div>
      </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COST INBOX â€” Transaction Coding UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let inboxTxAll      = [];   // full loaded list for current filter
let inboxFilter     = 'uncoded';
let inboxJobs       = [];
let inboxCostCodes  = [];
let inboxExpanded   = null; // id of expanded card
let inboxUncodedCount = 0;
let inboxLoaded     = false;
let inboxOffset     = 0;
const INBOX_PAGE    = 100;

// Merchant keyword â†’ suggested job name fragments (auto-suggest)
const MERCHANT_HINTS = {
  'HOME DEPOT'    : 'construction',
  'LOWES'         : 'construction',
  "LOWE'S"        : 'construction',
  'GOLDEN STATE'  : 'construction',
  'PACIFIC COAST' : 'construction',
  'LUMBER'        : 'construction',
  'HARDWARE'      : 'construction',
  'CONCRETE'      : 'construction',
  'PLYWOOD'       : 'construction',
};

async function loadInbox(forceReload) {
  if (inboxLoaded && !forceReload) return;

  // Load reference data once
  if (!inboxCostCodes.length) {
    try {
      const [ccRes, jobsRes] = await Promise.all([
        apiFetch('/api/transactions?resource=cost_codes'),
        apiFetch('/api/transactions?resource=jobs'),
      ]);
      inboxCostCodes = (ccRes?.cost_codes || []);
      inboxJobs      = (jobsRes?.jobs      || []);
    } catch (e) {
      console.warn('Could not load cost codes / jobs:', e);
    }
    // Fallback: try to get jobs from JobTread endpoint
    if (!inboxJobs.length) {
      try {
        const jtRes = await apiFetch('/api/jobs');
        inboxJobs = (jtRes?.jobs || []).map(j => ({ id: j.id, name: j.name, status: j.status || 'active' }));
      } catch (_) {}
    }
  }

  await fetchInboxTransactions();
}

async function fetchInboxTransactions() {
  const container = document.getElementById('inbox-list');
  container.innerHTML = '<div class="state-loading">Loadingâ€¦</div>';

  try {
    const status = inboxFilter;
    const url = `/api/transactions?status=${status}&limit=${INBOX_PAGE}`;
    const data = await apiFetch(url);
    if (!data) throw new Error('No data');

    inboxTxAll = data.transactions || [];
    inboxUncodedCount = data.uncoded_count ?? 0;
    inboxLoaded = true;
    inboxOffset = inboxTxAll.length;

    updateInboxRemaining(inboxUncodedCount);

    // Show/hide load-more
    const loadMore = document.getElementById('inbox-load-more');
    if (loadMore) loadMore.style.display = data.total >= INBOX_PAGE ? 'block' : 'none';

    renderInboxList(inboxTxAll);

    // Auto-expand first uncoded card
    if (inboxFilter === 'uncoded') {
      const first = inboxTxAll.find(t => t.status === 'uncoded');
      if (first) expandTxCard(first.id);
    }
  } catch (err) {
    container.innerHTML = `<div class="state-error">Failed to load transactions: ${escHtml(err.message)}</div>`;
  }
}

async function loadMoreTransactions() {
  const btn = document.querySelector('#inbox-load-more button');
  if (btn) { btn.textContent = 'Loadingâ€¦'; btn.disabled = true; }
  try {
    const data = await apiFetch(`/api/transactions?status=${inboxFilter}&limit=${INBOX_PAGE}&offset=${inboxOffset}`);
    if (data?.transactions?.length) {
      inboxTxAll = [...inboxTxAll, ...data.transactions];
      inboxOffset = inboxTxAll.length;
      renderInboxList(inboxTxAll);
      const loadMore = document.getElementById('inbox-load-more');
      if (loadMore) loadMore.style.display = data.transactions.length >= INBOX_PAGE ? 'block' : 'none';
    } else {
      if (document.getElementById('inbox-load-more')) document.getElementById('inbox-load-more').style.display = 'none';
    }
  } catch(e) {}
  if (btn) { btn.textContent = 'Load More'; btn.disabled = false; }
}

function updateInboxRemaining(count) {
  const el = document.getElementById('inbox-remaining');
  if (!el) return;
  if (inboxFilter === 'uncoded') {
    el.textContent = count > 0 ? `${count} uncoded remaining` : 'âœ… All coded!';
    el.style.color = count > 0 ? 'var(--muted)' : 'var(--green)';
  } else {
    el.textContent = `${inboxUncodedCount} uncoded remaining`;
    el.style.color = 'var(--muted)';
  }
  // Also update dashboard metric
  const metricEl = document.getElementById('metric-inbox-count');
  if (metricEl) metricEl.textContent = inboxUncodedCount;
}

function setInboxFilter(filter, btn) {
  inboxFilter = filter;
  inboxLoaded = false;
  inboxExpanded = null;
  document.querySelectorAll('.inbox-filter-pills .pill').forEach(p => p.classList.remove('active'));
  if (btn) btn.classList.add('active');
  fetchInboxTransactions();
}

function renderInboxList(transactions) {
  const container = document.getElementById('inbox-list');
  if (!transactions.length) {
    container.innerHTML = '<div class="state-loading">No transactions found. âœ…</div>';
    return;
  }
  container.innerHTML = transactions.map(tx => renderTxCard(tx)).join('');

  // Re-expand previously expanded card
  if (inboxExpanded) {
    const card = document.getElementById('tx-' + inboxExpanded);
    if (card) {
      card.classList.add('expanded');
      const coding = card.querySelector('.tx-coding');
      if (coding) coding.classList.add('open');
    }
  }
}

function renderTxCard(tx) {
  const amount   = Number(tx.amount) || 0;
  const amtClass = amount < 0 ? 'negative' : '';
  const amtFmt   = (amount < 0 ? '-' : '') + fmtCurrency(Math.abs(amount));
  const dateStr  = fmtDate(tx.date);
  const account  = tx.account_name ? escHtml(tx.account_name) : '';
  const merchant = tx.merchant || tx.description || 'â€”';
  const status   = tx.status || 'uncoded';

  const statusLabels = { uncoded:'Uncoded', coded:'Coded', review:'Review', excluded:'Excluded' };
  const statusLabel  = statusLabels[status] || status;

  const existingJob  = tx.job_name       ? `<div class="tx-existing">Job: <strong>${escHtml(tx.job_name)}</strong></div>` : '';
  const existingCode = tx.cost_code_name ? `<div class="tx-existing">Code: <strong>${escHtml(tx.cost_code_number + ' ' + tx.cost_code_name)}</strong></div>` : '';

  // Job options
  const jobOptions = inboxJobs.length
    ? `<option value="">â€” No Job â€”</option>` + inboxJobs.map(j =>
        `<option value="${escHtml(j.id)}" ${tx.job_id === j.id ? 'selected' : ''}>${escHtml(j.name)}</option>`
      ).join('')
    : `<option value="">No jobs loaded</option>`;

  // Cost code options grouped by category (in logical build order)
  const CC_CATEGORY_ORDER = [
    'General', 'Preconstruction', 'Site Work', 'Structure & Envelope',
    'MEP', 'Finishes', 'Fixtures & Features', 'Exterior'
  ];
  const ccByCategory = {};
  inboxCostCodes.forEach(cc => {
    if (!ccByCategory[cc.category]) ccByCategory[cc.category] = [];
    ccByCategory[cc.category].push(cc);
  });
  // Sort categories in defined order, then any unknown ones at the end
  const sortedCategories = [
    ...CC_CATEGORY_ORDER.filter(c => ccByCategory[c]),
    ...Object.keys(ccByCategory).filter(c => !CC_CATEGORY_ORDER.includes(c))
  ];
  const ccOptions = `<option value="">â€” No Code â€”</option>` +
    sortedCategories.map(cat => {
      const codes = ccByCategory[cat];
      return `<optgroup label="${escHtml(cat)}">${
        codes.map(cc =>
          `<option value="${escHtml(cc.id)}" ${tx.cost_code_id === cc.id ? 'selected' : ''}>${cc.number} Â· ${escHtml(cc.name)}</option>`
        ).join('')
      }</optgroup>`;
    }).join('');

  // Auto-suggest job hint
  const merchantUpper = merchant.toUpperCase();
  let suggestHint = '';
  for (const [kw, hint] of Object.entries(MERCHANT_HINTS)) {
    if (merchantUpper.includes(kw)) {
      const match = inboxJobs.find(j => j.name.toLowerCase().includes(hint));
      if (match) {
        suggestHint = `<div class="tx-suggest" onclick="applySuggestedJob('${tx.id}','${escHtml(match.id)}','${escHtml(match.name).replace(/'/g,"\\'")}')" id="suggest-${tx.id}">ðŸ’¡ Suggest: ${escHtml(match.name)}</div>`;
        break;
      }
    }
  }

  return `
<div class="tx-card status-${status}" id="tx-${tx.id}">
  <div class="tx-card-header" onclick="toggleTxCard('${tx.id}')">
    <div class="tx-merchant">
      <div class="tx-merchant-name">${escHtml(merchant)}</div>
      <div class="tx-meta">${dateStr}${account ? ' Â· ' + account : ''}</div>
      ${existingJob}${existingCode}
    </div>
    <div class="tx-amount ${amtClass}">${amtFmt}</div>
    <span class="tx-status-pill ${status}">${statusLabel}</span>
    <span class="tx-chevron">â–¼</span>
  </div>
  <div class="tx-coding" id="coding-${tx.id}">
    <div class="tx-full-desc">${escHtml(tx.description || tx.merchant || '')}</div>
    <div class="tx-coding-row">
      <div>
        <label>Job</label>
        <select id="sel-job-${tx.id}">${jobOptions}</select>
        ${suggestHint}
      </div>
      <div>
        <label>Cost Code</label>
        <select id="sel-cc-${tx.id}">${ccOptions}</select>
      </div>
    </div>
    <div>
      <label>Notes (optional)</label>
      <input type="text" id="notes-${tx.id}" value="${escHtml(tx.notes || '')}"
        placeholder="e.g. materials for bathroom remodel"
        onkeydown="if(event.key==='Enter'){event.preventDefault();submitTxCode('${tx.id}')}">
    </div>
    <div class="tx-coding-actions">
      <button class="btn-code" onclick="submitTxCode('${tx.id}')">Save</button>
      ${status !== 'excluded' ? `<button class="btn-split" onclick="openSplitModal('${tx.id}')">âœ‚ï¸ Split</button>` : ''}
      <button class="btn-review" onclick="submitTxStatus('${tx.id}','review')">âš‘ Flag for Review</button>
      <button class="btn-exclude" onclick="submitTxStatus('${tx.id}','excluded')">âœ• Exclude</button>
    </div>
  </div>
</div>`;
}

function toggleTxCard(id) {
  const card   = document.getElementById('tx-' + id);
  const coding = document.getElementById('coding-' + id);
  if (!card || !coding) return;

  const isExpanded = card.classList.contains('expanded');
  if (isExpanded) {
    card.classList.remove('expanded');
    coding.classList.remove('open');
    if (inboxExpanded === id) inboxExpanded = null;
  } else {
    expandTxCard(id);
  }
}

function expandTxCard(id) {
  // Collapse previously expanded
  if (inboxExpanded && inboxExpanded !== id) {
    const prev = document.getElementById('tx-' + inboxExpanded);
    const prevCoding = document.getElementById('coding-' + inboxExpanded);
    if (prev) prev.classList.remove('expanded');
    if (prevCoding) prevCoding.classList.remove('open');
  }
  const card   = document.getElementById('tx-' + id);
  const coding = document.getElementById('coding-' + id);
  if (!card || !coding) return;

  card.classList.add('expanded');
  coding.classList.add('open');
  inboxExpanded = id;

  // Scroll into view
  setTimeout(() => {
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    const notesInput = document.getElementById('notes-' + id);
    if (notesInput) notesInput.focus();
  }, 80);
}

function applySuggestedJob(txId, jobId, jobName) {
  const sel = document.getElementById('sel-job-' + txId);
  if (sel) sel.value = jobId;
  const hint = document.getElementById('suggest-' + txId);
  if (hint) hint.style.display = 'none';
}

async function submitTxCode(id) {
  const jobSel  = document.getElementById('sel-job-' + id);
  const ccSel   = document.getElementById('sel-cc-' + id);
  const notesEl = document.getElementById('notes-' + id);
  const btn     = document.querySelector(`#coding-${id} .btn-code`);

  const jobId  = jobSel?.value  || null;
  const ccId   = ccSel?.value   || null;
  const notes  = notesEl?.value || '';

  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }

  try {
    const data = await apiPatch(`/api/transactions?id=${id}`, {
      job_id: jobId || '',
      cost_code_id: ccId || '',
      status: 'coded',
      notes,
    });

    if (data?.ok) {
      // Update local cache
      const tx = inboxTxAll.find(t => t.id === id);
      if (tx) {
        tx.status = 'coded';
        tx.job_id = jobId;
        tx.cost_code_id = ccId;
        tx.notes = notes;
        if (jobId) tx.job_name = inboxJobs.find(j => j.id === jobId)?.name || '';
        if (ccId) {
          const cc = inboxCostCodes.find(c => c.id === ccId);
          tx.cost_code_name = cc?.name || '';
          tx.cost_code_number = cc?.number || '';
        }
      }

      // Flash card green, then update
      const card = document.getElementById('tx-' + id);
      if (card) {
        card.classList.add('flash-green');
        setTimeout(() => card.classList.remove('flash-green'), 700);
      }

      inboxUncodedCount = data.uncoded_count ?? Math.max(0, inboxUncodedCount - 1);
      updateInboxRemaining(inboxUncodedCount);

      // If in uncoded filter, collapse & remove card after flash, advance to next
      if (inboxFilter === 'uncoded') {
        const idx = inboxTxAll.findIndex(t => t.id === id);
        setTimeout(() => {
          // Remove from list
          inboxTxAll = inboxTxAll.filter(t => t.id !== id);
          const nextUncoded = inboxTxAll.find(t => t.status === 'uncoded');
          inboxExpanded = null;
          renderInboxList(inboxTxAll);
          if (nextUncoded) expandTxCard(nextUncoded.id);
        }, 500);
      } else {
        // Just re-render the card in place
        inboxExpanded = null;
        const oldCard = document.getElementById('tx-' + id);
        if (oldCard) {
          const txUpdated = inboxTxAll.find(t => t.id === id);
          if (txUpdated) oldCard.outerHTML = renderTxCard(txUpdated);
        }
      }
    } else {
      alert('Failed to save: ' + (data?.error || 'Unknown error'));
      if (btn) { btn.disabled = false; btn.textContent = 'âœ“ Code It'; }
    }
  } catch (err) {
    alert('Error: ' + err.message);
    if (btn) { btn.disabled = false; btn.textContent = 'âœ“ Code It'; }
  }
}

async function submitTxStatus(id, newStatus) {
  const notesEl = document.getElementById('notes-' + id);
  const notes   = notesEl?.value || '';

  try {
    const data = await apiPatch(`/api/transactions?id=${id}`, { status: newStatus, notes });

    if (data?.ok) {
      const tx = inboxTxAll.find(t => t.id === id);
      if (tx) { tx.status = newStatus; tx.notes = notes; }

      const card = document.getElementById('tx-' + id);
      if (card) {
        const flashClass = newStatus === 'review' ? 'flash-yellow' : '';
        if (flashClass) {
          card.classList.add(flashClass);
          setTimeout(() => card.classList.remove(flashClass), 700);
        }
      }

      if (newStatus === 'excluded') {
        inboxUncodedCount = data.uncoded_count ?? Math.max(0, inboxUncodedCount - 1);
        updateInboxRemaining(inboxUncodedCount);

        // Show "always exclude?" rule prompt before removing card
        const tx = inboxTxAll.find(t => t.id === id);
        const merchant = tx?.merchant || tx?.description || '';
        if (merchant) {
          const codingEl = document.getElementById('coding-' + id);
          if (codingEl) {
            codingEl.innerHTML = `
              <div class="tx-rule-prompt">
                Always exclude <strong>${escHtml(merchant)}</strong>?
                <button class="btn-rule-yes" onclick="createExclusionRule('${id}','merchant','${escHtml(merchant).replace(/'/g,"\\'")}')">Yes, always</button>
                <button class="btn-rule-no" onclick="dismissRulePrompt('${id}')">Just this one</button>
              </div>`;
            // Auto-dismiss and advance after 6s if no action
            setTimeout(() => dismissRulePrompt(id), 6000);
            return; // Don't remove card yet â€” let user respond first
          }
        }
      }

      if (inboxFilter === 'uncoded') {
        setTimeout(() => {
          inboxTxAll = inboxTxAll.filter(t => t.id !== id);
          const next = inboxTxAll.find(t => t.status === 'uncoded');
          inboxExpanded = null;
          renderInboxList(inboxTxAll);
          if (next) expandTxCard(next.id);
        }, newStatus === 'review' ? 600 : 200);
      } else {
        inboxExpanded = null;
        const oldCard = document.getElementById('tx-' + id);
        if (oldCard) {
          const txUpdated = inboxTxAll.find(t => t.id === id);
          if (txUpdated) oldCard.outerHTML = renderTxCard(txUpdated);
        }
      }
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

function advanceAfterExclude(id) {
  inboxTxAll = inboxTxAll.filter(t => t.id !== id);
  const next = inboxTxAll.find(t => t.status === 'uncoded');
  inboxExpanded = null;
  renderInboxList(inboxTxAll);
  if (next) expandTxCard(next.id);
}

function dismissRulePrompt(id) {
  if (inboxFilter === 'uncoded') advanceAfterExclude(id);
  else {
    const card = document.getElementById('tx-' + id);
    const tx = inboxTxAll.find(t => t.id === id);
    if (card && tx) card.outerHTML = renderTxCard(tx);
  }
}

async function createExclusionRule(txId, patternType, patternValue) {
  const btn = document.querySelector(`#coding-${txId} .btn-rule-yes`);
  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }

  try {
    const data = await apiPost('/api/exclusion-rules', {
      pattern_type: patternType, pattern_value: patternValue, apply_now: true,
    });

    if (data?.ok) {
      const applied = data.applied || 0;
      // Remove all newly-excluded transactions from the list
      if (applied > 0) {
        // Reload inbox to reflect bulk exclusion
        inboxLoaded = false;
        await loadInbox(true);
      } else {
        advanceAfterExclude(txId);
      }
      // Brief toast
      showCopyToast(`Rule saved â€” ${applied > 1 ? applied + ' transactions excluded' : 'future matches auto-excluded'}`);
    }
  } catch (err) {
    alert('Error creating rule: ' + err.message);
    advanceAfterExclude(txId);
  }
}

// â”€â”€ Helper: authenticated API fetcher â”€â”€
async function apiFetch(url) {
  const token = getToken();
  const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
  const res = await fetch(url, { headers });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `HTTP ${res.status}`);
  }
  return res.json();
}

async function apiPost(url, body) {
  const token = getToken();
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `HTTP ${res.status}`);
  }
  return res.json();
}

async function apiPatch(url, body) {
  const token = getToken();
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(url, { method: 'PATCH', headers, body: JSON.stringify(body) });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `HTTP ${res.status}`);
  }
  return res.json();
}

function renderInvoices(data) {
  const invoices = data.invoices || [];
  const tbody    = document.getElementById('invoice-rows');

  if (!invoices.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">No open invoices.</td></tr>';
    return;
  }

  tbody.innerHTML = invoices.map(inv => {
    const jobName = inv.jobName || 'â€”';
    const invName = inv.name   || (inv.number ? `Invoice #${inv.number}` : 'â€”');
    const total   = fmtCurrency(Number(inv.total) || 0);
    const date    = fmtDate(inv.date);
    const badge   = invoiceStatusBadge(inv.status);
    return `<tr>
      <td>${escHtml(jobName)}</td>
      <td>${escHtml(invName)}</td>
      <td style="color:var(--muted);font-size:0.78rem">${date}</td>
      <td>${total}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE DATA LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  const token = getToken();

  const headers = token
    ? { 'Authorization': `Bearer ${token}` }
    : {};

  let jobsData, inboxData, invoicesData;

  try {
    [jobsData, inboxData, invoicesData] = await Promise.all([
      fetch('/api/jobs',                              { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/transactions?status=uncoded&limit=1', { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/invoices',                          { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
    ]);
  } catch (e) {
    console.error('loadData failed:', e);
  }

  // â”€â”€ JOBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (jobsData) {
    const count = jobsData.total ?? (jobsData.jobs || []).length;
    const val   = Number(jobsData.totalValue) || 0;

    document.getElementById('metric-jobs-count').textContent = count !== null ? count : 'â€”';
    document.getElementById('metric-jobs-value').textContent =
      val > 0 ? `${fmtCurrency(val)} total value` : 'no value data';

    // Revenue tab pipeline
    const revPipeline = document.getElementById('rev-pipeline');
    if (revPipeline) revPipeline.textContent = val > 0 ? fmtCurrency(val) : 'â€”';
    const revPipelineSub = document.getElementById('rev-pipeline-sub');
    if (revPipelineSub) revPipelineSub.textContent = `${count} active job${count !== 1 ? 's' : ''}`;

    renderJobs(jobsData);
  } else {
    document.getElementById('metric-jobs-count').textContent = 'â€”';
    document.getElementById('metric-jobs-value').textContent = 'failed to load';
    document.getElementById('jobs-list').innerHTML =
      '<div class="state-error">Could not load jobs â€” API unavailable.</div>';
  }

  // â”€â”€ INBOX (dashboard metric only â€” full UI loads on tab open) â”€â”€â”€â”€â”€â”€
  if (inboxData) {
    const count = inboxData.uncoded_count ?? inboxData.count ?? 0;
    document.getElementById('metric-inbox-count').textContent = count;
    inboxUncodedCount = count;
  } else {
    document.getElementById('metric-inbox-count').textContent = 'â€”';
  }

  // â”€â”€ INVOICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (invoicesData) {
    const owed  = Number(invoicesData.totalOwed) || 0;
    const count = invoicesData.count ?? (invoicesData.invoices || []).length;

    document.getElementById('metric-invoices-owed').textContent = fmtCurrency(owed);
    document.getElementById('metric-invoices-sub').textContent =
      `${count} invoice${count !== 1 ? 's' : ''} outstanding`;

    // Revenue tab open invoices
    const revOwed = document.getElementById('rev-open-invoices');
    if (revOwed) revOwed.textContent = fmtCurrency(owed);
    const revInvSub = document.getElementById('rev-invoices-sub');
    if (revInvSub) revInvSub.textContent = `${count} invoice${count !== 1 ? 's' : ''} pending`;

    renderInvoices(invoicesData);
  } else {
    document.getElementById('metric-invoices-owed').textContent = 'â€”';
    document.getElementById('metric-invoices-sub').textContent = 'failed to load';
    document.getElementById('invoice-rows').innerHTML =
      '<tr><td colspan="5" style="text-align:center;color:var(--red);padding:1.5rem">Could not load invoices â€” API unavailable.</td></tr>';
  }

  // â”€â”€ LAST UPDATED TIMESTAMP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ts = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
  const lastUpdatedEl = document.getElementById('last-updated');
  if (lastUpdatedEl) {
    lastUpdatedEl.textContent = `Last updated: ${ts}`;
  }
}

// Auto-refresh every 5 minutes
setInterval(loadData, 5 * 60 * 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AGENTS â€” Live Status + Model Switcher
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LOCAL_API = 'http://127.0.0.1:18900';
const MODELS = [
  { id: 'anthropic/claude-sonnet-4-6',  label: 'Claude Sonnet 4.6 (default)' },
  { id: 'anthropic/claude-opus-4-5',    label: 'Claude Opus 4.5' },
  { id: 'anthropic/claude-haiku-4-5',   label: 'Claude Haiku 4.5' },
  { id: 'openai/gpt-4o',                label: 'GPT-4o' },
  { id: 'openai/gpt-4o-mini',           label: 'GPT-4o Mini' },
  { id: 'openai/o3-mini',               label: 'o3-mini' },
];

let agentsData = null;          // last fetched payload
let agentModelDraft = {};       // { agentId: selectedModel } â€” unsaved changes
let localAvailable = false;

function fmtAgo(seconds) {
  if (!seconds) return 'never';
  if (seconds < 60) return `${seconds}s ago`;
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function statusMeta(agent) {
  if (!agent.gatewayUp) return { dot: 'dot-gray',   label: 'Offline',  color: 'var(--muted)' };
  if (agent.status === 'active')  return { dot: 'dot-green',  label: 'Active',   color: 'var(--green)' };
  if (agent.status === 'recent')  return { dot: 'dot-yellow', label: 'Idle',     color: 'var(--yellow)' };
  return { dot: 'dot-gray',   label: 'Idle',     color: 'var(--muted)' };
}

function renderAgentCard(agent) {
  const sm = statusMeta(agent);
  const draft = agentModelDraft[agent.id] ?? agent.model;
  const isDirty = draft !== agent.model;
  const channelStr = agent.channel ? ` Â· ${agent.channel}` : '';

  const modelOptions = MODELS.map(m =>
    `<option value="${m.id}" ${draft === m.id ? 'selected' : ''}>${m.label}</option>`
  ).join('');

  const caps = (agent.capabilities || [])
    .map(c => `<span class="badge badge-muted">${c}</span>`)
    .join('');

  return `
  <div class="agent-card ${agent.status === 'active' ? 'agent-active' : ''}" id="card-${agent.id}">
    <div class="agent-header">
      <div class="agent-emoji">${agent.emoji}</div>
      <div>
        <div class="agent-name">${agent.name}</div>
        <div class="agent-role">${agent.role}</div>
      </div>
    </div>
    <div class="agent-status-row">
      <div class="dot ${sm.dot}"></div>
      <span style="color:${sm.color}">${sm.label}</span>
      <span style="color:var(--muted)">${channelStr}</span>
    </div>
    <div class="agent-last-active">Last active: ${fmtAgo(agent.lastActiveAgo)}</div>
    <div class="agent-caps">${caps}</div>
    <div class="agent-model-row">
      <span class="agent-model-label">Model</span>
      <select class="model-select" id="model-select-${agent.id}"
        onchange="onModelChange('${agent.id}', this.value)">
        ${modelOptions}
      </select>
      <button class="model-save-btn" id="model-save-${agent.id}"
        onclick="saveModel('${agent.id}')"
        ${isDirty ? '' : 'disabled'}>
        Save
      </button>
    </div>
  </div>`;
}

function renderAgents(data) {
  const grid = document.getElementById('agent-grid');
  if (!grid) return;
  grid.innerHTML = data.agents.map(renderAgentCard).join('');

  // System status table
  const tbody = document.getElementById('system-status-body');
  if (tbody) {
    const gw = data.gatewayStatus === 'running';
    tbody.innerHTML = `
      <tr><td>Gateway</td>
          <td><span class="badge ${gw ? 'badge-green' : 'badge-red'}">${gw ? 'Running' : 'Stopped'}</span></td>
          <td style="color:var(--muted);font-size:0.78rem">ws://127.0.0.1:18789 Â· Telegram connected</td></tr>
      <tr><td>Memory</td>
          <td><span class="badge badge-green">Active</span></td>
          <td style="color:var(--muted);font-size:0.78rem">memory-lancedb Â· text-embedding-3-small</td></tr>
      <tr><td>JT API</td>
          <td><span class="badge badge-green">Working</span></td>
          <td style="color:var(--muted);font-size:0.78rem">Pave Â· grant key valid Â· Org 22NeVb7CK2sW</td></tr>
      <tr><td>Google Workspace</td>
          <td><span class="badge badge-green">Connected</span></td>
          <td style="color:var(--muted);font-size:0.78rem">assistant@codydesignbuild.com</td></tr>
      <tr><td>Local Status API</td>
          <td><span class="badge badge-green">Online</span></td>
          <td style="color:var(--muted);font-size:0.78rem">127.0.0.1:18900 Â· live data</td></tr>`;
  }
}

function renderAgentsFallback() {
  const grid = document.getElementById('agent-grid');
  if (grid) {
    grid.innerHTML = `<div style="color:var(--muted);font-size:0.82rem;padding:1.5rem;grid-column:1/-1;text-align:center">
      âš ï¸ Local status server unreachable (port 18900).<br>
      Live status only available when on the Mac mini or local network.
    </div>`;
  }
}

function setLiveBadge(live) {
  const badge = document.getElementById('agents-live-badge');
  if (!badge) return;
  badge.innerHTML = live
    ? `<div class="dot dot-green"></div><span style="color:var(--green)">Live</span>`
    : `<div class="dot dot-gray"></div><span>Offline â€” remote view</span>`;
}

async function fetchAgents() {
  try {
    const res = await fetch(`${LOCAL_API}/api/agents`, { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    agentsData = data;
    localAvailable = true;
    setLiveBadge(true);
    renderAgents(data);
  } catch {
    localAvailable = false;
    setLiveBadge(false);
    if (!agentsData) renderAgentsFallback();
  }
}

function onModelChange(agentId, value) {
  agentModelDraft[agentId] = value;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) btn.disabled = (value === (agentsData?.agents?.find(a => a.id === agentId)?.model));
}

async function saveModel(agentId) {
  const model = agentModelDraft[agentId];
  if (!model) return;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
  try {
    const res = await fetch(`${LOCAL_API}/api/agents/${agentId}/model`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model }),
      signal: AbortSignal.timeout(5000),
    });
    const data = await res.json();
    if (data.ok) {
      delete agentModelDraft[agentId];
      if (btn) { btn.textContent = 'âœ“ Saved'; setTimeout(() => { if (btn) { btn.textContent = 'Save'; } }, 2000); }
      // Refresh agents after a tick
      setTimeout(fetchAgents, 300);
    } else {
      if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
    }
  } catch {
    if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
  }
}

// Initial load + poll every 10 seconds
fetchAgents();
setInterval(fetchAgents, 10 * 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS â€” Project-based Kanban
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Project config (source of truth â€” add new projects here) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROJECTS_CONFIG = [
  { id:'balboa',   name:'Balboa',             group:'jobs', icon:'ðŸ ' },
  { id:'teresita', name:'Teresita',            group:'jobs', icon:'ðŸ ' },
  { id:'25th-ave', name:'25th Ave',            group:'jobs', icon:'ðŸ ' },
  { id:'mc-dev',   name:'Mission Control Dev', group:'dev',  icon:'ðŸ’»' },
  { id:'hytale',   name:'Hytale Mod',          group:'dev',  icon:'ðŸŽ®' },
];

// User-added projects stored in localStorage
function getCustomProjects() {
  try { return JSON.parse(localStorage.getItem('mc_projects') || '[]'); } catch { return []; }
}
function saveCustomProjects(list) { localStorage.setItem('mc_projects', JSON.stringify(list)); }

function allProjects() {
  return [...PROJECTS_CONFIG, ...getCustomProjects()];
}

function projectByName(name) {
  return allProjects().find(p => p.name === name) || null;
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allTasks    = [];
let taskView    = 'kanban';
let selProject  = null;    // null=All, '__jobs__', '__dev__', '__org__', or project id
let tasksLoaded = false;

const PRI_ORDER = { Urgent:0, High:1, Medium:2, Low:3 };
function priClass(p) {
  return { Urgent:'pri-urgent', High:'pri-high', Medium:'pri-medium', Low:'pri-low' }[p] || 'pri-low';
}
function fmtDateShort(d) {
  if (!d) return '';
  const [,m,day] = d.split('-');
  return `${parseInt(m)}/${parseInt(day)}`;
}

// â”€â”€ Project switcher rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProjectSwitcher() {
  const projs = allProjects();
  const jobs  = projs.filter(p => p.group === 'jobs');
  const devs  = projs.filter(p => p.group === 'dev');
  const orgs  = projs.filter(p => p.group === 'org' || p.group === 'other');

  function pill(id, label, extraClass='') {
    const active = selProject === id ? 'active' : '';
    return `<button class="proj-pill ${extraClass} ${active}" onclick="selectProject('${id}')">${label}</button>`;
  }

  let html = pill(null, 'ðŸ—‚ï¸ All');
  html += '<div class="proj-sep"></div>';
  html += pill('__jobs__', 'ðŸ—ï¸ Jobs', 'group');
  jobs.forEach(p => { html += pill(p.id, p.name); });
  if (devs.length || orgs.filter(p=>p.group==='dev').length) {
    html += '<div class="proj-sep"></div>';
    html += pill('__dev__', 'ðŸ’» Dev', 'group');
    devs.forEach(p => { html += pill(p.id, p.name); });
  }
  html += '<div class="proj-sep"></div>';
  html += pill('__org__', 'ðŸ¢ Org', 'group');
  orgs.filter(p => p.group === 'org').forEach(p => { html += pill(p.id, p.name); });
  html += '<div class="proj-sep"></div>';
  html += `<button class="proj-add" onclick="openNewProject()">+ New Project</button>`;

  document.getElementById('project-switcher').innerHTML = html;
}

function selectProject(id) {
  selProject = id === 'null' || id === null ? null : id;
  renderProjectSwitcher();
  renderTasks();
}

// â”€â”€ Task filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterByProject(tasks) {
  if (selProject === null) return tasks;
  if (selProject === '__jobs__') {
    const jobNames = allProjects().filter(p => p.group === 'jobs').map(p => p.name);
    return tasks.filter(t => jobNames.includes(t.job));
  }
  if (selProject === '__dev__') {
    const devNames = allProjects().filter(p => p.group === 'dev').map(p => p.name);
    return tasks.filter(t => devNames.includes(t.job));
  }
  if (selProject === '__org__') {
    const nonOrgNames = allProjects().filter(p => p.group !== 'org').map(p => p.name);
    return tasks.filter(t => !t.job || !nonOrgNames.includes(t.job));
  }
  // Specific project id
  const proj = allProjects().find(p => p.id === selProject);
  if (!proj) return tasks;
  return tasks.filter(t => t.job === proj.name);
}

// â”€â”€ Main render dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasks() {
  const content = document.getElementById('tasks-content');
  if (!content) return;

  const filtered = filterByProject(allTasks);

  // Jobs group â†’ multi-board
  if (selProject === '__jobs__') {
    renderMultiBoard(filtered, content);
    return;
  }

  if (taskView === 'kanban') {
    content.innerHTML = `<div class="kanban-board" id="tasks-kanban"></div>`;
    renderKanban(filtered, document.getElementById('tasks-kanban'));
  } else {
    content.innerHTML = `<div id="tasks-list"></div>`;
    renderList(filtered, document.getElementById('tasks-list'));
  }
}

function setTaskView(view) {
  taskView = view;
  document.getElementById('view-kanban-btn').classList.toggle('active', view === 'kanban');
  document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
  renderTasks();
}

// â”€â”€ Kanban â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NEXT_STATUS = {
  'To Do':       [{ label:'â–¶ Start', status:'In Progress' }, { label:'âœ— Block', status:'Blocked' }],
  'In Progress': [{ label:'âœ“ Done',  status:'Done'        }, { label:'âœ— Block', status:'Blocked' }],
  'Blocked':     [{ label:'â–¶ Resume',status:'In Progress' }, { label:'âœ“ Done',  status:'Done' }],
  'Done':        [{ label:'â†© Reopen',status:'To Do'       }],
};

function renderKanban(tasks, container) {
  const cols = {
    'To Do':       { key:'col-todo',     label:'To Do',       cards:[] },
    'In Progress': { key:'col-progress', label:'In Progress', cards:[] },
    'Blocked':     { key:'col-blocked',  label:'Blocked',     cards:[] },
    'Done':        { key:'col-done',     label:'Done',        cards:[] },
  };
  tasks.forEach(t => { if (cols[t.status]) cols[t.status].cards.push(t); });

  container.innerHTML = Object.values(cols).map(col => {
    const cards = col.cards
      .sort((a,b) => (PRI_ORDER[a.priority]??3) - (PRI_ORDER[b.priority]??3))
      .map(t => buildCard(t, false)).join('');

    const addBtn = col.key !== 'col-done'
      ? `<div class="inline-add" onclick="openAddTask({status:'${col.label}'})"><span>+</span> Add</div>`
      : '';

    return `<div class="kanban-col ${col.key} kanban-drop-zone"
        data-status="${col.label}"
        ondragover="onColDragOver(event)" ondragenter="onColDragEnter(event)"
        ondragleave="onColDragLeave(event)" ondrop="onColDrop(event)">
      <div class="kanban-col-header">
        <span>${col.label}</span>
        <span class="kanban-count">${col.cards.length}</span>
      </div>
      ${cards}${addBtn}
    </div>`;
  }).join('');
}

/** Returns true if the task has a due date in the past and isn't Done */
function isTaskOverdue(t) {
  if (!t.dueDate || t.status === 'Done') return false;
  // en-CA locale gives YYYY-MM-DD in LOCAL time (not UTC), safe to compare directly
  const today = new Date().toLocaleDateString('en-CA');
  return t.dueDate < today;
}

function buildCard(t, mini) {
  const proj = projectByName(t.job);
  const showProject = (selProject === null || selProject === '__jobs__' || selProject === '__dev__') && t.job;
  const overdue = isTaskOverdue(t);
  const nextBtns = !mini ? (NEXT_STATUS[t.status] || [])
    .map(n => `<button class="status-btn" onclick="event.stopPropagation();quickComplete('${t.id}','${n.status}')">${n.label}</button>`)
    .join('') : '';

  if (mini) {
    return `<div class="mini-card${overdue ? ' task-overdue' : ''}" draggable="true"
        data-task-id="${t.id}" data-status="${escHtml(t.status)}"
        ondragstart="onCardDragStart(event)" ondragend="onCardDragEnd(event)"
        onclick="openEditTask('${t.id}')">
      ${escHtml(t.name)}
      <div class="mini-card-meta">
        <span class="badge pri-badge ${priClass(t.priority)}" style="font-size:0.58rem">${t.priority}</span>
        ${t.assignee ? `<span style="font-size:0.62rem;color:var(--muted)">${t.assignee}</span>` : ''}
        ${overdue ? `<span style="font-size:0.6rem;color:var(--red)">âš  overdue</span>` : ''}
      </div>
    </div>`;
  }

  const dueDateEl = t.dueDate
    ? `<span class="task-card-tag${overdue ? ' due-overdue' : ''}">${overdue ? '<span class="overdue-pip"></span>' : 'ðŸ“… '}${fmtDateShort(t.dueDate)}</span>`
    : '';

  return `<div class="task-card${overdue ? ' task-overdue' : ''}" draggable="true" data-task-id="${t.id}" data-status="${escHtml(t.status)}"
      ondragstart="onCardDragStart(event)" ondragend="onCardDragEnd(event)">
    <div class="task-card-name" onclick="openEditTask('${t.id}')">${escHtml(t.name)}</div>
    <div class="task-card-meta">
      <span class="badge pri-badge ${priClass(t.priority)}">${t.priority}</span>
      ${showProject ? `<span class="task-card-tag">${proj ? proj.icon : 'ðŸ“Œ'} ${escHtml(t.job)}</span>` : ''}
      ${t.assignee ? `<span class="task-card-tag">ðŸ‘¤ ${t.assignee}</span>` : ''}
      ${dueDateEl}
    </div>
    ${nextBtns ? `<div class="task-card-actions">${nextBtns}</div>` : ''}
  </div>`;
}

// â”€â”€ Multi-board (Jobs group) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMultiBoard(tasks, container) {
  const jobs = allProjects().filter(p => p.group === 'jobs');
  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No job projects configured.</div>';
    return;
  }

  container.innerHTML = `<div class="multi-board">${jobs.map(proj => {
    const jobTasks = tasks.filter(t => t.job === proj.name);
    const statuses = ['To Do','In Progress','Blocked','Done'];
    const colKeys  = ['col-todo','col-progress','col-blocked','col-done'];
    const cols = statuses.map((s, i) => {
      const cards = jobTasks.filter(t => t.status === s);
      return `<div class="mini-col ${colKeys[i]} kanban-drop-zone" data-status="${s}"
            ondragover="onColDragOver(event)" ondragenter="onColDragEnter(event)"
            ondragleave="onColDragLeave(event)" ondrop="onColDrop(event)">
          <div class="mini-col-header">
            <span>${s}</span>
            <span class="kanban-count">${cards.length || ''}</span>
          </div>
          ${cards.map(t => buildCard(t, true)).join('') || `<div class="mini-empty">Empty</div>`}
        </div>`;
    }).join('');
    return `<div class="mini-board">
      <div class="mini-board-header">
        <span class="mini-board-title">${proj.icon} ${escHtml(proj.name)}</span>
        <button class="mini-board-add" onclick="openAddTask({project:'${proj.id}'})">+ Add task</button>
      </div>
      <div class="mini-kanban">${cols}</div>
    </div>`;
  }).join('')}</div>`;
}

// â”€â”€ List view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList(tasks, container) {
  const groups = {};
  tasks.forEach(t => {
    const key = t.job || 'ðŸ¢ Org';
    if (!groups[key]) groups[key] = [];
    groups[key].push(t);
  });

  const sortedKeys = Object.keys(groups).sort((a,b) => {
    if (a === 'ðŸ¢ Org') return -1;
    if (b === 'ðŸ¢ Org') return 1;
    return a.localeCompare(b);
  });

  container.innerHTML = sortedKeys.map(key => {
    const sorted = groups[key].sort((a,b) => (PRI_ORDER[a.priority]??3) - (PRI_ORDER[b.priority]??3));
    const rows = sorted.map(t => {
      const done = t.status === 'Done';
      const overdue = isTaskOverdue(t);
      const dueMeta = t.dueDate
        ? `<span style="font-size:0.72rem;color:${overdue ? 'var(--red)' : 'var(--muted)'}">${overdue ? 'âš  ' : 'ðŸ“… '}${fmtDateShort(t.dueDate)}</span>`
        : '';
      return `<div class="task-row" onclick="openEditTask('${t.id}')">
        <div class="task-row-check ${done?'done':''}" onclick="event.stopPropagation();quickComplete('${t.id}','${done?'To Do':'Done'}')">${done?'âœ“':''}</div>
        <div class="task-row-name ${done?'done-text':''}">${escHtml(t.name)}</div>
        <div class="task-row-right">
          <span class="badge pri-badge ${priClass(t.priority)}">${t.priority}</span>
          ${t.assignee ? `<span style="font-size:0.72rem;color:var(--muted)">${t.assignee}</span>` : ''}
          ${dueMeta}
        </div>
      </div>`;
    }).join('');
    const proj = projectByName(key);
    return `<div class="tasks-list-group">
      <div class="tasks-list-group-header">${proj ? proj.icon + ' ' : ''}${key}</div>
      ${rows}
    </div>`;
  }).join('') || '<div class="state-loading">No tasks found.</div>';
}

// â”€â”€ Drag and drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragTaskId = null;
function onCardDragStart(e) {
  _dragTaskId = e.currentTarget.dataset.taskId;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _dragTaskId);
}
function onCardDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.kanban-col,.mini-col').forEach(c => c.classList.remove('drag-over'));
  _dragTaskId = null;
}
function onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function onColDragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function onColDragLeave(e) { if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over'); }
function onColDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const taskId = e.dataTransfer.getData('text/plain') || _dragTaskId;
  const newStatus = e.currentTarget.dataset.status;
  if (taskId && newStatus) quickComplete(taskId, newStatus);
}

// â”€â”€ Fetch + quick complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTasks() {
  try {
    const res = await fetch('/api/tasks', { headers: authHeaders() });
    const data = await res.json();
    if (data.tasks) {
      allTasks = data.tasks;
      tasksLoaded = true;
      renderProjectSwitcher();
      renderTasks();
    }
  } catch (err) {
    if (!tasksLoaded) {
      const c = document.getElementById('tasks-content');
      if (c) c.innerHTML = `<div class="state-error">Failed to load tasks: ${err.message}</div>`;
    }
  }
}
setInterval(fetchTasks, 30 * 1000);

async function quickComplete(id, newStatus) {
  const t = allTasks.find(x => x.id === id);
  if (t) t.status = newStatus;
  renderTasks();
  try {
    await fetch(`/api/tasks?id=${id}`, {
      method: 'PATCH',
      headers: authHeaders(true),
      body: JSON.stringify({ status: newStatus }),
    });
  } catch {}
}

// â”€â”€ Add / Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editTaskId = null;

function populateProjectDropdown(selectedName) {
  const sel = document.getElementById('t-project');
  if (!sel) return;
  const projs = allProjects();
  sel.innerHTML = `<option value="">â€” None (Org) â€”</option>` +
    projs.map(p => `<option value="${escHtml(p.name)}" ${selectedName===p.name?'selected':''}>${p.icon} ${escHtml(p.name)}</option>`).join('');
}

function openAddTask(preset = {}) {
  _editTaskId = null;
  document.querySelector('#add-task-modal .modal-title').textContent = 'New Task';
  document.getElementById('add-task-submit-btn').textContent = 'Add Task';
  document.getElementById('add-task-submit-btn').onclick = submitAddTask;
  document.getElementById('add-task-delete-btn').style.display = 'none';

  document.getElementById('t-name').value     = preset.name     || '';
  document.getElementById('t-desc').value     = preset.desc     || '';
  document.getElementById('t-status').value   = preset.status   || 'To Do';
  document.getElementById('t-priority').value = preset.priority || 'Medium';
  document.getElementById('t-assignee').value = preset.assignee || '';
  document.getElementById('t-due').value      = preset.dueDate  || '';

  // Auto-fill project from current selection or preset
  let projName = preset.project
    ? (allProjects().find(p => p.id === preset.project)?.name || '')
    : (selProject && selProject !== '__jobs__' && selProject !== '__dev__' && selProject !== '__org__'
        ? (allProjects().find(p => p.id === selProject)?.name || '') : '');
  populateProjectDropdown(projName);

  document.getElementById('add-task-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('t-name').focus(), 80);
}

function closeAddTask() {
  _editTaskId = null;
  document.getElementById('add-task-modal').classList.add('hidden');
}

async function submitAddTask() {
  const name = document.getElementById('t-name').value.trim();
  if (!name) { document.getElementById('t-name').focus(); return; }
  const btn = document.getElementById('add-task-submit-btn');
  btn.disabled = true; btn.textContent = 'Addingâ€¦';
  const job = document.getElementById('t-project').value;
  try {
    const res = await fetch('/api/tasks', {
      method: 'POST',
      headers: authHeaders(true),
      body: JSON.stringify({
        name, description: document.getElementById('t-desc').value.trim(),
        status:   document.getElementById('t-status').value,
        priority: document.getElementById('t-priority').value,
        assignee: document.getElementById('t-assignee').value || null,
        dueDate:  document.getElementById('t-due').value || null,
        job: job || null,
        level: job ? 'Job' : 'Org',
      }),
    });
    const data = await res.json();
    if (data.ok) { closeAddTask(); fetchTasks(); }
    else { btn.disabled = false; btn.textContent = 'Error â€” retry'; }
  } catch { btn.disabled = false; btn.textContent = 'Error â€” retry'; }
}

function openEditTask(id) {
  const t = allTasks.find(x => x.id === id);
  if (!t) return;
  _editTaskId = id;
  document.querySelector('#add-task-modal .modal-title').textContent = 'Edit Task';
  document.getElementById('add-task-submit-btn').textContent = 'Save Changes';
  document.getElementById('add-task-submit-btn').onclick = submitEditTask;
  document.getElementById('add-task-delete-btn').style.display = 'block';
  document.getElementById('t-name').value     = t.name || '';
  document.getElementById('t-desc').value     = t.description || '';
  document.getElementById('t-status').value   = t.status || 'To Do';
  document.getElementById('t-priority').value = t.priority || 'Medium';
  document.getElementById('t-assignee').value = t.assignee || '';
  document.getElementById('t-due').value      = t.dueDate || '';
  populateProjectDropdown(t.job || '');
  document.getElementById('add-task-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('t-name').focus(), 80);
}

async function submitEditTask() {
  if (!_editTaskId) return;
  const btn = document.getElementById('add-task-submit-btn');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';
  const job = document.getElementById('t-project').value;
  try {
    const res = await fetch(`/api/tasks?id=${_editTaskId}`, {
      method: 'PATCH',
      headers: authHeaders(true),
      body: JSON.stringify({
        name:        document.getElementById('t-name').value.trim(),
        description: document.getElementById('t-desc').value.trim(),
        status:      document.getElementById('t-status').value,
        priority:    document.getElementById('t-priority').value,
        assignee:    document.getElementById('t-assignee').value || null,
        dueDate:     document.getElementById('t-due').value || null,
        job: job || null,
        level: job ? 'Job' : 'Org',
      }),
    });
    const data = await res.json();
    if (data.ok) { closeAddTask(); fetchTasks(); }
    else { btn.disabled = false; btn.textContent = 'Error'; }
  } catch { btn.disabled = false; btn.textContent = 'Error'; }
}

async function deleteCurrentTask() {
  if (!_editTaskId || !confirm('Delete this task?')) return;
  try {
    await fetch(`/api/tasks?id=${_editTaskId}`, {
      method: 'DELETE',
      headers: authHeaders(),
    });
    closeAddTask(); fetchTasks();
  } catch {}
}

// â”€â”€ New Project modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewProject() {
  document.getElementById('np-name').value = '';
  document.getElementById('np-type').value = 'jobs';
  document.getElementById('new-project-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('np-name').focus(), 80);
}
function closeNewProject() { document.getElementById('new-project-modal').classList.add('hidden'); }
function submitNewProject() {
  const name = document.getElementById('np-name').value.trim();
  const type = document.getElementById('np-type').value;
  if (!name) { document.getElementById('np-name').focus(); return; }
  const icons = { jobs:'ðŸ ', dev:'ðŸ’»', org:'ðŸ¢', other:'ðŸ“Œ' };
  const custom = getCustomProjects();
  const id = name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if (!custom.find(p => p.id === id)) {
    custom.push({ id, name, group: type === 'org' || type === 'other' ? type : type, icon: icons[type] || 'ðŸ“Œ' });
    saveCustomProjects(custom);
  }
  closeNewProject();
  renderProjectSwitcher();
}

// Close modals on overlay click + Escape
['add-task-modal','new-project-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => { if (e.target.id === id) document.getElementById(id).classList.add('hidden'); });
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('add-task-modal').classList.add('hidden');
    document.getElementById('new-project-modal').classList.add('hidden');
    document.getElementById('contact-modal').classList.add('hidden');
    _editContactId = null;
    // Estimating modals
    closeNewOrderModal();
    closeNewJobModal();
  }
});

// Fetch tasks on load
fetchTasks();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTACTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let allContacts = [];
let contactFilter = '';
let contactSearchTerm = '';
let _editContactId = null;
let _searchTimer = null;

const TYPE_COLORS = {
  client:'type-client', subcontractor:'type-subcontractor',
  vendor:'type-vendor', personal:'type-personal', professional:'type-professional',
  trade_partner:'type-vendor', lead:'type-professional',
};

function initials(c) {
  const f = c.first_name?.[0] || '';
  const l = c.last_name?.[0]  || '';
  return (f + l).toUpperCase() || (c.company?.[0] || '?').toUpperCase();
}

function copyField(text) {
  navigator.clipboard.writeText(text).then(() => showCopyToast());
}

function showCopyToast(msg) {
  let toast = document.getElementById('copy-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'copy-toast';
    document.body.appendChild(toast);
  }
  toast.textContent = msg || 'Copied!';
  toast.classList.remove('show');
  void toast.offsetWidth;
  toast.classList.add('show');
}

function renderContacts(contacts) {
  const list  = document.getElementById('contacts-list');
  const count = document.getElementById('contacts-count');
  if (!contacts.length) {
    list.innerHTML = '<div class="contact-empty">No contacts found.</div>';
    count.textContent = '';
    return;
  }
  count.textContent = `${contacts.length} contact${contacts.length !== 1 ? 's' : ''}`;

  list.innerHTML = contacts.map(c => {
    const name    = [c.first_name, c.last_name].filter(Boolean).join(' ') || c.company || '(unnamed)';
    const sub     = [c.company, c.title].filter(Boolean).join(' Â· ');
    const types   = (c.types || []).map(t => `<span class="contact-badge ${TYPE_COLORS[t]||''}">${t}</span>`).join('');
    const trades  = (c.trades || []).map(t => `<span class="contact-badge">${t}</span>`).join('');

    const fields = [];
    if (c.phone)    fields.push({ label:'Phone',   value:`<a href="tel:${c.phone}">${c.phone}</a>`, copy: c.phone });
    if (c.phone_alt)fields.push({ label:'Phone 2', value:`<a href="tel:${c.phone_alt}">${c.phone_alt}</a>`, copy: c.phone_alt });
    if (c.email)    fields.push({ label:'Email',   value:`<a href="mailto:${c.email}">${c.email}</a>`, copy: c.email });
    if (c.company)  fields.push({ label:'Company', value:escHtml(c.company), copy: c.company });
    if (c.address)  fields.push({ label:'Address', value:escHtml([c.address,c.city,c.state,c.zip].filter(Boolean).join(', ')), copy:[c.address,c.city,c.state,c.zip].filter(Boolean).join(', ') });
    if (c.license_number) fields.push({ label:'License', value:escHtml(c.license_number) + (c.license_expiry?` <span style="color:var(--muted);font-size:0.7rem">exp ${c.license_expiry.slice(0,10)}</span>`:''), copy: c.license_number });
    if (c.coi_expiry) fields.push({ label:'COI Exp', value:c.coi_expiry.slice(0,10), copy: c.coi_expiry.slice(0,10) });
    if (c.rating)   fields.push({ label:'Rating',  value:'â˜…'.repeat(c.rating)+'â˜†'.repeat(5-c.rating), copy: String(c.rating) });
    if (c.notes)    fields.push({ label:'Notes',   value:`<span style="color:var(--muted)">${escHtml(c.notes)}</span>`, copy: c.notes });

    const fieldRows = fields.map(f => `
      <div class="contact-field">
        <span class="contact-field-label">${f.label}</span>
        <span class="contact-field-value">${f.value}${f.copy ? ` <button class="copy-btn" onclick="copyField(${JSON.stringify(f.copy)})">COPY</button>` : ''}</span>
      </div>`).join('');

    return `<div class="contact-card" id="cc-${c.id}">
      <div class="contact-card-header" onclick="toggleContact('${c.id}')">
        <div class="contact-avatar">${escHtml(initials(c))}</div>
        <div style="flex:1;min-width:0">
          <div class="contact-card-name">${escHtml(name)}</div>
          ${sub ? `<div class="contact-card-sub">${escHtml(sub)}</div>` : ''}
          <div class="contact-card-badges">${types}${trades}</div>
        </div>
        ${c.phone ? `<a href="tel:${c.phone}" onclick="event.stopPropagation()" style="font-size:1.1rem;text-decoration:none" title="${c.phone}">ðŸ“ž</a>` : ''}
      </div>
      <div class="contact-expand" id="cx-${c.id}">
        ${fieldRows}
        <div class="contact-expand-actions">
          <button class="btn" style="font-size:0.75rem;padding:0.3rem 0.75rem" onclick="openEditContact('${c.id}')">Edit</button>
          ${c.email ? `<a href="mailto:${c.email}" class="btn-cancel" style="font-size:0.75rem;text-decoration:none">âœ‰ï¸ Email</a>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleContact(id) {
  const el = document.getElementById(`cx-${id}`);
  if (!el) return;
  const isOpen = el.classList.contains('open');
  document.querySelectorAll('.contact-expand.open').forEach(e => e.classList.remove('open'));
  if (!isOpen) el.classList.add('open');
}

async function fetchContacts(search = '', type = '') {
  try {
    const params = new URLSearchParams({ limit: 500 });
    if (search) params.set('search', search);
    if (type)   params.set('type', type);
    const res = await fetch(`/api/contacts?${params}`, { headers: authHeaders() });
    const data = await res.json();
    allContacts = data.contacts || [];
    renderContacts(allContacts);
  } catch (err) {
    document.getElementById('contacts-list').innerHTML = `<div class="state-error">Failed to load: ${err.message}</div>`;
  }
}

function setContactFilter(type, btn) {
  contactFilter = type;
  document.querySelectorAll('.contacts-type-pills .pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  fetchContacts(contactSearchTerm, contactFilter);
}

function debounceContactSearch() {
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(() => {
    contactSearchTerm = document.getElementById('contacts-search').value.trim();
    fetchContacts(contactSearchTerm, contactFilter);
  }, 300);
}

// â”€â”€ Add/Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddContact() {
  _editContactId = null;
  document.getElementById('contact-modal-title').textContent = 'New Contact';
  document.getElementById('cm-submit-btn').textContent = 'Add Contact';
  document.getElementById('cm-delete-btn').style.display = 'none';
  ['first','last','phone','email','company','title','types','trades','rating','source','notes'].forEach(f => {
    const el = document.getElementById(`cm-${f}`);
    if (el) el.value = '';
  });
  document.getElementById('cm-verified').checked = false;
  document.getElementById('contact-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('cm-first').focus(), 80);
}

function openEditContact(id) {
  const c = allContacts.find(x => x.id === id);
  if (!c) return;
  _editContactId = id;
  document.getElementById('contact-modal-title').textContent = 'Edit Contact';
  document.getElementById('cm-submit-btn').textContent = 'Save Changes';
  document.getElementById('cm-delete-btn').style.display = 'block';
  document.getElementById('cm-first').value   = c.first_name || '';
  document.getElementById('cm-last').value    = c.last_name  || '';
  document.getElementById('cm-phone').value   = c.phone      || '';
  document.getElementById('cm-email').value   = c.email      || '';
  document.getElementById('cm-company').value = c.company    || '';
  document.getElementById('cm-title').value   = c.title      || '';
  document.getElementById('cm-types').value   = (c.types  || []).join(', ');
  document.getElementById('cm-trades').value  = (c.trades || []).join(', ');
  document.getElementById('cm-rating').value  = c.rating     || '';
  document.getElementById('cm-source').value  = c.source     || '';
  document.getElementById('cm-notes').value   = c.notes      || '';
  document.getElementById('cm-verified').checked = !!c.is_verified;
  document.getElementById('contact-modal').classList.remove('hidden');
}

function closeContactModal() {
  _editContactId = null;
  document.getElementById('contact-modal').classList.add('hidden');
}

function parseTags(str) {
  return str.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
}

async function submitContactModal() {
  const btn = document.getElementById('cm-submit-btn');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';
  const body = {
    first_name:   document.getElementById('cm-first').value.trim()   || null,
    last_name:    document.getElementById('cm-last').value.trim()    || null,
    phone:        document.getElementById('cm-phone').value.trim()   || null,
    email:        document.getElementById('cm-email').value.trim()   || null,
    company:      document.getElementById('cm-company').value.trim() || null,
    title:        document.getElementById('cm-title').value.trim()   || null,
    types:        parseTags(document.getElementById('cm-types').value),
    trades:       parseTags(document.getElementById('cm-trades').value),
    rating:       parseInt(document.getElementById('cm-rating').value) || null,
    source:       document.getElementById('cm-source').value.trim()  || null,
    notes:        document.getElementById('cm-notes').value.trim()   || null,
    is_verified:  document.getElementById('cm-verified').checked,
  };
  try {
    const method = _editContactId ? 'PATCH' : 'POST';
    const url    = _editContactId ? `/api/contacts?id=${_editContactId}` : '/api/contacts';
    const res = await fetch(url, {
      method,
      headers: authHeaders(true),
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.ok) { closeContactModal(); fetchContacts(contactSearchTerm, contactFilter); }
    else { btn.disabled = false; btn.textContent = 'Error â€” retry'; }
  } catch { btn.disabled = false; btn.textContent = 'Error â€” retry'; }
}

async function deleteCurrentContact() {
  if (!_editContactId || !confirm('Archive this contact?')) return;
  await fetch(`/api/contacts?id=${_editContactId}`, {
    method: 'DELETE',
    headers: authHeaders(),
  });
  closeContactModal();
  fetchContacts(contactSearchTerm, contactFilter);
}

// Close on overlay click / Escape
document.getElementById('contact-modal').addEventListener('click', e => {
  if (e.target.id === 'contact-modal') closeContactModal();
});

// Contacts load triggered by showTab above

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLIT TRANSACTION MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let splitTxId = null; // id of transaction being split

/**
 * Open the split modal for a given transaction.
 * Pre-populates with 2 rows â€” first carrying the full amount.
 */
function openSplitModal(txId) {
  const tx = inboxTxAll.find(t => t.id === txId);
  if (!tx) return;
  splitTxId = txId;

  const amount   = Number(tx.amount) || 0;
  const merchant = tx.merchant || tx.description || 'â€”';
  const dateStr  = fmtDate(tx.date);
  const amtFmt   = (amount < 0 ? '-' : '') + fmtCurrency(Math.abs(amount));

  // Header info line
  document.getElementById('split-modal-info').innerHTML =
    `<strong>${escHtml(merchant)}</strong> &nbsp;Â·&nbsp; ${dateStr}` +
    ` &nbsp;Â·&nbsp; <span style="color:var(--accent);font-weight:700">${amtFmt}</span>` +
    `<br><span style="font-size:0.76rem">Divide this amount across 2 or more jobs. Amounts must add up exactly.</span>`;

  // Build 2 empty rows
  const container = document.getElementById('split-rows-container');
  container.innerHTML = '';
  _appendSplitRow();
  _appendSplitRow();

  // Pre-fill first row with the full amount so the user just picks a job
  const firstAmt = document.getElementById('split-amt-0');
  if (firstAmt) firstAmt.value = Math.abs(amount).toFixed(2);

  updateSplitRemaining();
  document.getElementById('split-modal').classList.remove('hidden');

  // Focus first job select
  const firstSel = document.getElementById('split-job-0');
  if (firstSel) setTimeout(() => firstSel.focus(), 50);
}

/** Build and append a new split row into the container. */
function _appendSplitRow() {
  const container = document.getElementById('split-rows-container');
  const idx       = container.querySelectorAll('.split-row').length;

  // Job options
  const jobOpts = `<option value="">â€” No Job â€”</option>` +
    inboxJobs.map(j =>
      `<option value="${escHtml(j.id)}">${escHtml(j.name)}</option>`
    ).join('');

  // Cost code options grouped by category
  const CC_CATEGORY_ORDER = [
    'General', 'Preconstruction', 'Site Work', 'Structure & Envelope',
    'MEP', 'Finishes', 'Fixtures & Features', 'Exterior',
  ];
  const ccByCategory = {};
  inboxCostCodes.forEach(cc => {
    if (!ccByCategory[cc.category]) ccByCategory[cc.category] = [];
    ccByCategory[cc.category].push(cc);
  });
  const sortedCats = [
    ...CC_CATEGORY_ORDER.filter(c => ccByCategory[c]),
    ...Object.keys(ccByCategory).filter(c => !CC_CATEGORY_ORDER.includes(c)),
  ];
  const ccOpts = `<option value="">â€” No Code â€”</option>` +
    sortedCats.map(cat => {
      const codes = ccByCategory[cat];
      return `<optgroup label="${escHtml(cat)}">${
        codes.map(cc =>
          `<option value="${escHtml(cc.id)}">${cc.number} Â· ${escHtml(cc.name)}</option>`
        ).join('')
      }</optgroup>`;
    }).join('');

  const row = document.createElement('div');
  row.className = 'split-row';
  row.dataset.idx = idx;
  row.innerHTML = `
    <div>
      <div class="split-row-label">Split ${idx + 1} â€” Job</div>
      <select id="split-job-${idx}">${jobOpts}</select>
    </div>
    <div>
      <div class="split-row-label">Cost Code</div>
      <select id="split-cc-${idx}">${ccOpts}</select>
    </div>
    <div>
      <div class="split-row-label">Amount ($)</div>
      <input type="number" class="split-amount" id="split-amt-${idx}"
        min="0.01" step="0.01" placeholder="0.00"
        oninput="updateSplitRemaining()">
    </div>
    <button class="btn-split-remove" title="Remove row"
      onclick="removeSplitRow(${idx})">âœ•</button>
  `;
  container.appendChild(row);
  _refreshRemoveButtons();
}

/** Add a new split row (triggered by "+ Add another split" button). */
function addSplitRow() {
  _appendSplitRow();
  updateSplitRemaining();
  // Focus the new row's job select
  const rows = document.querySelectorAll('#split-rows-container .split-row');
  const lastRow = rows[rows.length - 1];
  if (lastRow) {
    const sel = lastRow.querySelector('select');
    if (sel) setTimeout(() => sel.focus(), 30);
  }
}

/** Remove a split row by index, preserving the other rows' values. */
function removeSplitRow(targetIdx) {
  const container = document.getElementById('split-rows-container');
  const rows = container.querySelectorAll('.split-row');
  if (rows.length <= 2) return; // enforce minimum 2 splits

  // Capture current values of all rows except the removed one
  const saved = [];
  rows.forEach((_, i) => {
    if (i === targetIdx) return;
    saved.push({
      job_id:       document.getElementById(`split-job-${i}`)?.value || '',
      cost_code_id: document.getElementById(`split-cc-${i}`)?.value  || '',
      amount:       document.getElementById(`split-amt-${i}`)?.value  || '',
    });
  });

  // Rebuild rows with saved values
  container.innerHTML = '';
  saved.forEach(v => {
    _appendSplitRow();
    const i = container.querySelectorAll('.split-row').length - 1;
    const jobSel  = document.getElementById(`split-job-${i}`);
    const ccSel   = document.getElementById(`split-cc-${i}`);
    const amtInp  = document.getElementById(`split-amt-${i}`);
    const label   = container.querySelectorAll('.split-row')[i]?.querySelector('.split-row-label');
    if (jobSel)  jobSel.value  = v.job_id;
    if (ccSel)   ccSel.value   = v.cost_code_id;
    if (amtInp)  amtInp.value  = v.amount;
    if (label)   label.textContent = `Split ${i + 1} â€” Job`;
  });

  updateSplitRemaining();
}

/** Disable remove buttons when only 2 rows remain. */
function _refreshRemoveButtons() {
  const container = document.getElementById('split-rows-container');
  if (!container) return;
  const rows = container.querySelectorAll('.split-row');
  rows.forEach(row => {
    const btn = row.querySelector('.btn-split-remove');
    if (btn) btn.disabled = rows.length <= 2;
  });
}

/** Recalculate remaining amount and update the balance bar + confirm button. */
function updateSplitRemaining() {
  const tx = inboxTxAll.find(t => t.id === splitTxId);
  if (!tx) return;

  const origAmount = Math.abs(Number(tx.amount) || 0);

  let total = 0;
  document.querySelectorAll('#split-rows-container .split-amount').forEach(inp => {
    total += parseFloat(inp.value || 0) || 0;
  });

  const remaining  = origAmount - total;
  const isBalanced = Math.abs(remaining) < 0.015;

  const bar     = document.getElementById('split-remaining-bar');
  const valEl   = document.getElementById('split-remaining-val');
  const confirm = document.getElementById('split-confirm-btn');

  bar.className = 'split-remaining-bar' +
    (isBalanced ? ' ok' : remaining < 0 ? ' over' : '');

  if (isBalanced) {
    valEl.textContent = 'âœ“ Balanced';
  } else if (remaining < 0) {
    valEl.textContent = `Over by ${fmtCurrency(Math.abs(remaining))}`;
  } else {
    valEl.textContent = `${fmtCurrency(remaining)} remaining`;
  }

  confirm.disabled = !isBalanced;
  _refreshRemoveButtons();
}

/** Close and reset the split modal. */
function closeSplitModal() {
  document.getElementById('split-modal').classList.add('hidden');
  splitTxId = null;
}

/** Collect rows, validate, and POST to /api/transactions/split. */
async function submitSplit() {
  const tx = inboxTxAll.find(t => t.id === splitTxId);
  if (!tx) return;

  const rows   = document.querySelectorAll('#split-rows-container .split-row');
  const splits = [];
  let valid    = true;

  rows.forEach((_, i) => {
    const jobId  = document.getElementById(`split-job-${i}`)?.value || '';
    const ccId   = document.getElementById(`split-cc-${i}`)?.value  || '';
    const amount = parseFloat(document.getElementById(`split-amt-${i}`)?.value || 0);
    if (!jobId || !ccId || !amount || amount <= 0) { valid = false; return; }
    splits.push({ job_id: jobId, cost_code_id: ccId, amount });
  });

  if (!valid || splits.length < 2) {
    alert('Each split must have a job, a cost code, and a positive amount.');
    return;
  }

  const confirmBtn = document.getElementById('split-confirm-btn');
  confirmBtn.disabled  = true;
  confirmBtn.textContent = 'Splittingâ€¦';

  try {
    const data = await apiPost('/api/transactions/split', {
      original_id: splitTxId,
      splits,
    });

    if (data?.ok) {
      const n = data.splits_created;
      const removedId = splitTxId; // capture before closeSplitModal() nulls it
      closeSplitModal();

      // Remove original from local list
      inboxTxAll = inboxTxAll.filter(t => t.id !== removedId);
      inboxUncodedCount = data.uncoded_count ?? Math.max(0, inboxUncodedCount - 1);
      updateInboxRemaining(inboxUncodedCount);

      const next = inboxTxAll.find(t => t.status === 'uncoded');
      inboxExpanded = null;
      renderInboxList(inboxTxAll);
      if (inboxFilter === 'uncoded' && next) expandTxCard(next.id);

      showCopyToast(`âœ‚ï¸ Split into ${n} transactions`);
    } else {
      alert('Failed to split: ' + (data?.error || 'Unknown error'));
      confirmBtn.disabled  = false;
      confirmBtn.textContent = 'Confirm Split';
    }
  } catch (err) {
    alert('Error: ' + err.message);
    confirmBtn.disabled  = false;
    confirmBtn.textContent = 'Confirm Split';
  }
}

// Close split modal on overlay click
document.getElementById('split-modal').addEventListener('click', e => {
  if (e.target.id === 'split-modal') closeSplitModal();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTIMATING SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let estJobs            = [];      // all Supabase jobs
let estSelectedJobId   = null;
let estOrders          = [];      // orders for selected job
let estExpandedOrders  = new Set(); // order IDs currently expanded
let estLineItems       = {};      // orderId â†’ array of line items
let estGroups          = {};      // orderId â†’ array of groups
let estEditingLineItem = null;    // { orderId, itemId } currently in edit mode
let estNewOrderJobId   = null;    // job_id for the new-order modal
let estEditOrderId     = null;    // order id when editing (null = create)
let estJobsLoaded      = false;
let estCostCodes       = [];      // shared cost codes list (loaded once per session)
let estCostCodesLoaded = false;
let estRenamingGroup   = null;    // groupId currently being renamed

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEstimating() {
  if (!estJobsLoaded) await fetchEstJobs();
  if (estSelectedJobId) await fetchEstOrders(estSelectedJobId);
}

async function fetchEstJobs() {
  try {
    const data = await apiFetch('/api/jobs?source=estimating');
    estJobs = data.jobs || [];
    estJobsLoaded = true;
    renderEstJobSelect();
  } catch (err) {
    console.error('estimate-jobs failed:', err);
  }
}

function renderEstJobSelect() {
  const sel = document.getElementById('est-job-select');
  if (!sel) return;
  sel.innerHTML = '<option value="">â€” Select a job â€”</option>' +
    estJobs.map(j => `<option value="${escHtml(j.id)}">${escHtml(j.name)}</option>`).join('');
  if (estSelectedJobId) sel.value = estSelectedJobId;
}

async function estSelectJob(jobId) {
  estSelectedJobId = jobId || null;
  const btn = document.getElementById('est-new-order-btn');
  if (btn) btn.disabled = !jobId;
  estExpandedOrders.clear();
  estLineItems = {};
  estGroups    = {};

  if (!jobId) {
    document.getElementById('est-metrics').style.display = 'none';
    document.getElementById('est-orders-area').innerHTML =
      `<div class="est-empty"><div class="est-empty-icon">ðŸ“‹</div><div>Select a job to see its estimates</div></div>`;
    return;
  }
  document.getElementById('est-metrics').style.display = 'grid';
  renderEstMetrics(null); // loading state
  document.getElementById('est-orders-area').innerHTML =
    '<div class="state-loading">Loading ordersâ€¦</div>';
  await fetchEstOrders(jobId);
}

async function fetchEstOrders(jobId) {
  try {
    const [ordersData, jobsData] = await Promise.all([
      apiFetch(`/api/orders?job_id=${jobId}`),
      apiFetch('/api/jobs?source=estimating'),
    ]);
    estOrders = ordersData.orders || [];
    estJobs   = jobsData.jobs    || [];
    const job = estJobs.find(j => j.id === jobId);
    renderEstMetrics(job);
    renderEstOrders();
  } catch (err) {
    document.getElementById('est-orders-area').innerHTML =
      `<div class="state-error">Failed to load: ${escHtml(err.message)}</div>`;
  }
}

// â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEstMetrics(job) {
  const cost        = Number(job?.totalEstimatedCost  ?? 0);
  const price       = Number(job?.totalEstimatedPrice ?? 0);
  const signedPrice = Number(job?.signedPrice         ?? 0);
  const orders      = Number(job?.orderCount          ?? 0);
  const signed      = Number(job?.signedOrderCount    ?? 0);
  const margin      = price > 0 ? Math.round(((price - cost) / price) * 100) : 0;

  document.getElementById('est-metric-cost').textContent     = job ? fmtCurrency(cost) : 'â€”';
  document.getElementById('est-metric-price').textContent    = job ? fmtCurrency(price) : 'â€”';
  document.getElementById('est-metric-margin-sub').textContent =
    job ? `${margin}% gross margin` : 'â€”';
  // Contract Value = sum of Signed order prices (spec: "approved orders only for contract total")
  document.getElementById('est-metric-contract').textContent = job ? fmtCurrency(signedPrice) : 'â€”';
  document.getElementById('est-metric-contract-sub').textContent =
    job ? (signed ? `${signed} signed order${signed !== 1 ? 's' : ''}` : 'no signed orders') : 'signed only';
  document.getElementById('est-metric-orders').textContent   = job ? orders : 'â€”';
  document.getElementById('est-metric-orders-sub').textContent =
    job ? `${signed} signed` : 'â€”';
}

// â”€â”€ Orders list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEstOrders() {
  const area = document.getElementById('est-orders-area');
  if (!estOrders.length) {
    area.innerHTML = `
      <div class="est-empty">
        <div class="est-empty-icon">ðŸ“„</div>
        <div>No orders yet for this job.</div>
        <div style="margin-top:0.5rem">
          <button class="btn" onclick="openNewOrderModal()" style="font-size:0.82rem">+ Create First Order</button>
        </div>
      </div>`;
    return;
  }
  area.innerHTML = `<div class="order-list">${estOrders.map(renderOrderCard).join('')}</div>`;

  // Re-expand previously expanded orders and reload their line items
  estExpandedOrders.forEach(orderId => {
    const body = document.getElementById(`order-body-${orderId}`);
    const card = document.getElementById(`order-card-${orderId}`);
    if (body) { body.classList.add('open'); card?.classList.add('expanded'); }
    if (estLineItems[orderId] && estGroups[orderId] !== undefined) renderLineItemsInOrder(orderId);
    else fetchLineItems(orderId);
  });
}

function orderStatusBadge(status, orderId) {
  const title = 'Click to change status';
  const click = orderId ? `onclick="event.stopPropagation();cycleOrderStatus('${escHtml(orderId)}')" title="${title}" style="cursor:pointer"` : '';
  if (status === 'Signed') return `<span class="badge badge-green" ${click}>âœ“ Signed</span>`;
  if (status === 'Sent')   return `<span class="badge badge-blue"  ${click}>â†’ Sent</span>`;
  return `<span class="badge badge-muted" ${click}>Draft</span>`;
}

// Cycle order status: Draft â†’ Sent â†’ Signed â†’ Draft
const STATUS_CYCLE = { 'Draft': 'Sent', 'Sent': 'Signed', 'Signed': 'Draft' };
async function cycleOrderStatus(orderId) {
  const order = estOrders.find(o => o.id === orderId);
  if (!order) return;
  const next = STATUS_CYCLE[order.status] || 'Draft';
  try {
    await apiPatch(`/api/orders?id=${orderId}`, { status: next });
    const idx = estOrders.findIndex(o => o.id === orderId);
    if (idx !== -1) estOrders[idx] = { ...estOrders[idx], status: next };
    await refreshOrderCard(orderId);
  } catch (err) {
    alert('Status update failed: ' + err.message);
  }
}

function renderOrderCard(order) {
  const isExpanded = estExpandedOrders.has(order.id);
  const itemWord   = order.lineItemCount === 1 ? 'item' : 'items';
  const margin     = order.totalPrice > 0
    ? Math.round(((order.totalPrice - order.totalCost) / order.totalPrice) * 100) : 0;

  return `
    <div class="order-card${order.status === 'Signed' ? ' order-signed' : order.status === 'Sent' ? ' order-sent' : ''}${isExpanded ? ' expanded' : ''}"
         id="order-card-${escHtml(order.id)}">
      <div class="order-card-header" onclick="toggleOrderExpand('${escHtml(order.id)}')">
        <div class="order-card-title">
          <div class="order-card-name">${escHtml(order.name)}</div>
          <div class="order-card-meta">${escHtml(order.type)} Â· ${order.lineItemCount} ${itemWord}</div>
        </div>
        ${orderStatusBadge(order.status, order.id)}
        <div class="order-card-totals">
          <div><span>Cost </span><strong>${fmtCurrency(order.totalCost)}</strong></div>
          <div class="order-price-highlight">${fmtCurrency(order.totalPrice)}</div>
          ${order.totalPrice > 0 ? `<div><span>${margin}% margin</span></div>` : ''}
        </div>
        <div class="order-header-actions" onclick="event.stopPropagation()">
          <button class="btn-icon" title="Edit order" onclick="openEditOrderModal('${escHtml(order.id)}')">âœï¸</button>
          <button class="btn-icon" title="Duplicate order" onclick="duplicateOrder('${escHtml(order.id)}')">â§‰</button>
          <button class="btn-icon danger" title="Delete order" onclick="deleteOrder('${escHtml(order.id)}')">ðŸ—‘</button>
        </div>
        <span class="order-chevron">â–¼</span>
      </div>
      <div class="order-body${isExpanded ? ' open' : ''}" id="order-body-${escHtml(order.id)}">
        <div class="order-body-inner" id="order-body-inner-${escHtml(order.id)}">
          <div class="state-loading" style="padding:1rem 0">Loading line itemsâ€¦</div>
        </div>
      </div>
    </div>`;
}

async function toggleOrderExpand(orderId) {
  const card = document.getElementById(`order-card-${orderId}`);
  const body = document.getElementById(`order-body-${orderId}`);
  if (!card || !body) return;

  if (estExpandedOrders.has(orderId)) {
    estExpandedOrders.delete(orderId);
    body.classList.remove('open');
    card.classList.remove('expanded');
  } else {
    estExpandedOrders.add(orderId);
    body.classList.add('open');
    card.classList.add('expanded');
    if (!estLineItems[orderId]) {
      await fetchLineItems(orderId);
    } else {
      renderLineItemsInOrder(orderId);
    }
  }
}

// â”€â”€ Cost Codes (loaded once per session) â”€â”€â”€â”€â”€
async function ensureCostCodes() {
  if (estCostCodesLoaded) return;
  try {
    const data = await apiFetch('/api/cost-codes');
    if (Array.isArray(data.costCodes)) {
      estCostCodes       = data.costCodes;
      estCostCodesLoaded = true;
    }
  } catch (_) { /* non-fatal â€” pickers will just be empty */ }
}

// â”€â”€ Line Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLineItems(orderId) {
  const inner = document.getElementById(`order-body-inner-${orderId}`);
  if (inner) inner.innerHTML = '<div class="state-loading" style="padding:1rem 0">Loadingâ€¦</div>';
  try {
    const [lineData, groupData] = await Promise.all([
      apiFetch(`/api/estimate-line-items?order_id=${orderId}`),
      apiFetch(`/api/order-groups?order_id=${orderId}`),
      ensureCostCodes(),
    ]);
    estLineItems[orderId] = lineData.lineItems || [];
    estGroups[orderId]    = groupData.groups   || [];
    renderLineItemsInOrder(orderId);
  } catch (err) {
    if (inner) inner.innerHTML =
      `<div class="state-error" style="margin:0.5rem 0">Error: ${escHtml(err.message)}</div>`;
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function liTableHead() {
  return `<thead><tr>
    <th style="min-width:140px">Name / Description</th>
    <th class="num" style="width:90px">Labor</th>
    <th class="num" style="width:90px">Materials</th>
    <th class="num" style="width:80px">Other</th>
    <th class="num" style="width:65px">Markup%</th>
    <th class="num" style="width:90px">Cost</th>
    <th class="num" style="width:90px">Price</th>
    <th style="width:80px"></th>
  </tr></thead>`;
}

function ccSelectOptions(selectedId) {
  const blank = `<option value="">${selectedId ? 'â€” remove â€”' : 'â€” none â€”'}</option>`;
  const opts  = estCostCodes.map(cc =>
    `<option value="${cc.id}"${cc.id === selectedId ? ' selected' : ''}>${escHtml(cc.number)} Â· ${escHtml(cc.name)}</option>`
  ).join('');
  return blank + opts;
}

function groupSelectOptions(orderId, selectedId) {
  const groups  = estGroups[orderId] || [];
  const blank   = `<option value="">${selectedId ? 'â€” ungrouped â€”' : 'â€” no group â€”'}</option>`;
  const opts    = groups.map(g =>
    `<option value="${g.id}"${g.id === selectedId ? ' selected' : ''}>${escHtml(g.name)}</option>`
  ).join('');
  return blank + opts;
}

// â”€â”€ Grouped render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLineItemsInOrder(orderId) {
  const inner = document.getElementById(`order-body-inner-${orderId}`);
  if (!inner) return;

  const items    = estLineItems[orderId] || [];
  const groups   = estGroups[orderId]    || [];
  const isEditing = estEditingLineItem?.orderId === orderId;

  const totalCost  = items.reduce((s, li) => s + li.totalCost, 0);
  const totalPrice = items.reduce((s, li) => s + li.price, 0);

  const orderMeta = estOrders.find(o => o.id === orderId);
  const notesHtml = orderMeta?.notes
    ? `<div style="font-size:0.78rem;color:var(--muted);padding:0.5rem 0 0.75rem;border-bottom:1px solid var(--border);margin-bottom:0.75rem;line-height:1.5">
         ðŸ“ ${escHtml(orderMeta.notes)}
       </div>`
    : '';

  let sectionsHtml = '';

  if (groups.length) {
    // â”€â”€ Render each group â”€â”€
    groups.forEach((group, gIdx) => {
      const groupItems  = items.filter(li => li.groupId === group.id);
      const groupTotal  = groupItems.reduce((s, li) => s + li.price, 0);
      const isFirst     = gIdx === 0;
      const isLast      = gIdx === groups.length - 1;
      const isRenaming  = estRenamingGroup === group.id;

      const nameHtml = isRenaming
        ? `<input class="group-name-input" id="grp-rename-input" value="${escHtml(group.name)}"
               onkeydown="handleGroupRenameKey(event,'${escHtml(orderId)}','${escHtml(group.id)}')"
               onblur="saveGroupRename('${escHtml(orderId)}','${escHtml(group.id)}')" />`
        : `<span class="group-name" title="Double-click to rename"
               ondblclick="startGroupRename('${escHtml(orderId)}','${escHtml(group.id)}')">${escHtml(group.name)}</span>`;

      sectionsHtml += `
        <div class="order-group" id="grp-${escHtml(group.id)}">
          <div class="order-group-header">
            ${nameHtml}
            <span class="group-total">${fmtCurrencyFull(groupTotal)}</span>
            ${isRenaming
              ? `<button class="group-rename-btn" onclick="saveGroupRename('${escHtml(orderId)}','${escHtml(group.id)}')">âœ“</button>
                 <button class="group-rename-btn" onclick="cancelGroupRename('${escHtml(orderId)}')">âœ•</button>`
              : `<button class="group-rename-btn" title="Rename" onclick="startGroupRename('${escHtml(orderId)}','${escHtml(group.id)}')">âœï¸</button>`}
            <button class="group-order-btn" title="Move up"   onclick="moveGroupUp('${escHtml(orderId)}','${escHtml(group.id)}')"   ${isFirst ? 'disabled' : ''}>â–²</button>
            <button class="group-order-btn" title="Move down" onclick="moveGroupDown('${escHtml(orderId)}','${escHtml(group.id)}')" ${isLast  ? 'disabled' : ''}>â–¼</button>
            <button class="group-delete-btn" title="Delete group (items become ungrouped)" onclick="deleteGroup('${escHtml(orderId)}','${escHtml(group.id)}')">âœ•</button>
          </div>
          <div class="group-body">
            ${renderGroupBody(orderId, groupItems, isEditing)}
          </div>
        </div>`;
    });

    // â”€â”€ Ungrouped section â”€â”€
    const ungrouped = items.filter(li => !li.groupId);
    if (ungrouped.length || !items.length) {
      const ungroupedTotal = ungrouped.reduce((s, li) => s + li.price, 0);
      sectionsHtml += `
        <div style="margin-bottom:0.85rem">
          <div class="group-ungrouped-header">Ungrouped ${ungrouped.length ? `<span style="float:right;font-style:normal;font-weight:600;color:var(--accent)">${fmtCurrencyFull(ungroupedTotal)}</span>` : ''}</div>
          ${renderGroupBody(orderId, ungrouped, isEditing)}
        </div>`;
    }
  } else {
    // â”€â”€ No groups â€” flat table â”€â”€
    const rows = items.map(li => {
      const editing = isEditing && estEditingLineItem?.itemId === li.id;
      return editing ? renderLineItemEditRow(orderId, li) : renderLineItemReadRow(orderId, li);
    }).join('');
    sectionsHtml = `
      <table class="li-table">
        ${liTableHead()}
        <tbody id="li-tbody-${escHtml(orderId)}">
          ${rows || `<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:1rem">No line items yet</td></tr>`}
        </tbody>
      </table>`;
  }

  inner.innerHTML = `
    ${notesHtml}
    ${sectionsHtml}
    ${items.length ? `
    <div class="order-totals-footer">
      <div class="order-total-item"><span>Total Cost: </span><strong>${fmtCurrencyFull(totalCost)}</strong></div>
      <div class="order-total-item price"><span>Total Price: </span><strong>${fmtCurrencyFull(totalPrice)}</strong></div>
    </div>` : ''}
    <div class="li-add-row" style="margin-top:0.75rem;gap:0.5rem">
      <button class="btn-add-li" onclick="startAddLineItem('${escHtml(orderId)}')">ï¼‹ Add line item</button>
      <button class="btn-add-group" onclick="addGroup('${escHtml(orderId)}')">ï¼‹ Add group</button>
    </div>
    ${isEditing && !estEditingLineItem?.itemId ? renderNewLineItemRow(orderId) : ''}`;

  // If renaming, focus the input
  if (estRenamingGroup) {
    requestAnimationFrame(() => {
      const inp = document.getElementById('grp-rename-input');
      if (inp) { inp.focus(); inp.select(); }
    });
  }
}

function renderGroupBody(orderId, groupItems, isEditing) {
  if (!groupItems.length) {
    return `<div style="font-size:0.75rem;color:var(--muted);padding:0.4rem 0 0.2rem;font-style:italic">No items yet</div>`;
  }

  // Sub-group by cost code category
  const categories = [];
  const catMap     = {};
  groupItems.forEach(li => {
    const cat = li.costCodeCategory || 'Uncategorized';
    if (!catMap[cat]) { catMap[cat] = []; categories.push(cat); }
    catMap[cat].push(li);
  });

  let html = '';
  categories.forEach(cat => {
    const catItems   = catMap[cat];
    const catTotal   = catItems.reduce((s, li) => s + li.price, 0);
    const catRows    = catItems.map(li => {
      const editing = isEditing && estEditingLineItem?.itemId === li.id;
      return editing ? renderLineItemEditRow(orderId, li) : renderLineItemReadRow(orderId, li);
    }).join('');

    html += `
      <div class="cost-cat-label">
        <span>${escHtml(cat)}</span>
        <span class="cat-subtotal">${fmtCurrencyFull(catTotal)}</span>
      </div>
      <table class="li-table" style="margin-bottom:0.5rem">
        ${liTableHead()}
        <tbody>${catRows}</tbody>
      </table>`;
  });
  return html;
}

function renderLineItemReadRow(orderId, li) {
  const ccBadge = li.costCodeName
    ? `<span class="li-cc-badge">${escHtml(li.costCodeNumber)} Â· ${escHtml(li.costCodeName)}</span>`
    : '';
  return `
    <tr id="li-row-${escHtml(li.id)}">
      <td>
        <div class="li-name-cell">${escHtml(li.name)}</div>
        ${li.description ? `<div class="li-desc-cell">${escHtml(li.description)}</div>` : ''}
        ${ccBadge ? `<div style="margin-top:2px">${ccBadge}</div>` : ''}
      </td>
      <td class="num-muted">${li.laborCost > 0 ? fmtCurrencyFull(li.laborCost) : 'â€”'}</td>
      <td class="num-muted">${li.materialsCost > 0 ? fmtCurrencyFull(li.materialsCost) : 'â€”'}</td>
      <td class="num-muted">${li.otherCost > 0 ? fmtCurrencyFull(li.otherCost) : 'â€”'}</td>
      <td class="num-muted">${li.markupPct}%</td>
      <td class="num">${fmtCurrencyFull(li.totalCost)}</td>
      <td class="num li-price-cell">${fmtCurrencyFull(li.price)}</td>
      <td>
        <div class="li-actions">
          <button class="btn-icon" title="Edit" onclick="startEditLineItem('${escHtml(orderId)}','${escHtml(li.id)}')">âœï¸</button>
          <button class="btn-icon danger" title="Delete" onclick="deleteLineItem('${escHtml(orderId)}','${escHtml(li.id)}')">âœ•</button>
        </div>
      </td>
    </tr>`;
}

function renderLineItemEditRow(orderId, li) {
  return `
    <tr class="li-editing" id="li-row-${escHtml(li.id)}">
      <td>
        <input class="li-input li-input-wide" id="lie-name" value="${escHtml(li.name)}" placeholder="Name *" />
        <input class="li-input" style="margin-top:4px" id="lie-desc" value="${escHtml(li.description||'')}" placeholder="Description (optional)" />
        <div style="display:flex;gap:0.35rem;margin-top:4px;flex-wrap:wrap">
          <select class="li-cc-select" id="lie-cost-code" title="Cost code">
            ${ccSelectOptions(li.costCodeId)}
          </select>
          <select class="li-cc-select" id="lie-group" title="Group" style="max-width:130px">
            ${groupSelectOptions(orderId, li.groupId)}
          </select>
        </div>
      </td>
      <td><input class="li-input num li-input-narrow" id="lie-labor" type="number" min="0" step="0.01" value="${li.laborCost}" /></td>
      <td><input class="li-input num li-input-narrow" id="lie-mats"  type="number" min="0" step="0.01" value="${li.materialsCost}" /></td>
      <td><input class="li-input num li-input-narrow" id="lie-other" type="number" min="0" step="0.01" value="${li.otherCost}" /></td>
      <td><input class="li-input num li-input-narrow" id="lie-margin" type="number" min="0" max="100" step="0.1" value="${li.markupPct}" /></td>
      <td class="num" id="lie-preview-cost" style="color:var(--muted);font-size:0.78rem">â€”</td>
      <td class="num li-price-cell" id="lie-preview-price">â€”</td>
      <td>
        <div class="li-actions" style="gap:0.3rem;flex-direction:column">
          <button class="li-save-btn" onclick="saveEditLineItem('${escHtml(orderId)}','${escHtml(li.id)}')">Save</button>
          <button class="li-cancel-btn" onclick="cancelLineItemEdit('${escHtml(orderId)}')">Cancel</button>
        </div>
      </td>
    </tr>`;
}

function renderNewLineItemRow(orderId) {
  const hasGroups = (estGroups[orderId] || []).length > 0;
  return `
    <div id="li-new-row-${escHtml(orderId)}" style="margin-top:0.5rem;padding:0.75rem;background:rgba(249,115,22,0.04);border:1px solid rgba(249,115,22,0.15);border-radius:8px">
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:0.5rem;margin-bottom:0.6rem">
        <div>
          <label class="form-label" style="font-size:0.65rem">Name *</label>
          <input class="li-input" id="lin-name" placeholder="e.g. Rough Plumbing"
                 onkeydown="if(event.key==='Enter')submitNewLineItem('${escHtml(orderId)}')" />
        </div>
        <div>
          <label class="form-label" style="font-size:0.65rem">Labor ($)</label>
          <input class="li-input num" id="lin-labor" type="number" min="0" step="0.01" placeholder="0"
                 oninput="updateNewPreview()" />
        </div>
        <div>
          <label class="form-label" style="font-size:0.65rem">Materials ($)</label>
          <input class="li-input num" id="lin-mats" type="number" min="0" step="0.01" placeholder="0"
                 oninput="updateNewPreview()" />
        </div>
        <div>
          <label class="form-label" style="font-size:0.65rem">Other ($)</label>
          <input class="li-input num" id="lin-other" type="number" min="0" step="0.01" placeholder="0"
                 oninput="updateNewPreview()" />
        </div>
        <div>
          <label class="form-label" style="font-size:0.65rem">Markup %</label>
          <input class="li-input num" id="lin-margin" type="number" min="0" max="100" step="0.1" placeholder="20" value="20"
                 oninput="updateNewPreview()" />
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.6rem">
        <div>
          <label class="form-label" style="font-size:0.65rem">Description (optional)</label>
          <input class="li-input" id="lin-desc" placeholder="Brief description" />
        </div>
        <div style="display:flex;gap:0.5rem">
          <div style="flex:1">
            <label class="form-label" style="font-size:0.65rem">Cost Code</label>
            <select class="li-input li-cc-select" id="lin-cost-code" style="max-width:100%;width:100%">
              ${ccSelectOptions(null)}
            </select>
          </div>
          ${hasGroups ? `
          <div style="flex:1">
            <label class="form-label" style="font-size:0.65rem">Group</label>
            <select class="li-input li-cc-select" id="lin-group" style="max-width:100%;width:100%">
              ${groupSelectOptions(orderId, null)}
            </select>
          </div>` : ''}
        </div>
      </div>
      <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
        <button class="li-save-btn" onclick="submitNewLineItem('${escHtml(orderId)}')">Add Item</button>
        <button class="li-cancel-btn" onclick="cancelNewLineItem('${escHtml(orderId)}')">Cancel</button>
        <span id="lin-preview" style="font-size:0.78rem;color:var(--muted);margin-left:0.25rem"></span>
        <span id="lin-error" style="font-size:0.75rem;color:var(--red);display:none"></span>
      </div>
    </div>`;
}

function updateNewPreview() {
  const labor  = parseFloat(document.getElementById('lin-labor')?.value  || 0) || 0;
  const mats   = parseFloat(document.getElementById('lin-mats')?.value   || 0) || 0;
  const other  = parseFloat(document.getElementById('lin-other')?.value  || 0) || 0;
  const markup = parseFloat(document.getElementById('lin-margin')?.value || 20) || 20;
  const cost   = labor + mats + other;
  const price  = cost * (1 + markup / 100);
  const preview = document.getElementById('lin-preview');
  if (preview && cost > 0) {
    preview.textContent = `Cost: ${fmtCurrencyFull(cost)} â†’ Price: ${fmtCurrencyFull(price)}`;
    preview.style.color = 'var(--accent)';
  } else if (preview) {
    preview.textContent = '';
  }
}

// â”€â”€ Inline edit entry points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startEditLineItem(orderId, itemId) {
  estEditingLineItem = { orderId, itemId };
  renderLineItemsInOrder(orderId);
  // Wire up live preview
  requestAnimationFrame(() => {
    ['lie-labor','lie-mats','lie-other','lie-margin'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => updateEditPreview());
    });
    updateEditPreview();
  });
}

function updateEditPreview() {
  const labor  = parseFloat(document.getElementById('lie-labor')?.value  || 0) || 0;
  const mats   = parseFloat(document.getElementById('lie-mats')?.value   || 0) || 0;
  const other  = parseFloat(document.getElementById('lie-other')?.value  || 0) || 0;
  const markup = parseFloat(document.getElementById('lie-margin')?.value || 20) || 20;
  const cost   = labor + mats + other;
  const price  = cost * (1 + markup / 100);
  const costEl  = document.getElementById('lie-preview-cost');
  const priceEl = document.getElementById('lie-preview-price');
  if (costEl)  costEl.textContent  = fmtCurrencyFull(cost);
  if (priceEl) priceEl.textContent = fmtCurrencyFull(price);
}

function cancelLineItemEdit(orderId) {
  estEditingLineItem = null;
  renderLineItemsInOrder(orderId);
}

async function saveEditLineItem(orderId, itemId) {
  const name  = document.getElementById('lie-name')?.value.trim();
  if (!name) { alert('Name is required'); return; }
  const body = {
    name,
    description:   document.getElementById('lie-desc')?.value.trim() || null,
    laborCost:     parseFloat(document.getElementById('lie-labor')?.value  || 0) || 0,
    materialsCost: parseFloat(document.getElementById('lie-mats')?.value   || 0) || 0,
    otherCost:     parseFloat(document.getElementById('lie-other')?.value  || 0) || 0,
    markupPct:     parseFloat(document.getElementById('lie-margin')?.value || 20) || 20,
    costCodeId:    document.getElementById('lie-cost-code')?.value || null,
    groupId:       document.getElementById('lie-group')?.value     || null,
  };
  const btn = document.querySelector(`#li-row-${itemId} .li-save-btn`);
  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
  try {
    const data = await apiPatch(`/api/estimate-line-items?id=${itemId}`, body);
    const idx  = (estLineItems[orderId] || []).findIndex(li => li.id === itemId);
    if (idx !== -1 && data.lineItem) estLineItems[orderId][idx] = data.lineItem;
    estEditingLineItem = null;
    renderLineItemsInOrder(orderId);
    await refreshOrderCard(orderId);
  } catch (err) {
    alert('Save failed: ' + err.message);
    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
  }
}

// â”€â”€ New line item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAddLineItem(orderId) {
  // If already adding, just focus the name field
  if (estEditingLineItem?.orderId === orderId && !estEditingLineItem?.itemId) {
    document.getElementById('lin-name')?.focus();
    return;
  }
  estEditingLineItem = { orderId, itemId: null };
  renderLineItemsInOrder(orderId);
  requestAnimationFrame(() => document.getElementById('lin-name')?.focus());
}

function cancelNewLineItem(orderId) {
  estEditingLineItem = null;
  renderLineItemsInOrder(orderId);
}

async function submitNewLineItem(orderId) {
  const name = document.getElementById('lin-name')?.value.trim();
  const errEl = document.getElementById('lin-error');
  if (!name) {
    if (errEl) { errEl.textContent = 'Name required'; errEl.style.display = 'inline'; }
    document.getElementById('lin-name')?.focus();
    return;
  }
  if (errEl) errEl.style.display = 'none';

  const body = {
    order_id:      orderId,
    name,
    description:   document.getElementById('lin-desc')?.value.trim()  || null,
    laborCost:     parseFloat(document.getElementById('lin-labor')?.value  || 0) || 0,
    materialsCost: parseFloat(document.getElementById('lin-mats')?.value   || 0) || 0,
    otherCost:     parseFloat(document.getElementById('lin-other')?.value  || 0) || 0,
    markupPct:     parseFloat(document.getElementById('lin-margin')?.value || 20) || 20,
    costCodeId:    document.getElementById('lin-cost-code')?.value || null,
    groupId:       document.getElementById('lin-group')?.value     || null,
  };
  const btn = document.querySelector(`#li-new-row-${orderId} .li-save-btn`);
  if (btn) { btn.disabled = true; btn.textContent = 'Addingâ€¦'; }
  try {
    const data = await apiPost('/api/estimate-line-items', body);
    if (!estLineItems[orderId]) estLineItems[orderId] = [];
    estLineItems[orderId].push(data.lineItem);
    estEditingLineItem = null;
    renderLineItemsInOrder(orderId);
    await refreshOrderCard(orderId);
  } catch (err) {
    alert('Failed to add line item: ' + err.message);
    if (btn) { btn.disabled = false; btn.textContent = 'Add Item'; }
  }
}

async function deleteLineItem(orderId, itemId) {
  if (!confirm('Delete this line item?')) return;
  try {
    await fetch(`/api/estimate-line-items?id=${itemId}`, {
      method:  'DELETE',
      headers: authHeaders(),
    });
    estLineItems[orderId] = (estLineItems[orderId] || []).filter(li => li.id !== itemId);
    if (estEditingLineItem?.itemId === itemId) estEditingLineItem = null;
    renderLineItemsInOrder(orderId);
    await refreshOrderCard(orderId);
  } catch (err) {
    alert('Delete failed: ' + err.message);
  }
}

// â”€â”€ Group management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addGroup(orderId) {
  const name = prompt('Group name (e.g. Bathroom Remodel, Landscape):');
  if (!name?.trim()) return;
  try {
    const data = await apiPost('/api/order-groups', { order_id: orderId, name: name.trim() });
    if (!estGroups[orderId]) estGroups[orderId] = [];
    estGroups[orderId].push(data.group);
    renderLineItemsInOrder(orderId);
  } catch (err) {
    alert('Failed to add group: ' + err.message);
  }
}

async function deleteGroup(orderId, groupId) {
  const group = (estGroups[orderId] || []).find(g => g.id === groupId);
  if (!confirm(`Delete group "${group?.name || 'this group'}"?\nLine items in it will become ungrouped (not deleted).`)) return;
  try {
    await fetch(`/api/order-groups?id=${groupId}`, { method: 'DELETE', headers: authHeaders() });
    estGroups[orderId] = (estGroups[orderId] || []).filter(g => g.id !== groupId);
    // Un-group line items in memory
    (estLineItems[orderId] || []).forEach(li => {
      if (li.groupId === groupId) li.groupId = null;
    });
    renderLineItemsInOrder(orderId);
  } catch (err) {
    alert('Delete failed: ' + err.message);
  }
}

async function moveGroupUp(orderId, groupId) {
  const groups = estGroups[orderId] || [];
  const idx    = groups.findIndex(g => g.id === groupId);
  if (idx <= 0) return;
  [groups[idx - 1], groups[idx]] = [groups[idx], groups[idx - 1]];
  reassignGroupSortOrders(orderId);
  renderLineItemsInOrder(orderId);
  await persistGroupOrder(orderId);
}

async function moveGroupDown(orderId, groupId) {
  const groups = estGroups[orderId] || [];
  const idx    = groups.findIndex(g => g.id === groupId);
  if (idx < 0 || idx >= groups.length - 1) return;
  [groups[idx], groups[idx + 1]] = [groups[idx + 1], groups[idx]];
  reassignGroupSortOrders(orderId);
  renderLineItemsInOrder(orderId);
  await persistGroupOrder(orderId);
}

function reassignGroupSortOrders(orderId) {
  (estGroups[orderId] || []).forEach((g, i) => { g.sortOrder = i; });
}

async function persistGroupOrder(orderId) {
  const body = (estGroups[orderId] || []).map(g => ({ id: g.id, sort_order: g.sortOrder }));
  try {
    await apiPatch('/api/order-groups?action=reorder', body);
  } catch (_) { /* best-effort */ }
}

function startGroupRename(orderId, groupId) {
  estRenamingGroup = groupId;
  renderLineItemsInOrder(orderId);
}

function cancelGroupRename(orderId) {
  estRenamingGroup = null;
  renderLineItemsInOrder(orderId);
}

function handleGroupRenameKey(e, orderId, groupId) {
  if (e.key === 'Enter')  { e.preventDefault(); saveGroupRename(orderId, groupId); }
  if (e.key === 'Escape') { e.preventDefault(); cancelGroupRename(orderId); }
}

async function saveGroupRename(orderId, groupId) {
  const inp  = document.getElementById('grp-rename-input');
  const name = inp?.value.trim();
  if (!name) { cancelGroupRename(orderId); return; }
  estRenamingGroup = null;
  try {
    const data = await apiPatch(`/api/order-groups?id=${groupId}`, { name });
    const idx  = (estGroups[orderId] || []).findIndex(g => g.id === groupId);
    if (idx !== -1 && data.group) estGroups[orderId][idx] = data.group;
  } catch (err) {
    alert('Rename failed: ' + err.message);
  }
  renderLineItemsInOrder(orderId);
}

// â”€â”€ Refresh order card after any line item change â”€â”€
async function refreshOrderCard(orderId) {
  try {
    const data = await apiFetch(`/api/orders?id=${orderId}`);
    const updated = data.orders?.[0];
    if (!updated) return;
    const idx = estOrders.findIndex(o => o.id === orderId);
    if (idx !== -1) estOrders[idx] = updated;
    // Re-render just this card's header (keep body open)
    const card = document.getElementById(`order-card-${orderId}`);
    if (!card) return;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = renderOrderCard(updated);
    const newCard = tempDiv.firstElementChild;
    // Preserve body state
    const body = card.querySelector('.order-body');
    const newBody = newCard.querySelector('.order-body');
    if (body && newBody) {
      newBody.innerHTML = body.innerHTML;
      if (estExpandedOrders.has(orderId)) {
        newBody.classList.add('open');
        newCard.classList.add('expanded');
      }
    }
    card.replaceWith(newCard);
    // Refresh job metrics
    const jobsData = await apiFetch('/api/jobs?source=estimating');
    estJobs = jobsData.jobs || [];
    const job = estJobs.find(j => j.id === estSelectedJobId);
    renderEstMetrics(job);
  } catch (_) {}
}

// â”€â”€ New / Edit Order modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewOrderModal() {
  estEditOrderId = null;
  document.getElementById('new-order-modal-title').textContent = 'New Order';
  document.getElementById('no-name').value   = '';
  document.getElementById('no-type').value   = 'Proposal';
  document.getElementById('no-status').value = 'Draft';
  document.getElementById('no-notes').value  = '';
  document.getElementById('no-save-btn').textContent = 'Create Order';
  document.getElementById('new-order-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('no-name').focus(), 60);
}

function openEditOrderModal(orderId) {
  const order = estOrders.find(o => o.id === orderId);
  if (!order) return;
  estEditOrderId = orderId;
  document.getElementById('new-order-modal-title').textContent = 'Edit Order';
  document.getElementById('no-name').value   = order.name;
  document.getElementById('no-type').value   = order.type;
  document.getElementById('no-status').value = order.status;
  document.getElementById('no-notes').value  = order.notes || '';
  document.getElementById('no-save-btn').textContent = 'Save Changes';
  document.getElementById('new-order-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('no-name').focus(), 60);
}

function closeNewOrderModal() {
  document.getElementById('new-order-modal').classList.add('hidden');
  estEditOrderId = null;
}

async function submitNewOrder() {
  const name   = document.getElementById('no-name').value.trim();
  const type   = document.getElementById('no-type').value;
  const status = document.getElementById('no-status').value;
  const notes  = document.getElementById('no-notes').value.trim();
  if (!name) { document.getElementById('no-name').focus(); return; }

  const btn = document.getElementById('no-save-btn');
  btn.disabled = true;
  btn.textContent = estEditOrderId ? 'Savingâ€¦' : 'Creatingâ€¦';

  try {
    if (estEditOrderId) {
      await apiPatch(`/api/orders?id=${estEditOrderId}`, { name, type, status, notes: notes||null });
    } else {
      await apiPost('/api/orders', { job_id: estSelectedJobId, name, type, status, notes: notes||null });
    }
    closeNewOrderModal();
    await fetchEstOrders(estSelectedJobId);
  } catch (err) {
    alert('Failed: ' + err.message);
    btn.disabled = false;
    btn.textContent = estEditOrderId ? 'Save Changes' : 'Create Order';
  }
}

async function deleteOrder(orderId) {
  const order = estOrders.find(o => o.id === orderId);
  if (!order) return;
  if (!confirm(`Delete "${order.name}" and all its line items?`)) return;
  try {
    await fetch(`/api/orders?id=${orderId}`, { method: 'DELETE', headers: authHeaders() });
    estExpandedOrders.delete(orderId);
    delete estLineItems[orderId];
    await fetchEstOrders(estSelectedJobId);
  } catch (err) {
    alert('Delete failed: ' + err.message);
  }
}

// â”€â”€ Duplicate order (copy order + all line items as a new Draft) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function duplicateOrder(orderId) {
  const order = estOrders.find(o => o.id === orderId);
  if (!order) return;

  const defaultName = order.name.match(/\bcopy\b/i) ? order.name : order.name + ' (copy)';
  const newName = prompt('Name for the duplicate order:', defaultName);
  if (!newName?.trim()) return;

  try {
    // Create new order
    const created = await apiPost('/api/orders', {
      job_id: estSelectedJobId,
      name:   newName.trim(),
      type:   order.type,
      status: 'Draft',
      notes:  order.notes || null,
    });
    const newOrderId = created.id;

    // Fetch source line items if not already loaded
    if (!estLineItems[orderId]) {
      const data = await apiFetch(`/api/estimate-line-items?order_id=${orderId}`);
      estLineItems[orderId] = data.lineItems || [];
    }

    // Copy each line item to new order
    await Promise.all(
      (estLineItems[orderId] || []).map((li, idx) =>
        apiPost('/api/estimate-line-items', {
          order_id:      newOrderId,
          name:          li.name,
          description:   li.description   || null,
          laborCost:     li.laborCost,
          materialsCost: li.materialsCost,
          otherCost:     li.otherCost,
          markupPct:     li.markupPct,
          sortOrder:     li.sortOrder ?? idx,
        })
      )
    );

    // Refresh and auto-expand the new order
    await fetchEstOrders(estSelectedJobId);
    estExpandedOrders.add(newOrderId);
    const newOrder = estOrders.find(o => o.id === newOrderId);
    if (newOrder) {
      renderEstOrders();
      await fetchLineItems(newOrderId);
    }
  } catch (err) {
    alert('Duplicate failed: ' + err.message);
  }
}

// Close new-order modal on overlay click
document.getElementById('new-order-modal').addEventListener('click', function(e) {
  if (e.target === this) closeNewOrderModal();
});

// Allow Enter on order name field
document.getElementById('no-name').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitNewOrder();
});

// â”€â”€ New Job modal (creates a bare Supabase job for estimating) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewJobModal() {
  document.getElementById('nj-name').value    = '';
  document.getElementById('nj-status').value  = 'estimating';
  document.getElementById('nj-city').value    = '';
  document.getElementById('nj-address').value = '';
  document.getElementById('nj-save-btn').disabled    = false;
  document.getElementById('nj-save-btn').textContent = 'Create Job';
  document.getElementById('new-job-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('nj-name').focus(), 60);
}

function closeNewJobModal() {
  const modal = document.getElementById('new-job-modal');
  if (modal) modal.classList.add('hidden');
}

async function submitNewJob() {
  const name = document.getElementById('nj-name').value.trim();
  if (!name) { document.getElementById('nj-name').focus(); return; }
  const btn = document.getElementById('nj-save-btn');
  btn.disabled = true; btn.textContent = 'Creatingâ€¦';
  try {
    const data = await apiPost('/api/jobs?source=estimating', {
      name,
      status:  document.getElementById('nj-status').value,
      city:    document.getElementById('nj-city').value.trim()    || null,
      address: document.getElementById('nj-address').value.trim() || null,
    });
    closeNewJobModal();
    // Reload job list and select the new job
    estJobsLoaded = false;
    await fetchEstJobs();
    if (data.id) {
      document.getElementById('est-job-select').value = data.id;
      estSelectJob(data.id);
    }
  } catch (err) {
    alert('Failed to create job: ' + err.message);
    btn.disabled = false; btn.textContent = 'Create Job';
  }
}

// Close new-job modal on overlay click
document.getElementById('new-job-modal').addEventListener('click', function(e) {
  if (e.target === this) closeNewJobModal();
});

// Allow Enter on job name field
document.getElementById('nj-name').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitNewJob();
});
</script>
</body>
</html>
