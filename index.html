<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cody Design Build â€” Mission Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050508;
    --bg2: #0d0d14;
    --card: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.07);
    --accent: #f97316;
    --accent2: #fb923c;
    --text: #e8e8f0;
    --muted: #6b7280;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; }

  /* â”€â”€â”€ AUTH GATE â”€â”€â”€ */
  #auth-overlay {
    position:fixed; inset:0; z-index:9999;
    background:var(--bg);
    display:flex; align-items:center; justify-content:center;
    animation:fadeIn 0.3s ease;
  }
  #auth-overlay.hidden { display:none; }

  .auth-box {
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:20px;
    padding:3rem 2.5rem;
    width:100%;
    max-width:400px;
    backdrop-filter:blur(24px);
    box-shadow:0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .auth-box::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--accent), var(--accent2), var(--purple));
  }
  .auth-logo {
    font-size:1.1rem; font-weight:700; color:var(--accent);
    letter-spacing:-0.02em; margin-bottom:0.25rem;
  }
  .auth-logo span { color:var(--text); font-weight:400; }
  .auth-title {
    font-size:1.5rem; font-weight:700; letter-spacing:-0.03em;
    margin:1.25rem 0 0.4rem;
  }
  .auth-subtitle { font-size:0.82rem; color:var(--muted); margin-bottom:2rem; }

  .auth-field {
    position:relative; margin-bottom:1rem;
  }
  .auth-field input {
    width:100%;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:10px;
    padding:0.8rem 1rem;
    font-size:1rem;
    font-family:'Inter',sans-serif;
    color:var(--text);
    outline:none;
    transition:border-color 0.2s, box-shadow 0.2s;
    letter-spacing:0.1em;
    text-align:center;
  }
  .auth-field input::placeholder { letter-spacing:normal; color:var(--muted); }
  .auth-field input:focus {
    border-color:rgba(249,115,22,0.5);
    box-shadow:0 0 0 3px rgba(249,115,22,0.1);
  }
  .auth-field label {
    display:block; font-size:0.72rem; font-weight:600;
    text-transform:uppercase; letter-spacing:0.08em;
    color:var(--muted); margin-bottom:0.5rem; text-align:left;
  }

  .auth-btn {
    width:100%; padding:0.85rem;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    border:none; border-radius:10px;
    font-size:0.9rem; font-weight:600;
    font-family:'Inter',sans-serif;
    color:#fff; cursor:pointer;
    transition:opacity 0.15s, transform 0.1s;
    letter-spacing:0.01em;
  }
  .auth-btn:hover { opacity:0.9; transform:translateY(-1px); }
  .auth-btn:active { transform:translateY(0); }
  .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

  .auth-error {
    margin-top:0.75rem; padding:0.6rem 1rem;
    background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2);
    border-radius:8px; font-size:0.8rem; color:var(--red);
    display:none;
  }
  .auth-error.show { display:block; }

  .auth-spinner {
    display:inline-block; width:14px; height:14px;
    border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin 0.6s linear infinite;
    vertical-align:middle; margin-right:0.4rem;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  .auth-footer {
    margin-top:1.5rem; font-size:0.72rem; color:var(--muted);
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  header {
    position:sticky; top:0; z-index:100;
    background:rgba(5,5,8,0.85);
    backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
    padding:0 2rem;
    display:flex; align-items:center; justify-content:space-between;
    height:60px;
  }
  .logo { font-size:1rem; font-weight:700; color:var(--accent); letter-spacing:-0.02em; }
  .logo span { color:var(--text); font-weight:400; }
  nav { display:flex; gap:0.25rem; }
  nav button {
    background:none; border:none; color:var(--muted);
    padding:0.4rem 0.9rem; border-radius:6px;
    font-size:0.85rem; font-family:'Inter',sans-serif;
    cursor:pointer; transition:all 0.15s;
  }
  nav button:hover { color:var(--text); background:var(--card); }
  nav button.active { color:var(--accent); background:rgba(249,115,22,0.1); }
  .header-right { display:flex; align-items:center; gap:1rem; }
  #clock { font-size:0.8rem; color:var(--muted); font-variant-numeric:tabular-nums; }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  #signout-btn {
    font-size:0.75rem; color:var(--muted); cursor:pointer;
    background:none; border:none; font-family:'Inter',sans-serif;
    padding:0.25rem 0.5rem; border-radius:4px;
    transition:color 0.15s, background 0.15s;
  }
  #signout-btn:hover { color:var(--red); background:rgba(239,68,68,0.08); }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  main { max-width:1400px; margin:0 auto; padding:2rem; }

  /* â”€â”€â”€ TAB PANELS â”€â”€â”€ */
  .tab-panel { display:none; animation:fadeIn 0.2s ease; }
  .tab-panel.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* â”€â”€â”€ CARDS â”€â”€â”€ */
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:1.25rem;
    backdrop-filter:blur(10px);
  }
  .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
  .card-title { font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); }

  /* â”€â”€â”€ METRICS GRID â”€â”€â”€ */
  .metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:1.5rem; }
  .metric-card {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; padding:1.25rem; position:relative; overflow:hidden;
  }
  .metric-bar { position:absolute; top:0; left:0; right:0; height:3px; }
  .metric-icon { font-size:1.4rem; margin-bottom:0.5rem; }
  .metric-label { font-size:0.75rem; color:var(--muted); margin-bottom:0.25rem; }
  .metric-value { font-size:1.8rem; font-weight:700; letter-spacing:-0.02em; }
  .metric-sub { font-size:0.75rem; color:var(--muted); margin-top:0.25rem; }
  .trend-up { color:var(--green); }
  .trend-dn { color:var(--red); }

  /* â”€â”€â”€ GRIDS â”€â”€â”€ */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1rem; }

  /* â”€â”€â”€ TABLES â”€â”€â”€ */
  table { width:100%; border-collapse:collapse; }
  th { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); padding:0.5rem 0.75rem; text-align:left; border-bottom:1px solid var(--border); }
  td { padding:0.65rem 0.75rem; font-size:0.85rem; border-bottom:1px solid rgba(255,255,255,0.03); }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:rgba(255,255,255,0.02); }

  /* â”€â”€â”€ BADGES â”€â”€â”€ */
  .badge { display:inline-flex; align-items:center; gap:0.3rem; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.72rem; font-weight:600; }
  .badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
  .badge-yellow { background:rgba(234,179,8,0.15); color:var(--yellow); }
  .badge-red { background:rgba(239,68,68,0.15); color:var(--red); }
  .badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
  .badge-orange { background:rgba(249,115,22,0.15); color:var(--accent); }
  .badge-muted { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* â”€â”€â”€ PROGRESS â”€â”€â”€ */
  .progress-bar { background:rgba(255,255,255,0.06); border-radius:4px; height:6px; overflow:hidden; }
  .progress-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }

  /* â”€â”€â”€ PRIORITIES â”€â”€â”€ */
  .priority-item { display:flex; align-items:center; gap:0.75rem; padding:0.6rem 0; border-bottom:1px solid var(--border); }
  .priority-item:last-child { border-bottom:none; }
  .priority-item input[type=checkbox] { accent-color:var(--accent); width:16px; height:16px; cursor:pointer; }
  .priority-item label { font-size:0.875rem; cursor:pointer; flex:1; }
  .priority-item label.done { text-decoration:line-through; color:var(--muted); }

  /* â”€â”€â”€ AGENT CARDS â”€â”€â”€ */
  .agent-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:1rem; }
  @media(max-width:700px){ .agent-grid { grid-template-columns:1fr; } }
  .agent-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; transition:border-color 0.2s; }
  .agent-card.agent-active { border-color:rgba(34,197,94,0.3); }
  .agent-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:0.75rem; }
  .agent-emoji { font-size:1.8rem; }
  .agent-name { font-weight:600; font-size:1rem; }
  .agent-role { font-size:0.75rem; color:var(--muted); }
  .agent-status-row { display:flex; align-items:center; gap:0.4rem; font-size:0.78rem; margin-bottom:0.5rem; }
  .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .dot-green { background:var(--green); box-shadow:0 0 6px var(--green); animation:pulse-green 2s infinite; }
  .dot-yellow { background:var(--yellow); }
  .dot-gray { background:var(--muted); }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 4px var(--green);} 50%{box-shadow:0 0 10px var(--green);} }
  .agent-last-active { font-size:0.7rem; color:var(--muted); margin-bottom:0.75rem; }
  .agent-caps { display:flex; flex-wrap:wrap; gap:0.35rem; margin-bottom:0.85rem; }
  .agent-model-row { display:flex; align-items:center; gap:0.5rem; margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); }
  .agent-model-label { font-size:0.72rem; color:var(--muted); white-space:nowrap; }
  .model-select { flex:1; background:var(--bg2); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:0.25rem 0.4rem; font-size:0.72rem; font-family:'Inter',sans-serif; cursor:pointer; }
  .model-select:focus { outline:none; border-color:var(--accent); }
  .model-save-btn { font-size:0.7rem; padding:0.25rem 0.6rem; border-radius:6px; border:1px solid var(--accent); background:transparent; color:var(--accent); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .model-save-btn:hover { background:rgba(249,115,22,0.15); }
  .model-save-btn:disabled { opacity:0.4; cursor:default; }
  .agent-offline-note { font-size:0.7rem; color:var(--muted); font-style:italic; margin-top:0.4rem; }
  .agents-live-badge { display:flex; align-items:center; gap:0.4rem; font-size:0.72rem; color:var(--muted); }
  .agents-live-badge .dot { width:5px; height:5px; }

  /* â”€â”€â”€ INBOX ITEMS â”€â”€â”€ */
  .inbox-item { display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); }
  .inbox-left { display:flex; flex-direction:column; gap:0.2rem; }
  .inbox-vendor { font-size:0.875rem; font-weight:500; }
  .inbox-desc { font-size:0.75rem; color:var(--muted); }
  .inbox-amount { font-size:1rem; font-weight:600; }
  .inbox-amount.debit { color:var(--red); }
  .inbox-amount.credit { color:var(--green); }

  /* â”€â”€â”€ SECTION HEADERS â”€â”€â”€ */
  h2 { font-size:1.2rem; font-weight:700; margin-bottom:1rem; letter-spacing:-0.02em; }
  h3 { font-size:0.95rem; font-weight:600; margin-bottom:0.75rem; }

  /* â”€â”€â”€ WELCOME BAR â”€â”€â”€ */
  .welcome { margin-bottom:1.5rem; }
  .welcome h1 { font-size:1.6rem; font-weight:700; letter-spacing:-0.03em; }
  .welcome p { color:var(--muted); font-size:0.875rem; margin-top:0.25rem; }

  /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
  .divider { border:none; border-top:1px solid var(--border); margin:1rem 0; }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
  .btn { background:var(--accent); color:#fff; border:none; padding:0.5rem 1rem; border-radius:8px; font-size:0.8rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:opacity 0.15s; }
  .btn:hover { opacity:0.85; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-ghost:hover { background:var(--card); }

  /* â”€â”€â”€ JOB CARD â”€â”€â”€ */
  .job-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; margin-bottom:0.75rem; transition:border-color 0.2s; }
  .job-card:hover { border-color:rgba(255,255,255,0.12); }
  .job-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
  .job-name { font-weight:600; font-size:0.95rem; }
  .job-number { font-size:0.75rem; color:var(--muted); margin-top:0.15rem; }
  .job-budget-row { display:flex; justify-content:space-between; font-size:0.78rem; margin-bottom:0.4rem; }
  .job-budget-row span { color:var(--muted); }
  .job-budget-row strong { color:var(--text); }

  /* â”€â”€â”€ LAST UPDATED â”€â”€â”€ */
  #last-updated {
    font-size:0.72rem; color:var(--muted);
    text-align:right; margin-bottom:0.75rem;
    transition:opacity 0.3s;
  }

  /* â”€â”€â”€ LOADING / ERROR STATES â”€â”€â”€ */
  .state-loading { text-align:center; padding:2rem; color:var(--muted); font-size:0.85rem; }
  .state-error { text-align:center; padding:1.5rem; color:var(--red); font-size:0.82rem; background:rgba(239,68,68,0.06); border-radius:8px; border:1px solid rgba(239,68,68,0.15); }

  /* â”€â”€â”€ TASKS â”€â”€â”€ */
  .tasks-header { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem; }
  .tasks-header h2 { margin:0; flex:1; }
  .view-toggle { display:flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .view-btn { padding:0.3rem 0.75rem; background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:0.78rem; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .view-btn.active { background:var(--accent); color:#fff; }

  /* Project switcher */
  .project-switcher { display:flex; gap:0; align-items:center; overflow-x:auto; padding-bottom:0.6rem; margin-bottom:1rem; scrollbar-width:none; }
  .project-switcher::-webkit-scrollbar { display:none; }
  .proj-sep { width:1px; background:var(--border); height:20px; margin:0 0.5rem; flex-shrink:0; }
  .proj-pill { display:flex; align-items:center; gap:0.3rem; padding:0.28rem 0.65rem; border-radius:20px; font-size:0.75rem; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; flex-shrink:0; }
  .proj-pill:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }
  .proj-pill.active { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }
  .proj-pill.group { font-weight:600; }
  .proj-add { font-size:0.75rem; padding:0.28rem 0.65rem; border-radius:20px; border:1px dashed rgba(255,255,255,0.15); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; white-space:nowrap; flex-shrink:0; transition:all 0.15s; }
  .proj-add:hover { border-color:var(--accent); color:var(--accent); }

  /* Kanban */
  .kanban-board { display:grid; grid-template-columns:repeat(4,1fr); gap:0.85rem; align-items:start; }
  @media(max-width:900px){ .kanban-board { grid-template-columns:repeat(2,1fr); } }
  @media(max-width:500px){ .kanban-board { grid-template-columns:1fr; } }
  .kanban-col { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:0.85rem; min-height:180px; }
  .kanban-col-header { font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.75rem; display:flex; align-items:center; gap:0.5rem; }
  .kanban-count { font-size:0.68rem; padding:0.1rem 0.45rem; border-radius:20px; font-weight:500; }
  .task-card { background:var(--card); border:1px solid var(--border); border-radius:9px; padding:0.75rem; margin-bottom:0.55rem; cursor:grab; transition:border-color 0.15s,transform 0.12s,opacity 0.15s; }
  .task-card:hover { border-color:rgba(255,255,255,0.14); transform:translateY(-1px); }
  .task-card.dragging { opacity:0.35; cursor:grabbing; transform:scale(0.97); }
  .task-card-name { font-size:0.82rem; font-weight:500; margin-bottom:0.4rem; line-height:1.35; cursor:pointer; }
  .task-card-meta { display:flex; flex-wrap:wrap; gap:0.3rem; align-items:center; }
  .task-card-tag { font-size:0.68rem; color:var(--muted); }
  .task-card-actions { display:flex; gap:0.3rem; margin-top:0.5rem; padding-top:0.45rem; border-top:1px solid var(--border); }
  .status-btn { font-size:0.65rem; padding:0.15rem 0.45rem; border-radius:20px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .status-btn:hover { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }
  .kanban-col.drag-over { border-color:var(--accent); background:rgba(249,115,22,0.06); }

  /* Multi-board (Jobs group view) */
  .multi-board { display:flex; flex-direction:column; gap:1.5rem; }
  .mini-board { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
  .mini-board-header { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02); }
  .mini-board-title { font-size:0.88rem; font-weight:600; display:flex; align-items:center; gap:0.5rem; }
  .mini-board-add { font-size:0.72rem; color:var(--muted); cursor:pointer; border:1px solid var(--border); border-radius:6px; padding:0.2rem 0.5rem; background:transparent; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .mini-board-add:hover { border-color:var(--accent); color:var(--accent); }
  .mini-kanban { display:grid; grid-template-columns:repeat(4,1fr); gap:0.6rem; padding:0.75rem; }
  @media(max-width:800px){ .mini-kanban { grid-template-columns:repeat(2,1fr); } }
  .mini-col { min-height:80px; }
  .mini-col-header { font-size:0.65rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.3rem; }
  .mini-card { background:var(--card); border:1px solid var(--border); border-radius:7px; padding:0.5rem 0.6rem; margin-bottom:0.4rem; font-size:0.75rem; cursor:pointer; transition:border-color 0.12s; line-height:1.3; }
  .mini-card:hover { border-color:rgba(255,255,255,0.14); }
  .mini-card-meta { display:flex; gap:0.25rem; margin-top:0.3rem; flex-wrap:wrap; }
  .mini-empty { font-size:0.68rem; color:rgba(107,114,128,0.5); padding:0.25rem 0; }

  /* List view */
  .tasks-list-group { margin-bottom:1.5rem; }
  .tasks-list-group-header { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); margin-bottom:0.5rem; padding-bottom:0.35rem; border-bottom:1px solid var(--border); }
  .task-row { display:flex; align-items:center; gap:0.6rem; padding:0.6rem 0.5rem; border-radius:7px; cursor:pointer; transition:background 0.12s; }
  .task-row:hover { background:rgba(255,255,255,0.04); }
  .task-row-check { width:16px; height:16px; border-radius:50%; border:1.5px solid var(--border); flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.15s; cursor:pointer; font-size:0.65rem; }
  .task-row-check.done { background:var(--green); border-color:var(--green); }
  .task-row-name { flex:1; font-size:0.83rem; }
  .task-row-name.done-text { text-decoration:line-through; color:var(--muted); }
  .task-row-right { display:flex; align-items:center; gap:0.4rem; }

  /* Priority badges */
  .pri-urgent { background:rgba(239,68,68,0.15);  color:#f87171; border:1px solid rgba(239,68,68,0.25); }
  .pri-high   { background:rgba(234,179,8,0.15);  color:#fbbf24; border:1px solid rgba(234,179,8,0.25); }
  .pri-medium { background:rgba(59,130,246,0.15); color:#60a5fa; border:1px solid rgba(59,130,246,0.25); }
  .pri-low    { background:rgba(107,114,128,0.12);color:var(--muted); border:1px solid var(--border); }
  .pri-badge  { font-size:0.63rem; padding:0.1rem 0.42rem; border-radius:20px; font-weight:500; white-space:nowrap; }

  /* Kanban column accent colors */
  .col-todo .kanban-col-header,.mini-col.col-todo .mini-col-header { color:#60a5fa; }
  .col-todo .kanban-count { background:rgba(59,130,246,0.15); color:#60a5fa; }
  .col-progress .kanban-col-header,.mini-col.col-progress .mini-col-header { color:#fbbf24; }
  .col-progress .kanban-count { background:rgba(234,179,8,0.15); color:#fbbf24; }
  .col-blocked .kanban-col-header,.mini-col.col-blocked .mini-col-header { color:#f87171; }
  .col-blocked .kanban-count { background:rgba(239,68,68,0.15); color:#f87171; }
  .col-done .kanban-col-header,.mini-col.col-done .mini-col-header { color:var(--muted); }
  .col-done .kanban-count { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* Modal */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:500; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.15s ease; }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:var(--bg2); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:1.75rem; width:100%; max-width:480px; max-height:90vh; overflow-y:auto; }
  .modal-title { font-size:1rem; font-weight:600; margin-bottom:1.25rem; }
  .form-row { margin-bottom:0.85rem; }
  .form-label { font-size:0.72rem; color:var(--muted); margin-bottom:0.3rem; display:block; }
  .form-input { width:100%; background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.5rem 0.65rem; font-size:0.83rem; font-family:'Inter',sans-serif; transition:border-color 0.15s; }
  .form-input:focus { outline:none; border-color:var(--accent); }
  .form-row-2col { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; }
  .modal-footer { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1.25rem; }
  .btn-cancel { padding:0.45rem 1rem; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; font-size:0.82rem; }
  .btn-cancel:hover { background:rgba(255,255,255,0.04); }
  .inline-add { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; border:1px dashed rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; color:var(--muted); font-size:0.78rem; transition:all 0.15s; margin-top:0.4rem; }
  .inline-add:hover { border-color:var(--accent); color:var(--accent); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH GATE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-logo">CDB <span>Mission Control</span></div>
    <h2 class="auth-title">Welcome back</h2>
    <p class="auth-subtitle">Enter your access code to continue</p>

    <div class="auth-field">
      <label for="auth-code-input">Access Code</label>
      <input
        type="password"
        id="auth-code-input"
        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        autocomplete="off"
        spellcheck="false"
        autofocus
      >
    </div>

    <button class="auth-btn" id="auth-submit-btn" onclick="submitAuth()">
      Request Access
    </button>

    <div class="auth-error" id="auth-error"></div>

    <div class="auth-footer">Cody Design Build Inc. Â· Private System</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP (hidden until authed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none">

<header>
  <div class="logo">CDB <span>Mission Control</span></div>
  <nav>
    <button class="active" onclick="showTab('dashboard',this)">ğŸ“Š Dashboard</button>
    <button onclick="showTab('jobs',this)">ğŸ—ï¸ Jobs</button>
    <button onclick="showTab('inbox',this)">ğŸ“¥ Cost Inbox</button>
    <button onclick="showTab('revenue',this)">ğŸ’° Revenue</button>
    <button onclick="showTab('agents',this)">ğŸ¤– Agents</button>
    <button onclick="showTab('tasks',this)">âœ… Tasks</button>
  </nav>
  <div class="header-right">
    <span id="clock"></span>
    <div class="status-dot"></div>
    <button id="signout-btn" onclick="signOut()" title="Sign out">Sign out</button>
  </div>
</header>

<main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-dashboard" class="tab-panel active">
  <div class="welcome">
    <h1 id="greeting">Good morning, David ğŸ‘‹</h1>
    <p id="date-line">Loading...</p>
  </div>

  <div id="last-updated"></div>

  <div class="metrics">
    <!-- Active Jobs -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      <div class="metric-icon">ğŸ—ï¸</div>
      <div class="metric-label">Active Jobs</div>
      <div class="metric-value" id="metric-jobs-count">â€”</div>
      <div class="metric-sub" id="metric-jobs-value">loadingâ€¦</div>
    </div>
    <!-- Cost Inbox -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">ğŸ“¥</div>
      <div class="metric-label">Cost Inbox</div>
      <div class="metric-value" id="metric-inbox-count">â€”</div>
      <div class="metric-sub">transactions to code</div>
    </div>
    <!-- Open Invoices -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">ğŸ’µ</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="metric-invoices-owed">â€”</div>
      <div class="metric-sub" id="metric-invoices-sub">loadingâ€¦</div>
    </div>
    <!-- Draft Bills (static) -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--purple),#c084fc)"></div>
      <div class="metric-icon">ğŸ“‹</div>
      <div class="metric-label">Draft Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 vendor bills pending</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header">
        <span class="card-title">Top Priorities</span>
        <button class="btn btn-ghost" style="font-size:0.72rem;padding:0.25rem 0.6rem" onclick="addPriority()">+ Add</button>
      </div>
      <div id="priorities">
        <div class="priority-item"><input type="checkbox" id="p1" onchange="toggleDone(this)"><label for="p1">Fix Phil's pairing â€” OpenClaw menubar app</label></div>
        <div class="priority-item"><input type="checkbox" id="p2" onchange="toggleDone(this)"><label for="p2">Code this week's Plaid transactions</label></div>
        <div class="priority-item"><input type="checkbox" id="p3" onchange="toggleDone(this)"><label for="p3">Send invoice to Balboa client</label></div>
        <div class="priority-item"><input type="checkbox" id="p4" onchange="toggleDone(this)"><label for="p4">Approve Graham Plastering bill ($9K)</label></div>
        <div class="priority-item"><input type="checkbox" id="p5" onchange="toggleDone(this)"><label for="p5">Invite assistant@codydesignbuild.com to Airtable</label></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><span class="card-title">Activity Feed</span></div>
      <div id="activity-feed" style="font-size:0.82rem;">
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Jerry pulled Plaid transactions</span><span style="color:var(--muted)">just now</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>JT API skill built + tested</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Phil agent created (pairing pending)</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>memory-lancedb enabled</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0"><span>Google Workspace connected</span><span style="color:var(--muted)">today</span></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOBS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-jobs" class="tab-panel">
  <h2>Active Jobs</h2>
  <div id="jobs-list">
    <div class="state-loading">Loading jobsâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COST INBOX TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-inbox" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
    <h2 style="margin:0">Cost Inbox â€” Plaid Transactions</h2>
    <span class="badge badge-red" id="inbox-badge">â€”</span>
  </div>

  <div class="card" style="margin-bottom:1rem">
    <div style="font-size:0.82rem;color:var(--muted)">
      These are bank transactions pulled from <strong style="color:var(--text)">Business Checking ...4687</strong> via Plaid that haven't been coded to a job yet.
    </div>
  </div>

  <div id="inbox-list">
    <div class="state-loading">Loading transactionsâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REVENUE TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-revenue" class="tab-panel">
  <h2>Revenue Overview</h2>
  <div class="metrics" style="grid-template-columns:repeat(3,1fr)">
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">ğŸ“Š</div>
      <div class="metric-label">Total Pipeline</div>
      <div class="metric-value" id="rev-pipeline">â€”</div>
      <div class="metric-sub" id="rev-pipeline-sub">loadingâ€¦</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--yellow),#fde047)"></div>
      <div class="metric-icon">ğŸ§¾</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="rev-open-invoices">â€”</div>
      <div class="metric-sub" id="rev-invoices-sub">loadingâ€¦</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">ğŸ“¤</div>
      <div class="metric-label">Draft Vendor Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 bills to approve</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span class="card-title">Open Customer Invoices</span></div>
    <table>
      <thead><tr><th>Job</th><th>Invoice</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody id="invoice-rows">
        <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">Draft Vendor Bills</span></div>
    <table>
      <thead><tr><th>Vendor</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>Graham Plastering</td><td>$9,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
        <tr><td>Other</td><td>$32,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AGENTS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-agents" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">
    <h2 style="margin:0">Agent Command Center</h2>
    <div class="agents-live-badge" id="agents-live-badge">
      <div class="dot dot-gray"></div><span>Connectingâ€¦</span>
    </div>
  </div>

  <div class="agent-grid" id="agent-grid">
    <div style="color:var(--muted);font-size:0.85rem;padding:2rem;grid-column:1/-1;text-align:center">Loading agentsâ€¦</div>
  </div>

  <div class="card" id="system-status-card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">System Status</span></div>
    <table>
      <thead><tr><th>Component</th><th>Status</th><th>Detail</th></tr></thead>
      <tbody id="system-status-body">
        <tr><td>Gateway</td><td><span class="badge badge-muted">Checkingâ€¦</span></td><td></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TASKS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-tasks" class="tab-panel">

  <div class="tasks-header">
    <h2>âœ… Tasks</h2>
    <div class="view-toggle">
      <button class="view-btn active" id="view-kanban-btn" onclick="setTaskView('kanban')">â¬œ Kanban</button>
      <button class="view-btn" id="view-list-btn" onclick="setTaskView('list')">â˜° List</button>
    </div>
    <button class="btn" onclick="openAddTask()">+ Add Task</button>
  </div>

  <!-- Project switcher -->
  <div class="project-switcher" id="project-switcher"><!-- rendered by JS --></div>

  <!-- Content area -->
  <div id="tasks-content">
    <div class="state-loading">Loading tasksâ€¦</div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD / EDIT TASK MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="add-task-modal">
  <div class="modal-box">
    <div class="modal-title">New Task</div>
    <div class="form-row">
      <label class="form-label">Task name *</label>
      <input class="form-input" id="t-name" placeholder="What needs to be done?" />
    </div>
    <div class="form-row">
      <label class="form-label">Description</label>
      <textarea class="form-input" id="t-desc" rows="2" placeholder="Optional detailsâ€¦"></textarea>
    </div>
    <div class="form-row-2col">
      <div class="form-row">
        <label class="form-label">Status</label>
        <select class="form-input" id="t-status">
          <option value="To Do">To Do</option>
          <option value="In Progress">In Progress</option>
          <option value="Blocked">Blocked</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Priority</label>
        <select class="form-input" id="t-priority">
          <option value="Low">Low</option>
          <option value="Medium" selected>Medium</option>
          <option value="High">High</option>
          <option value="Urgent">Urgent</option>
        </select>
      </div>
    </div>
    <div class="form-row-2col">
      <div class="form-row">
        <label class="form-label">Project</label>
        <select class="form-input" id="t-project">
          <!-- populated by JS -->
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Assignee</label>
        <select class="form-input" id="t-assignee">
          <option value="">Unassigned</option>
          <option value="David">David</option>
          <option value="Jerry">Jerry</option>
          <option value="Phil">Phil</option>
          <option value="Bobby">Bobby</option>
          <option value="Mickey">Mickey</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">Due Date</label>
      <input class="form-input" type="date" id="t-due" style="max-width:200px" />
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="add-task-delete-btn" style="color:var(--red);border-color:rgba(239,68,68,0.3);display:none" onclick="deleteCurrentTask()">Delete</button>
      <button class="btn-cancel" onclick="closeAddTask()">Cancel</button>
      <button class="btn" id="add-task-submit-btn" onclick="submitAddTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NEW PROJECT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="new-project-modal">
  <div class="modal-box" style="max-width:380px">
    <div class="modal-title">New Project</div>
    <div class="form-row">
      <label class="form-label">Project name *</label>
      <input class="form-input" id="np-name" placeholder="e.g. Oakland Kitchen, Siri Shortcut" />
    </div>
    <div class="form-row">
      <label class="form-label">Type</label>
      <select class="form-input" id="np-type">
        <option value="jobs">ğŸ—ï¸ Construction Job</option>
        <option value="dev">ğŸ’» Dev / Tech</option>
        <option value="org">ğŸ¢ Org / Admin</option>
        <option value="other">ğŸ“Œ Other</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeNewProject()">Cancel</button>
      <button class="btn" onclick="submitNewProject()">Create Project</button>
    </div>
  </div>
</div>

</main>
</div><!-- /#app -->

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TOKEN_KEY = 'mc_token';

function getToken() {
  return localStorage.getItem(TOKEN_KEY);
}

function showApp() {
  document.getElementById('auth-overlay').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
  loadData();
}

function showAuthOverlay() {
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('app').style.display = 'none';
  setTimeout(() => document.getElementById('auth-code-input').focus(), 100);
}

function setAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}

function clearAuthError() {
  document.getElementById('auth-error').classList.remove('show');
}

async function submitAuth() {
  const input = document.getElementById('auth-code-input');
  const btn   = document.getElementById('auth-submit-btn');
  const code  = input.value.trim();

  if (!code) { setAuthError('Please enter your access code.'); return; }

  clearAuthError();
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Verifyingâ€¦';

  try {
    const res  = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code }),
    });
    const data = await res.json();

    if (data.ok && data.token) {
      localStorage.setItem(TOKEN_KEY, data.token);
      input.value = '';
      showApp();
    } else {
      setAuthError(data.error || 'Access denied. Check your code and try again.');
      input.value = '';
      input.focus();
    }
  } catch (err) {
    setAuthError('Connection error â€” please try again.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Request Access';
  }
}

function signOut() {
  localStorage.removeItem(TOKEN_KEY);
  showAuthOverlay();
}

// Allow Enter key on the access code input
document.getElementById('auth-code-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitAuth();
});

// Boot: check token
(function bootAuth() {
  const token = getToken();
  if (token) {
    // Token exists â€” trust it and show app (server validates on every API call)
    showApp();
  } else {
    showAuthOverlay();
  }
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK & GREETING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateClock() {
  const now = new Date();
  const clockEl = document.getElementById('clock');
  if (clockEl) {
    clockEl.textContent = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }
  const hour = now.getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  const greetEl = document.getElementById('greeting');
  if (greetEl) greetEl.textContent = `${greeting}, David ğŸ‘‹`;
  const dateEl = document.getElementById('date-line');
  if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' Â· Cody Design Build Inc.';
}
updateClock();
setInterval(updateClock, 1000);


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'tasks') fetchTasks();
  if (name === 'agents') fetchAgents();
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRIORITIES (localStorage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleDone(cb) {
  cb.nextElementSibling.classList.toggle('done', cb.checked);
  savePriorities();
}
function addPriority() {
  const text = prompt('New priority:');
  if (!text) return;
  const id  = 'p' + Date.now();
  const div = document.createElement('div');
  div.className = 'priority-item';
  div.innerHTML = `<input type="checkbox" id="${id}" onchange="toggleDone(this)"><label for="${id}">${text}</label>`;
  document.getElementById('priorities').appendChild(div);
  savePriorities();
}
function savePriorities() {
  const items = [...document.querySelectorAll('#priorities .priority-item')].map(el => ({
    text: el.querySelector('label').textContent,
    done: el.querySelector('input').checked,
  }));
  localStorage.setItem('mc_priorities', JSON.stringify(items));
}
function loadPriorities() {
  const saved = localStorage.getItem('mc_priorities');
  if (!saved) return;
  try {
    const items     = JSON.parse(saved);
    const container = document.getElementById('priorities');
    container.innerHTML = '';
    items.forEach((item, i) => {
      const id  = 'p' + i;
      const div = document.createElement('div');
      div.className = 'priority-item';
      div.innerHTML = `<input type="checkbox" id="${id}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"><label for="${id}" class="${item.done ? 'done' : ''}">${item.text}</label>`;
      container.appendChild(div);
    });
  } catch(e) {}
}
loadPriorities();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURRENCY FORMATTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtCurrency(n) {
  if (n === null || n === undefined || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1_000_000) {
    return sign + '$' + (abs / 1_000_000).toFixed(2).replace(/\.?0+$/, '') + 'M';
  }
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function fmtCurrencyFull(n) {
  if (n === null || n === undefined || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtDate(str) {
  if (!str) return 'â€”';
  try {
    return new Date(str).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
  } catch { return str; }
}

function progressColor(pct) {
  if (pct >= 90) return 'var(--red)';
  if (pct >= 70) return 'var(--yellow)';
  return 'var(--accent)';
}

function invoiceStatusBadge(status) {
  if (!status) return '<span class="badge badge-muted">Unknown</span>';
  const s = status.toLowerCase();
  if (s.includes('paid'))    return '<span class="badge badge-green">Paid</span>';
  if (s.includes('partial')) return '<span class="badge badge-blue">Partial</span>';
  if (s.includes('draft'))   return '<span class="badge badge-orange">Draft</span>';
  if (s.includes('void'))    return '<span class="badge badge-muted">Void</span>';
  return `<span class="badge badge-yellow">${status}</span>`;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderJobs(data) {
  const container = document.getElementById('jobs-list');
  const jobs = data.jobs || [];

  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No active jobs found.</div>';
    return;
  }

  container.innerHTML = jobs.map(job => {
    const contractValue = Number(job.contractValue) || 0;
    const billed        = Number(job.billed)        || 0;
    const owed          = Number(job.owed)           || 0;
    const pct           = contractValue > 0 ? Math.min(100, Math.round((billed / contractValue) * 100)) : 0;
    const color         = progressColor(pct);
    const customer      = job.customer || 'â€”';
    const jobNum        = job.number   ? `Job #${job.number}` : (job.id || '');

    return `
      <div class="job-card">
        <div class="job-header">
          <div>
            <div class="job-name">${escHtml(job.name || 'Untitled Job')}</div>
            <div class="job-number">${escHtml(jobNum)} Â· ${escHtml(customer)}</div>
          </div>
          <span class="badge badge-green">Active</span>
        </div>
        <div class="job-budget-row"><span>Contract Value</span><strong>${fmtCurrency(contractValue)}</strong></div>
        <div class="job-budget-row"><span>Billed So Far</span><strong>${fmtCurrency(billed)}</strong></div>
        <div class="job-budget-row"><span>Outstanding</span><strong style="color:${owed > 0 ? 'var(--yellow)' : 'var(--muted)'}">${fmtCurrency(owed)}</strong></div>
        <div class="progress-bar" style="margin-top:0.6rem">
          <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.4rem">${pct}% billed of contract</div>
      </div>`;
  }).join('');
}

function renderInbox(data) {
  const transactions = data.transactions || [];
  const count        = data.count ?? transactions.length;
  const totalAmt     = data.totalAmount;

  // Update header badge
  document.getElementById('inbox-badge').textContent =
    count > 0 ? `${count} uncoded` : '0 uncoded';

  const container = document.getElementById('inbox-list');

  if (!transactions.length) {
    container.innerHTML = '<div class="state-loading">No uncoded transactions â€” inbox is clear! âœ…</div>';
    return;
  }

  container.innerHTML = transactions.map(tx => {
    const amount   = Number(tx.amount) || 0;
    const isDebit  = amount < 0;
    const cls      = isDebit ? 'debit' : 'credit';
    const dateStr  = fmtDate(tx.date);
    const account  = tx.account ? ` Â· ${escHtml(tx.account)}` : '';

    return `
      <div class="inbox-item">
        <div class="inbox-left">
          <div class="inbox-vendor">${escHtml(tx.name || 'â€”')}</div>
          <div class="inbox-desc">${dateStr}${account}</div>
        </div>
        <div class="inbox-amount ${cls}">${isDebit ? '-' : '+'}${fmtCurrency(Math.abs(amount))}</div>
      </div>`;
  }).join('');
}

function renderInvoices(data) {
  const invoices = data.invoices || [];
  const tbody    = document.getElementById('invoice-rows');

  if (!invoices.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">No open invoices.</td></tr>';
    return;
  }

  tbody.innerHTML = invoices.map(inv => {
    const jobName = inv.jobName || 'â€”';
    const invName = inv.name   || (inv.number ? `Invoice #${inv.number}` : 'â€”');
    const total   = fmtCurrency(Number(inv.total) || 0);
    const date    = fmtDate(inv.date);
    const badge   = invoiceStatusBadge(inv.status);
    return `<tr>
      <td>${escHtml(jobName)}</td>
      <td>${escHtml(invName)}</td>
      <td style="color:var(--muted);font-size:0.78rem">${date}</td>
      <td>${total}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE DATA LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  const token = getToken();

  const headers = token
    ? { 'Authorization': `Bearer ${token}` }
    : {};

  let jobsData, inboxData, invoicesData;

  try {
    [jobsData, inboxData, invoicesData] = await Promise.all([
      fetch('/api/jobs',     { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/inbox',    { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/invoices', { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
    ]);
  } catch (e) {
    console.error('loadData failed:', e);
  }

  // â”€â”€ JOBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (jobsData) {
    const count = jobsData.total ?? (jobsData.jobs || []).length;
    const val   = Number(jobsData.totalValue) || 0;

    document.getElementById('metric-jobs-count').textContent = count !== null ? count : 'â€”';
    document.getElementById('metric-jobs-value').textContent =
      val > 0 ? `${fmtCurrency(val)} total value` : 'no value data';

    // Revenue tab pipeline
    const revPipeline = document.getElementById('rev-pipeline');
    if (revPipeline) revPipeline.textContent = val > 0 ? fmtCurrency(val) : 'â€”';
    const revPipelineSub = document.getElementById('rev-pipeline-sub');
    if (revPipelineSub) revPipelineSub.textContent = `${count} active job${count !== 1 ? 's' : ''}`;

    renderJobs(jobsData);
  } else {
    document.getElementById('metric-jobs-count').textContent = 'â€”';
    document.getElementById('metric-jobs-value').textContent = 'failed to load';
    document.getElementById('jobs-list').innerHTML =
      '<div class="state-error">Could not load jobs â€” API unavailable.</div>';
  }

  // â”€â”€ INBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (inboxData) {
    const count = inboxData.count ?? (inboxData.transactions || []).length;
    document.getElementById('metric-inbox-count').textContent = count;
    renderInbox(inboxData);
  } else {
    document.getElementById('metric-inbox-count').textContent = 'â€”';
    document.getElementById('inbox-list').innerHTML =
      '<div class="state-error">Could not load inbox â€” API unavailable.</div>';
    document.getElementById('inbox-badge').textContent = 'error';
  }

  // â”€â”€ INVOICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (invoicesData) {
    const owed  = Number(invoicesData.totalOwed) || 0;
    const count = invoicesData.count ?? (invoicesData.invoices || []).length;

    document.getElementById('metric-invoices-owed').textContent = fmtCurrency(owed);
    document.getElementById('metric-invoices-sub').textContent =
      `${count} invoice${count !== 1 ? 's' : ''} outstanding`;

    // Revenue tab open invoices
    const revOwed = document.getElementById('rev-open-invoices');
    if (revOwed) revOwed.textContent = fmtCurrency(owed);
    const revInvSub = document.getElementById('rev-invoices-sub');
    if (revInvSub) revInvSub.textContent = `${count} invoice${count !== 1 ? 's' : ''} pending`;

    renderInvoices(invoicesData);
  } else {
    document.getElementById('metric-invoices-owed').textContent = 'â€”';
    document.getElementById('metric-invoices-sub').textContent = 'failed to load';
    document.getElementById('invoice-rows').innerHTML =
      '<tr><td colspan="5" style="text-align:center;color:var(--red);padding:1.5rem">Could not load invoices â€” API unavailable.</td></tr>';
  }

  // â”€â”€ LAST UPDATED TIMESTAMP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ts = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
  const lastUpdatedEl = document.getElementById('last-updated');
  if (lastUpdatedEl) {
    lastUpdatedEl.textContent = `Last updated: ${ts}`;
  }
}

// Auto-refresh every 5 minutes
setInterval(loadData, 5 * 60 * 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AGENTS â€” Live Status + Model Switcher
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LOCAL_API = 'http://127.0.0.1:18900';
const MODELS = [
  { id: 'anthropic/claude-sonnet-4-6',  label: 'Claude Sonnet 4.6 (default)' },
  { id: 'anthropic/claude-opus-4-5',    label: 'Claude Opus 4.5' },
  { id: 'anthropic/claude-haiku-4-5',   label: 'Claude Haiku 4.5' },
  { id: 'openai/gpt-4o',                label: 'GPT-4o' },
  { id: 'openai/gpt-4o-mini',           label: 'GPT-4o Mini' },
  { id: 'openai/o3-mini',               label: 'o3-mini' },
];

let agentsData = null;          // last fetched payload
let agentModelDraft = {};       // { agentId: selectedModel } â€” unsaved changes
let localAvailable = false;

function fmtAgo(seconds) {
  if (!seconds) return 'never';
  if (seconds < 60) return `${seconds}s ago`;
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function statusMeta(agent) {
  if (!agent.gatewayUp) return { dot: 'dot-gray',   label: 'Offline',  color: 'var(--muted)' };
  if (agent.status === 'active')  return { dot: 'dot-green',  label: 'Active',   color: 'var(--green)' };
  if (agent.status === 'recent')  return { dot: 'dot-yellow', label: 'Idle',     color: 'var(--yellow)' };
  return { dot: 'dot-gray',   label: 'Idle',     color: 'var(--muted)' };
}

function renderAgentCard(agent) {
  const sm = statusMeta(agent);
  const draft = agentModelDraft[agent.id] ?? agent.model;
  const isDirty = draft !== agent.model;
  const channelStr = agent.channel ? ` Â· ${agent.channel}` : '';

  const modelOptions = MODELS.map(m =>
    `<option value="${m.id}" ${draft === m.id ? 'selected' : ''}>${m.label}</option>`
  ).join('');

  const caps = (agent.capabilities || [])
    .map(c => `<span class="badge badge-muted">${c}</span>`)
    .join('');

  return `
  <div class="agent-card ${agent.status === 'active' ? 'agent-active' : ''}" id="card-${agent.id}">
    <div class="agent-header">
      <div class="agent-emoji">${agent.emoji}</div>
      <div>
        <div class="agent-name">${agent.name}</div>
        <div class="agent-role">${agent.role}</div>
      </div>
    </div>
    <div class="agent-status-row">
      <div class="dot ${sm.dot}"></div>
      <span style="color:${sm.color}">${sm.label}</span>
      <span style="color:var(--muted)">${channelStr}</span>
    </div>
    <div class="agent-last-active">Last active: ${fmtAgo(agent.lastActiveAgo)}</div>
    <div class="agent-caps">${caps}</div>
    <div class="agent-model-row">
      <span class="agent-model-label">Model</span>
      <select class="model-select" id="model-select-${agent.id}"
        onchange="onModelChange('${agent.id}', this.value)">
        ${modelOptions}
      </select>
      <button class="model-save-btn" id="model-save-${agent.id}"
        onclick="saveModel('${agent.id}')"
        ${isDirty ? '' : 'disabled'}>
        Save
      </button>
    </div>
  </div>`;
}

function renderAgents(data) {
  const grid = document.getElementById('agent-grid');
  if (!grid) return;
  grid.innerHTML = data.agents.map(renderAgentCard).join('');

  // System status table
  const tbody = document.getElementById('system-status-body');
  if (tbody) {
    const gw = data.gatewayStatus === 'running';
    tbody.innerHTML = `
      <tr><td>Gateway</td>
          <td><span class="badge ${gw ? 'badge-green' : 'badge-red'}">${gw ? 'Running' : 'Stopped'}</span></td>
          <td style="color:var(--muted);font-size:0.78rem">ws://127.0.0.1:18789 Â· Telegram connected</td></tr>
      <tr><td>Memory</td>
          <td><span class="badge badge-green">Active</span></td>
          <td style="color:var(--muted);font-size:0.78rem">memory-lancedb Â· text-embedding-3-small</td></tr>
      <tr><td>JT API</td>
          <td><span class="badge badge-green">Working</span></td>
          <td style="color:var(--muted);font-size:0.78rem">Pave Â· grant key valid Â· Org 22NeVb7CK2sW</td></tr>
      <tr><td>Google Workspace</td>
          <td><span class="badge badge-green">Connected</span></td>
          <td style="color:var(--muted);font-size:0.78rem">assistant@codydesignbuild.com</td></tr>
      <tr><td>Local Status API</td>
          <td><span class="badge badge-green">Online</span></td>
          <td style="color:var(--muted);font-size:0.78rem">127.0.0.1:18900 Â· live data</td></tr>`;
  }
}

function renderAgentsFallback() {
  const grid = document.getElementById('agent-grid');
  if (grid) {
    grid.innerHTML = `<div style="color:var(--muted);font-size:0.82rem;padding:1.5rem;grid-column:1/-1;text-align:center">
      âš ï¸ Local status server unreachable (port 18900).<br>
      Live status only available when on the Mac mini or local network.
    </div>`;
  }
}

function setLiveBadge(live) {
  const badge = document.getElementById('agents-live-badge');
  if (!badge) return;
  badge.innerHTML = live
    ? `<div class="dot dot-green"></div><span style="color:var(--green)">Live</span>`
    : `<div class="dot dot-gray"></div><span>Offline â€” remote view</span>`;
}

async function fetchAgents() {
  try {
    const res = await fetch(`${LOCAL_API}/api/agents`, { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    agentsData = data;
    localAvailable = true;
    setLiveBadge(true);
    renderAgents(data);
  } catch {
    localAvailable = false;
    setLiveBadge(false);
    if (!agentsData) renderAgentsFallback();
  }
}

function onModelChange(agentId, value) {
  agentModelDraft[agentId] = value;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) btn.disabled = (value === (agentsData?.agents?.find(a => a.id === agentId)?.model));
}

async function saveModel(agentId) {
  const model = agentModelDraft[agentId];
  if (!model) return;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
  try {
    const res = await fetch(`${LOCAL_API}/api/agents/${agentId}/model`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model }),
      signal: AbortSignal.timeout(5000),
    });
    const data = await res.json();
    if (data.ok) {
      delete agentModelDraft[agentId];
      if (btn) { btn.textContent = 'âœ“ Saved'; setTimeout(() => { if (btn) { btn.textContent = 'Save'; } }, 2000); }
      // Refresh agents after a tick
      setTimeout(fetchAgents, 300);
    } else {
      if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
    }
  } catch {
    if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
  }
}

// Initial load + poll every 10 seconds
fetchAgents();
setInterval(fetchAgents, 10 * 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS â€” Project-based Kanban
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Project config (source of truth â€” add new projects here) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROJECTS_CONFIG = [
  { id:'balboa',   name:'Balboa',             group:'jobs', icon:'ğŸ ' },
  { id:'teresita', name:'Teresita',            group:'jobs', icon:'ğŸ ' },
  { id:'25th-ave', name:'25th Ave',            group:'jobs', icon:'ğŸ ' },
  { id:'mc-dev',   name:'Mission Control Dev', group:'dev',  icon:'ğŸ’»' },
  { id:'hytale',   name:'Hytale Mod',          group:'dev',  icon:'ğŸ®' },
];

// User-added projects stored in localStorage
function getCustomProjects() {
  try { return JSON.parse(localStorage.getItem('mc_projects') || '[]'); } catch { return []; }
}
function saveCustomProjects(list) { localStorage.setItem('mc_projects', JSON.stringify(list)); }

function allProjects() {
  return [...PROJECTS_CONFIG, ...getCustomProjects()];
}

function projectByName(name) {
  return allProjects().find(p => p.name === name) || null;
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allTasks    = [];
let taskView    = 'kanban';
let selProject  = null;    // null=All, '__jobs__', '__dev__', '__org__', or project id
let tasksLoaded = false;

const PRI_ORDER = { Urgent:0, High:1, Medium:2, Low:3 };
function priClass(p) {
  return { Urgent:'pri-urgent', High:'pri-high', Medium:'pri-medium', Low:'pri-low' }[p] || 'pri-low';
}
function fmtDateShort(d) {
  if (!d) return '';
  const [,m,day] = d.split('-');
  return `${parseInt(m)}/${parseInt(day)}`;
}

// â”€â”€ Project switcher rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProjectSwitcher() {
  const projs = allProjects();
  const jobs  = projs.filter(p => p.group === 'jobs');
  const devs  = projs.filter(p => p.group === 'dev');
  const orgs  = projs.filter(p => p.group === 'org' || p.group === 'other');

  function pill(id, label, extraClass='') {
    const active = selProject === id ? 'active' : '';
    return `<button class="proj-pill ${extraClass} ${active}" onclick="selectProject('${id}')">${label}</button>`;
  }

  let html = pill(null, 'ğŸ—‚ï¸ All');
  html += '<div class="proj-sep"></div>';
  html += pill('__jobs__', 'ğŸ—ï¸ Jobs', 'group');
  jobs.forEach(p => { html += pill(p.id, p.name); });
  if (devs.length || orgs.filter(p=>p.group==='dev').length) {
    html += '<div class="proj-sep"></div>';
    html += pill('__dev__', 'ğŸ’» Dev', 'group');
    devs.forEach(p => { html += pill(p.id, p.name); });
  }
  html += '<div class="proj-sep"></div>';
  html += pill('__org__', 'ğŸ¢ Org', 'group');
  orgs.filter(p => p.group === 'org').forEach(p => { html += pill(p.id, p.name); });
  html += '<div class="proj-sep"></div>';
  html += `<button class="proj-add" onclick="openNewProject()">+ New Project</button>`;

  document.getElementById('project-switcher').innerHTML = html;
}

function selectProject(id) {
  selProject = id === 'null' || id === null ? null : id;
  renderProjectSwitcher();
  renderTasks();
}

// â”€â”€ Task filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterByProject(tasks) {
  if (selProject === null) return tasks;
  if (selProject === '__jobs__') {
    const jobNames = allProjects().filter(p => p.group === 'jobs').map(p => p.name);
    return tasks.filter(t => jobNames.includes(t.job));
  }
  if (selProject === '__dev__') {
    const devNames = allProjects().filter(p => p.group === 'dev').map(p => p.name);
    return tasks.filter(t => devNames.includes(t.job));
  }
  if (selProject === '__org__') {
    const nonOrgNames = allProjects().filter(p => p.group !== 'org').map(p => p.name);
    return tasks.filter(t => !t.job || !nonOrgNames.includes(t.job));
  }
  // Specific project id
  const proj = allProjects().find(p => p.id === selProject);
  if (!proj) return tasks;
  return tasks.filter(t => t.job === proj.name);
}

// â”€â”€ Main render dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasks() {
  const content = document.getElementById('tasks-content');
  if (!content) return;

  const filtered = filterByProject(allTasks);

  // Jobs group â†’ multi-board
  if (selProject === '__jobs__') {
    renderMultiBoard(filtered, content);
    return;
  }

  if (taskView === 'kanban') {
    content.innerHTML = `<div class="kanban-board" id="tasks-kanban"></div>`;
    renderKanban(filtered, document.getElementById('tasks-kanban'));
  } else {
    content.innerHTML = `<div id="tasks-list"></div>`;
    renderList(filtered, document.getElementById('tasks-list'));
  }
}

function setTaskView(view) {
  taskView = view;
  document.getElementById('view-kanban-btn').classList.toggle('active', view === 'kanban');
  document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
  renderTasks();
}

// â”€â”€ Kanban â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NEXT_STATUS = {
  'To Do':       [{ label:'â–¶ Start', status:'In Progress' }, { label:'âœ— Block', status:'Blocked' }],
  'In Progress': [{ label:'âœ“ Done',  status:'Done'        }, { label:'âœ— Block', status:'Blocked' }],
  'Blocked':     [{ label:'â–¶ Resume',status:'In Progress' }, { label:'âœ“ Done',  status:'Done' }],
  'Done':        [{ label:'â†© Reopen',status:'To Do'       }],
};

function renderKanban(tasks, container) {
  const cols = {
    'To Do':       { key:'col-todo',     label:'To Do',       cards:[] },
    'In Progress': { key:'col-progress', label:'In Progress', cards:[] },
    'Blocked':     { key:'col-blocked',  label:'Blocked',     cards:[] },
    'Done':        { key:'col-done',     label:'Done',        cards:[] },
  };
  tasks.forEach(t => { if (cols[t.status]) cols[t.status].cards.push(t); });

  container.innerHTML = Object.values(cols).map(col => {
    const cards = col.cards
      .sort((a,b) => (PRI_ORDER[a.priority]??3) - (PRI_ORDER[b.priority]??3))
      .map(t => buildCard(t, false)).join('');

    const addBtn = col.key !== 'col-done'
      ? `<div class="inline-add" onclick="openAddTask({status:'${col.label}'})"><span>+</span> Add</div>`
      : '';

    return `<div class="kanban-col ${col.key} kanban-drop-zone"
        data-status="${col.label}"
        ondragover="onColDragOver(event)" ondragenter="onColDragEnter(event)"
        ondragleave="onColDragLeave(event)" ondrop="onColDrop(event)">
      <div class="kanban-col-header">
        <span>${col.label}</span>
        <span class="kanban-count">${col.cards.length}</span>
      </div>
      ${cards}${addBtn}
    </div>`;
  }).join('');
}

function buildCard(t, mini) {
  const proj = projectByName(t.job);
  const showProject = (selProject === null || selProject === '__jobs__' || selProject === '__dev__') && t.job;
  const nextBtns = !mini ? (NEXT_STATUS[t.status] || [])
    .map(n => `<button class="status-btn" onclick="event.stopPropagation();quickComplete('${t.id}','${n.status}')">${n.label}</button>`)
    .join('') : '';

  if (mini) {
    return `<div class="mini-card" onclick="openEditTask('${t.id}')">
      ${escHtml(t.name)}
      <div class="mini-card-meta">
        <span class="badge pri-badge ${priClass(t.priority)}" style="font-size:0.58rem">${t.priority}</span>
        ${t.assignee ? `<span style="font-size:0.62rem;color:var(--muted)">${t.assignee}</span>` : ''}
      </div>
    </div>`;
  }

  return `<div class="task-card" draggable="true" data-task-id="${t.id}" data-status="${escHtml(t.status)}"
      ondragstart="onCardDragStart(event)" ondragend="onCardDragEnd(event)">
    <div class="task-card-name" onclick="openEditTask('${t.id}')">${escHtml(t.name)}</div>
    <div class="task-card-meta">
      <span class="badge pri-badge ${priClass(t.priority)}">${t.priority}</span>
      ${showProject ? `<span class="task-card-tag">${proj ? proj.icon : 'ğŸ“Œ'} ${escHtml(t.job)}</span>` : ''}
      ${t.assignee ? `<span class="task-card-tag">ğŸ‘¤ ${t.assignee}</span>` : ''}
      ${t.dueDate ? `<span class="task-card-tag">ğŸ“… ${fmtDateShort(t.dueDate)}</span>` : ''}
    </div>
    ${nextBtns ? `<div class="task-card-actions">${nextBtns}</div>` : ''}
  </div>`;
}

// â”€â”€ Multi-board (Jobs group) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMultiBoard(tasks, container) {
  const jobs = allProjects().filter(p => p.group === 'jobs');
  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No job projects configured.</div>';
    return;
  }

  container.innerHTML = `<div class="multi-board">${jobs.map(proj => {
    const jobTasks = tasks.filter(t => t.job === proj.name);
    const statuses = ['To Do','In Progress','Blocked','Done'];
    const colKeys  = ['col-todo','col-progress','col-blocked','col-done'];
    const cols = statuses.map((s, i) => {
      const cards = jobTasks.filter(t => t.status === s);
      return `<div class="mini-col ${colKeys[i]} kanban-drop-zone" data-status="${s}"
            ondragover="onColDragOver(event)" ondragenter="onColDragEnter(event)"
            ondragleave="onColDragLeave(event)" ondrop="onColDrop(event)">
          <div class="mini-col-header">
            <span>${s}</span>
            <span class="kanban-count">${cards.length || ''}</span>
          </div>
          ${cards.map(t => buildCard(t, true)).join('') || `<div class="mini-empty">Empty</div>`}
        </div>`;
    }).join('');
    return `<div class="mini-board">
      <div class="mini-board-header">
        <span class="mini-board-title">${proj.icon} ${escHtml(proj.name)}</span>
        <button class="mini-board-add" onclick="openAddTask({project:'${proj.id}'})">+ Add task</button>
      </div>
      <div class="mini-kanban">${cols}</div>
    </div>`;
  }).join('')}</div>`;
}

// â”€â”€ List view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList(tasks, container) {
  const groups = {};
  tasks.forEach(t => {
    const key = t.job || 'ğŸ¢ Org';
    if (!groups[key]) groups[key] = [];
    groups[key].push(t);
  });

  const sortedKeys = Object.keys(groups).sort((a,b) => {
    if (a === 'ğŸ¢ Org') return -1;
    if (b === 'ğŸ¢ Org') return 1;
    return a.localeCompare(b);
  });

  container.innerHTML = sortedKeys.map(key => {
    const sorted = groups[key].sort((a,b) => (PRI_ORDER[a.priority]??3) - (PRI_ORDER[b.priority]??3));
    const rows = sorted.map(t => {
      const done = t.status === 'Done';
      return `<div class="task-row" onclick="openEditTask('${t.id}')">
        <div class="task-row-check ${done?'done':''}" onclick="event.stopPropagation();quickComplete('${t.id}','${done?'To Do':'Done'}')">${done?'âœ“':''}</div>
        <div class="task-row-name ${done?'done-text':''}">${escHtml(t.name)}</div>
        <div class="task-row-right">
          <span class="badge pri-badge ${priClass(t.priority)}">${t.priority}</span>
          ${t.assignee ? `<span style="font-size:0.72rem;color:var(--muted)">${t.assignee}</span>` : ''}
          ${t.dueDate ? `<span style="font-size:0.72rem;color:var(--muted)">ğŸ“… ${fmtDateShort(t.dueDate)}</span>` : ''}
        </div>
      </div>`;
    }).join('');
    const proj = projectByName(key);
    return `<div class="tasks-list-group">
      <div class="tasks-list-group-header">${proj ? proj.icon + ' ' : ''}${key}</div>
      ${rows}
    </div>`;
  }).join('') || '<div class="state-loading">No tasks found.</div>';
}

// â”€â”€ Drag and drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragTaskId = null;
function onCardDragStart(e) {
  _dragTaskId = e.currentTarget.dataset.taskId;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _dragTaskId);
}
function onCardDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.kanban-col,.mini-col').forEach(c => c.classList.remove('drag-over'));
  _dragTaskId = null;
}
function onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function onColDragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function onColDragLeave(e) { if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over'); }
function onColDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const taskId = e.dataTransfer.getData('text/plain') || _dragTaskId;
  const newStatus = e.currentTarget.dataset.status;
  if (taskId && newStatus) quickComplete(taskId, newStatus);
}

// â”€â”€ Fetch + quick complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTasks() {
  try {
    const res = await fetch('/api/tasks');
    const data = await res.json();
    if (data.tasks) {
      allTasks = data.tasks;
      tasksLoaded = true;
      renderProjectSwitcher();
      renderTasks();
    }
  } catch (err) {
    if (!tasksLoaded) {
      const c = document.getElementById('tasks-content');
      if (c) c.innerHTML = `<div class="state-error">Failed to load tasks: ${err.message}</div>`;
    }
  }
}
setInterval(fetchTasks, 30 * 1000);

async function quickComplete(id, newStatus) {
  const t = allTasks.find(x => x.id === id);
  if (t) t.status = newStatus;
  renderTasks();
  try {
    await fetch(`/api/tasks?id=${id}`, {
      method:'PATCH', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ status: newStatus })
    });
  } catch {}
}

// â”€â”€ Add / Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editTaskId = null;

function populateProjectDropdown(selectedName) {
  const sel = document.getElementById('t-project');
  if (!sel) return;
  const projs = allProjects();
  sel.innerHTML = `<option value="">â€” None (Org) â€”</option>` +
    projs.map(p => `<option value="${escHtml(p.name)}" ${selectedName===p.name?'selected':''}>${p.icon} ${escHtml(p.name)}</option>`).join('');
}

function openAddTask(preset = {}) {
  _editTaskId = null;
  document.querySelector('#add-task-modal .modal-title').textContent = 'New Task';
  document.getElementById('add-task-submit-btn').textContent = 'Add Task';
  document.getElementById('add-task-submit-btn').onclick = submitAddTask;
  document.getElementById('add-task-delete-btn').style.display = 'none';

  document.getElementById('t-name').value     = preset.name     || '';
  document.getElementById('t-desc').value     = preset.desc     || '';
  document.getElementById('t-status').value   = preset.status   || 'To Do';
  document.getElementById('t-priority').value = preset.priority || 'Medium';
  document.getElementById('t-assignee').value = preset.assignee || '';
  document.getElementById('t-due').value      = preset.dueDate  || '';

  // Auto-fill project from current selection or preset
  let projName = preset.project
    ? (allProjects().find(p => p.id === preset.project)?.name || '')
    : (selProject && selProject !== '__jobs__' && selProject !== '__dev__' && selProject !== '__org__'
        ? (allProjects().find(p => p.id === selProject)?.name || '') : '');
  populateProjectDropdown(projName);

  document.getElementById('add-task-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('t-name').focus(), 80);
}

function closeAddTask() {
  _editTaskId = null;
  document.getElementById('add-task-modal').classList.add('hidden');
}

async function submitAddTask() {
  const name = document.getElementById('t-name').value.trim();
  if (!name) { document.getElementById('t-name').focus(); return; }
  const btn = document.getElementById('add-task-submit-btn');
  btn.disabled = true; btn.textContent = 'Addingâ€¦';
  const job = document.getElementById('t-project').value;
  try {
    const res = await fetch('/api/tasks', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name, description: document.getElementById('t-desc').value.trim(),
        status:   document.getElementById('t-status').value,
        priority: document.getElementById('t-priority').value,
        assignee: document.getElementById('t-assignee').value || null,
        dueDate:  document.getElementById('t-due').value || null,
        job: job || null,
        level: job ? 'Job' : 'Org',
      })
    });
    const data = await res.json();
    if (data.ok) { closeAddTask(); fetchTasks(); }
    else { btn.disabled = false; btn.textContent = 'Error â€” retry'; }
  } catch { btn.disabled = false; btn.textContent = 'Error â€” retry'; }
}

function openEditTask(id) {
  const t = allTasks.find(x => x.id === id);
  if (!t) return;
  _editTaskId = id;
  document.querySelector('#add-task-modal .modal-title').textContent = 'Edit Task';
  document.getElementById('add-task-submit-btn').textContent = 'Save Changes';
  document.getElementById('add-task-submit-btn').onclick = submitEditTask;
  document.getElementById('add-task-delete-btn').style.display = 'block';
  document.getElementById('t-name').value     = t.name || '';
  document.getElementById('t-desc').value     = t.description || '';
  document.getElementById('t-status').value   = t.status || 'To Do';
  document.getElementById('t-priority').value = t.priority || 'Medium';
  document.getElementById('t-assignee').value = t.assignee || '';
  document.getElementById('t-due').value      = t.dueDate || '';
  populateProjectDropdown(t.job || '');
  document.getElementById('add-task-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('t-name').focus(), 80);
}

async function submitEditTask() {
  if (!_editTaskId) return;
  const btn = document.getElementById('add-task-submit-btn');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';
  const job = document.getElementById('t-project').value;
  try {
    const res = await fetch(`/api/tasks?id=${_editTaskId}`, {
      method:'PATCH', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name:        document.getElementById('t-name').value.trim(),
        description: document.getElementById('t-desc').value.trim(),
        status:      document.getElementById('t-status').value,
        priority:    document.getElementById('t-priority').value,
        assignee:    document.getElementById('t-assignee').value || null,
        dueDate:     document.getElementById('t-due').value || null,
        job: job || null,
        level: job ? 'Job' : 'Org',
      })
    });
    const data = await res.json();
    if (data.ok) { closeAddTask(); fetchTasks(); }
    else { btn.disabled = false; btn.textContent = 'Error'; }
  } catch { btn.disabled = false; btn.textContent = 'Error'; }
}

async function deleteCurrentTask() {
  if (!_editTaskId || !confirm('Delete this task?')) return;
  try {
    await fetch(`/api/tasks?id=${_editTaskId}`, { method:'DELETE' });
    closeAddTask(); fetchTasks();
  } catch {}
}

// â”€â”€ New Project modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewProject() {
  document.getElementById('np-name').value = '';
  document.getElementById('np-type').value = 'jobs';
  document.getElementById('new-project-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('np-name').focus(), 80);
}
function closeNewProject() { document.getElementById('new-project-modal').classList.add('hidden'); }
function submitNewProject() {
  const name = document.getElementById('np-name').value.trim();
  const type = document.getElementById('np-type').value;
  if (!name) { document.getElementById('np-name').focus(); return; }
  const icons = { jobs:'ğŸ ', dev:'ğŸ’»', org:'ğŸ¢', other:'ğŸ“Œ' };
  const custom = getCustomProjects();
  const id = name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if (!custom.find(p => p.id === id)) {
    custom.push({ id, name, group: type === 'org' || type === 'other' ? type : type, icon: icons[type] || 'ğŸ“Œ' });
    saveCustomProjects(custom);
  }
  closeNewProject();
  renderProjectSwitcher();
}

// Close modals on overlay click + Escape
['add-task-modal','new-project-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => { if (e.target.id === id) document.getElementById(id).classList.add('hidden'); });
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('add-task-modal').classList.add('hidden');
    document.getElementById('new-project-modal').classList.add('hidden');
  }
});

// Fetch tasks on load
fetchTasks();
</script>
</body>
</html>
