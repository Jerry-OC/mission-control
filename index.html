<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050508;
    --bg2: #0d0d14;
    --card: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.07);
    --accent: #f97316;
    --accent2: #fb923c;
    --text: #e8e8f0;
    --muted: #6b7280;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #a855f7;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html { font-size:17px; }
  body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; }

  /* ‚îÄ‚îÄ‚îÄ AUTH GATE ‚îÄ‚îÄ‚îÄ */
  #auth-overlay {
    position:fixed; inset:0; z-index:9999;
    background:var(--bg);
    display:flex; align-items:center; justify-content:center;
    animation:fadeIn 0.3s ease;
  }
  #auth-overlay.hidden { display:none; }

  .auth-box {
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:20px;
    padding:3rem 2.5rem;
    width:100%;
    max-width:400px;
    backdrop-filter:blur(24px);
    box-shadow:0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .auth-box::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--accent), var(--accent2), var(--purple));
  }
  .auth-logo {
    font-size:1.1rem; font-weight:700; color:var(--accent);
    letter-spacing:-0.02em; margin-bottom:0.25rem;
  }
  .auth-logo span { color:var(--text); font-weight:400; }
  .auth-title {
    font-size:1.5rem; font-weight:700; letter-spacing:-0.03em;
    margin:1.25rem 0 0.4rem;
  }
  .auth-subtitle { font-size:0.82rem; color:var(--muted); margin-bottom:2rem; }

  .auth-field {
    position:relative; margin-bottom:1rem;
  }
  .auth-field input {
    width:100%;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:10px;
    padding:0.8rem 1rem;
    font-size:1rem;
    font-family:'Inter',sans-serif;
    color:var(--text);
    outline:none;
    transition:border-color 0.2s, box-shadow 0.2s;
    letter-spacing:0.1em;
    text-align:center;
  }
  .auth-field input::placeholder { letter-spacing:normal; color:var(--muted); }
  .auth-field input:focus {
    border-color:rgba(249,115,22,0.5);
    box-shadow:0 0 0 3px rgba(249,115,22,0.1);
  }
  .auth-field label {
    display:block; font-size:0.72rem; font-weight:600;
    text-transform:uppercase; letter-spacing:0.08em;
    color:var(--muted); margin-bottom:0.5rem; text-align:left;
  }

  .auth-btn {
    width:100%; padding:0.85rem;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    border:none; border-radius:10px;
    font-size:0.9rem; font-weight:600;
    font-family:'Inter',sans-serif;
    color:#fff; cursor:pointer;
    transition:opacity 0.15s, transform 0.1s;
    letter-spacing:0.01em;
  }
  .auth-btn:hover { opacity:0.9; transform:translateY(-1px); }
  .auth-btn:active { transform:translateY(0); }
  .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

  .auth-error {
    margin-top:0.75rem; padding:0.6rem 1rem;
    background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2);
    border-radius:8px; font-size:0.8rem; color:var(--red);
    display:none;
  }
  .auth-error.show { display:block; }

  .auth-spinner {
    display:inline-block; width:14px; height:14px;
    border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin 0.6s linear infinite;
    vertical-align:middle; margin-right:0.4rem;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  .auth-footer {
    margin-top:1.5rem; font-size:0.72rem; color:var(--muted);
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    position:sticky; top:0; z-index:100;
    background:rgba(5,5,8,0.85);
    backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
    padding:0 2rem;
    display:flex; align-items:center; justify-content:space-between;
    height:60px;
  }
  .logo { font-size:1rem; font-weight:700; color:var(--accent); letter-spacing:-0.02em; }
  .logo span { color:var(--text); font-weight:400; }
  nav { display:flex; gap:0.25rem; }
  nav button {
    background:none; border:none; color:var(--muted);
    padding:0.4rem 0.9rem; border-radius:6px;
    font-size:0.85rem; font-family:'Inter',sans-serif;
    cursor:pointer; transition:all 0.15s;
  }
  nav button:hover { color:var(--text); background:var(--card); }
  nav button.active { color:var(--accent); background:rgba(249,115,22,0.1); }
  .header-right { display:flex; align-items:center; gap:1rem; }
  #clock { font-size:0.8rem; color:var(--muted); font-variant-numeric:tabular-nums; }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  #signout-btn {
    font-size:0.75rem; color:var(--muted); cursor:pointer;
    background:none; border:none; font-family:'Inter',sans-serif;
    padding:0.25rem 0.5rem; border-radius:4px;
    transition:color 0.15s, background 0.15s;
  }
  #signout-btn:hover { color:var(--red); background:rgba(239,68,68,0.08); }

  /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
  main { max-width:1400px; margin:0 auto; padding:2rem; }

  /* ‚îÄ‚îÄ‚îÄ TAB PANELS ‚îÄ‚îÄ‚îÄ */
  .tab-panel { display:none; animation:fadeIn 0.2s ease; }
  .tab-panel.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:1.25rem;
    backdrop-filter:blur(10px);
  }
  .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
  .card-title { font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); }

  /* ‚îÄ‚îÄ‚îÄ METRICS GRID ‚îÄ‚îÄ‚îÄ */
  .metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:1.5rem; }
  .metric-card {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; padding:1.25rem; position:relative; overflow:hidden;
  }
  .metric-bar { position:absolute; top:0; left:0; right:0; height:3px; }
  .metric-icon { font-size:1.4rem; margin-bottom:0.5rem; }
  .metric-label { font-size:0.75rem; color:var(--muted); margin-bottom:0.25rem; }
  .metric-value { font-size:1.8rem; font-weight:700; letter-spacing:-0.02em; }
  .metric-sub { font-size:0.75rem; color:var(--muted); margin-top:0.25rem; }
  .trend-up { color:var(--green); }
  .trend-dn { color:var(--red); }

  /* ‚îÄ‚îÄ‚îÄ GRIDS ‚îÄ‚îÄ‚îÄ */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1rem; }

  /* ‚îÄ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ‚îÄ */
  table { width:100%; border-collapse:collapse; }
  th { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); padding:0.5rem 0.75rem; text-align:left; border-bottom:1px solid var(--border); }
  td { padding:0.65rem 0.75rem; font-size:0.85rem; border-bottom:1px solid rgba(255,255,255,0.03); }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:rgba(255,255,255,0.02); }

  /* ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ */
  .badge { display:inline-flex; align-items:center; gap:0.3rem; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.72rem; font-weight:600; }
  .badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
  .badge-yellow { background:rgba(234,179,8,0.15); color:var(--yellow); }
  .badge-red { background:rgba(239,68,68,0.15); color:var(--red); }
  .badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
  .badge-orange { background:rgba(249,115,22,0.15); color:var(--accent); }
  .badge-muted { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* ‚îÄ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ‚îÄ */
  .progress-bar { background:rgba(255,255,255,0.06); border-radius:4px; height:6px; overflow:hidden; }
  .progress-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }

  /* ‚îÄ‚îÄ‚îÄ PRIORITIES ‚îÄ‚îÄ‚îÄ */
  .priority-item { display:flex; align-items:center; gap:0.75rem; padding:0.6rem 0; border-bottom:1px solid var(--border); }
  .priority-item:last-child { border-bottom:none; }
  .priority-item input[type=checkbox] { accent-color:var(--accent); width:16px; height:16px; cursor:pointer; }
  .priority-item label { font-size:0.875rem; cursor:pointer; flex:1; }
  .priority-item label.done { text-decoration:line-through; color:var(--muted); }

  /* ‚îÄ‚îÄ‚îÄ AGENT CARDS ‚îÄ‚îÄ‚îÄ */
  .agent-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:1rem; }
  @media(max-width:700px){ .agent-grid { grid-template-columns:1fr; } }
  .agent-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; transition:border-color 0.2s; }
  .agent-card.agent-active { border-color:rgba(34,197,94,0.3); }
  .agent-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:0.75rem; }
  .agent-emoji { font-size:1.8rem; }
  .agent-name { font-weight:600; font-size:1rem; }
  .agent-role { font-size:0.75rem; color:var(--muted); }
  .agent-status-row { display:flex; align-items:center; gap:0.4rem; font-size:0.78rem; margin-bottom:0.5rem; }
  .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .dot-green { background:var(--green); box-shadow:0 0 6px var(--green); animation:pulse-green 2s infinite; }
  .dot-yellow { background:var(--yellow); }
  .dot-gray { background:var(--muted); }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 4px var(--green);} 50%{box-shadow:0 0 10px var(--green);} }
  .agent-last-active { font-size:0.7rem; color:var(--muted); margin-bottom:0.75rem; }
  .agent-caps { display:flex; flex-wrap:wrap; gap:0.35rem; margin-bottom:0.85rem; }
  .agent-model-row { display:flex; align-items:center; gap:0.5rem; margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); }
  .agent-model-label { font-size:0.72rem; color:var(--muted); white-space:nowrap; }
  .model-select { flex:1; background:var(--bg2); border:1px solid var(--border); color:var(--text); border-radius:6px; padding:0.25rem 0.4rem; font-size:0.72rem; font-family:'Inter',sans-serif; cursor:pointer; }
  .model-select:focus { outline:none; border-color:var(--accent); }
  .model-save-btn { font-size:0.7rem; padding:0.25rem 0.6rem; border-radius:6px; border:1px solid var(--accent); background:transparent; color:var(--accent); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .model-save-btn:hover { background:rgba(249,115,22,0.15); }
  .model-save-btn:disabled { opacity:0.4; cursor:default; }
  .agent-offline-note { font-size:0.7rem; color:var(--muted); font-style:italic; margin-top:0.4rem; }
  .agents-live-badge { display:flex; align-items:center; gap:0.4rem; font-size:0.72rem; color:var(--muted); }
  .agents-live-badge .dot { width:5px; height:5px; }

  /* ‚îÄ‚îÄ‚îÄ INBOX ITEMS ‚îÄ‚îÄ‚îÄ */
  .inbox-item { display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:0.5rem; border:1px solid var(--border); }
  .inbox-left { display:flex; flex-direction:column; gap:0.2rem; }
  .inbox-vendor { font-size:0.875rem; font-weight:500; }
  .inbox-desc { font-size:0.75rem; color:var(--muted); }
  .inbox-amount { font-size:1rem; font-weight:600; }
  .inbox-amount.debit { color:var(--red); }
  .inbox-amount.credit { color:var(--green); }

  /* ‚îÄ‚îÄ‚îÄ SECTION HEADERS ‚îÄ‚îÄ‚îÄ */
  h2 { font-size:1.2rem; font-weight:700; margin-bottom:1rem; letter-spacing:-0.02em; }
  h3 { font-size:0.95rem; font-weight:600; margin-bottom:0.75rem; }

  /* ‚îÄ‚îÄ‚îÄ WELCOME BAR ‚îÄ‚îÄ‚îÄ */
  .welcome { margin-bottom:1.5rem; }
  .welcome h1 { font-size:1.6rem; font-weight:700; letter-spacing:-0.03em; }
  .welcome p { color:var(--muted); font-size:0.875rem; margin-top:0.25rem; }

  /* ‚îÄ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ‚îÄ */
  .divider { border:none; border-top:1px solid var(--border); margin:1rem 0; }

  /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
  .btn { background:var(--accent); color:#fff; border:none; padding:0.5rem 1rem; border-radius:8px; font-size:0.8rem; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; transition:opacity 0.15s; }
  .btn:hover { opacity:0.85; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-ghost:hover { background:var(--card); }

  /* ‚îÄ‚îÄ‚îÄ JOB CARD ‚îÄ‚îÄ‚îÄ */
  .job-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; margin-bottom:0.75rem; transition:border-color 0.2s; }
  .job-card:hover { border-color:rgba(255,255,255,0.12); }
  .job-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
  .job-name { font-weight:600; font-size:0.95rem; }
  .job-number { font-size:0.75rem; color:var(--muted); margin-top:0.15rem; }
  .job-budget-row { display:flex; justify-content:space-between; font-size:0.78rem; margin-bottom:0.4rem; }
  .job-budget-row span { color:var(--muted); }
  .job-budget-row strong { color:var(--text); }

  /* ‚îÄ‚îÄ‚îÄ LAST UPDATED ‚îÄ‚îÄ‚îÄ */
  #last-updated {
    font-size:0.72rem; color:var(--muted);
    text-align:right; margin-bottom:0.75rem;
    transition:opacity 0.3s;
  }

  /* ‚îÄ‚îÄ‚îÄ LOADING / ERROR STATES ‚îÄ‚îÄ‚îÄ */
  .state-loading { text-align:center; padding:2rem; color:var(--muted); font-size:0.85rem; }
  .state-error { text-align:center; padding:1.5rem; color:var(--red); font-size:0.82rem; background:rgba(239,68,68,0.06); border-radius:8px; border:1px solid rgba(239,68,68,0.15); }

  /* ‚îÄ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ‚îÄ */
  .tasks-header { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem; }
  .tasks-header h2 { margin:0; flex:1; }
  .view-toggle { display:flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .view-btn { padding:0.3rem 0.75rem; background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:0.78rem; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .view-btn.active { background:var(--accent); color:#fff; }

  /* Project switcher */
  .project-switcher { display:flex; gap:0; align-items:center; overflow-x:auto; padding-bottom:0.6rem; margin-bottom:1rem; scrollbar-width:none; }
  .project-switcher::-webkit-scrollbar { display:none; }
  .proj-sep { width:1px; background:var(--border); height:20px; margin:0 0.5rem; flex-shrink:0; }
  .proj-pill { display:flex; align-items:center; gap:0.3rem; padding:0.28rem 0.65rem; border-radius:20px; font-size:0.75rem; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; flex-shrink:0; }
  .proj-pill:hover { border-color:rgba(255,255,255,0.2); color:var(--text); }
  .proj-pill.active { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }
  .proj-pill.group { font-weight:600; }
  .proj-add { font-size:0.75rem; padding:0.28rem 0.65rem; border-radius:20px; border:1px dashed rgba(255,255,255,0.15); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; white-space:nowrap; flex-shrink:0; transition:all 0.15s; }
  .proj-add:hover { border-color:var(--accent); color:var(--accent); }

  /* Kanban */
  .kanban-board { display:grid; grid-template-columns:repeat(4,1fr); gap:0.85rem; align-items:start; }
  @media(max-width:900px){ .kanban-board { grid-template-columns:repeat(2,1fr); } }
  @media(max-width:500px){ .kanban-board { grid-template-columns:1fr; } }
  .kanban-col { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:0.85rem; min-height:180px; }
  .kanban-col-header { font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.75rem; display:flex; align-items:center; gap:0.5rem; }
  .kanban-count { font-size:0.68rem; padding:0.1rem 0.45rem; border-radius:20px; font-weight:500; }
  .task-card { background:var(--card); border:1px solid var(--border); border-radius:9px; padding:0.75rem; margin-bottom:0.55rem; cursor:grab; transition:border-color 0.15s,transform 0.12s,opacity 0.15s; }
  .task-card:hover { border-color:rgba(255,255,255,0.14); transform:translateY(-1px); }
  .task-card.dragging { opacity:0.35; cursor:grabbing; transform:scale(0.97); }
  .task-card-name { font-size:0.82rem; font-weight:500; margin-bottom:0.4rem; line-height:1.35; cursor:pointer; }
  .task-card-meta { display:flex; flex-wrap:wrap; gap:0.3rem; align-items:center; }
  .task-card-tag { font-size:0.68rem; color:var(--muted); }
  .task-card-actions { display:flex; gap:0.3rem; margin-top:0.5rem; padding-top:0.45rem; border-top:1px solid var(--border); }
  .status-btn { font-size:0.65rem; padding:0.15rem 0.45rem; border-radius:20px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .status-btn:hover { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.1); }
  .kanban-col.drag-over,.mini-col.drag-over { border-color:var(--accent); background:rgba(249,115,22,0.06); border-radius:7px; }

  /* Multi-board (Jobs group view) */
  .multi-board { display:flex; flex-direction:column; gap:1.5rem; }
  .mini-board { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
  .mini-board-header { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02); }
  .mini-board-title { font-size:0.88rem; font-weight:600; display:flex; align-items:center; gap:0.5rem; }
  .mini-board-add { font-size:0.72rem; color:var(--muted); cursor:pointer; border:1px solid var(--border); border-radius:6px; padding:0.2rem 0.5rem; background:transparent; font-family:'Inter',sans-serif; transition:all 0.15s; }
  .mini-board-add:hover { border-color:var(--accent); color:var(--accent); }
  .mini-kanban { display:grid; grid-template-columns:repeat(4,1fr); gap:0.6rem; padding:0.75rem; }
  @media(max-width:800px){ .mini-kanban { grid-template-columns:repeat(2,1fr); } }
  .mini-col { min-height:80px; }
  .mini-col-header { font-size:0.65rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.3rem; }
  .mini-card { background:var(--card); border:1px solid var(--border); border-radius:7px; padding:0.5rem 0.6rem; margin-bottom:0.4rem; font-size:0.75rem; cursor:pointer; transition:border-color 0.12s; line-height:1.3; }
  .mini-card:hover { border-color:rgba(255,255,255,0.14); }
  .mini-card-meta { display:flex; gap:0.25rem; margin-top:0.3rem; flex-wrap:wrap; }
  .mini-empty { font-size:0.68rem; color:rgba(107,114,128,0.5); padding:0.25rem 0; }

  /* List view */
  .tasks-list-group { margin-bottom:1.5rem; }
  .tasks-list-group-header { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); margin-bottom:0.5rem; padding-bottom:0.35rem; border-bottom:1px solid var(--border); }
  .task-row { display:flex; align-items:center; gap:0.6rem; padding:0.6rem 0.5rem; border-radius:7px; cursor:pointer; transition:background 0.12s; }
  .task-row:hover { background:rgba(255,255,255,0.04); }
  .task-row-check { width:16px; height:16px; border-radius:50%; border:1.5px solid var(--border); flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.15s; cursor:pointer; font-size:0.65rem; }
  .task-row-check.done { background:var(--green); border-color:var(--green); }
  .task-row-name { flex:1; font-size:0.83rem; }
  .task-row-name.done-text { text-decoration:line-through; color:var(--muted); }
  .task-row-right { display:flex; align-items:center; gap:0.4rem; }

  /* Priority badges */
  .pri-urgent { background:rgba(239,68,68,0.15);  color:#f87171; border:1px solid rgba(239,68,68,0.25); }
  .pri-high   { background:rgba(234,179,8,0.15);  color:#fbbf24; border:1px solid rgba(234,179,8,0.25); }
  .pri-medium { background:rgba(59,130,246,0.15); color:#60a5fa; border:1px solid rgba(59,130,246,0.25); }
  .pri-low    { background:rgba(107,114,128,0.12);color:var(--muted); border:1px solid var(--border); }
  .pri-badge  { font-size:0.63rem; padding:0.1rem 0.42rem; border-radius:20px; font-weight:500; white-space:nowrap; }

  /* Kanban column accent colors */
  .col-todo .kanban-col-header,.mini-col.col-todo .mini-col-header { color:#60a5fa; }
  .col-todo .kanban-count { background:rgba(59,130,246,0.15); color:#60a5fa; }
  .col-progress .kanban-col-header,.mini-col.col-progress .mini-col-header { color:#fbbf24; }
  .col-progress .kanban-count { background:rgba(234,179,8,0.15); color:#fbbf24; }
  .col-blocked .kanban-col-header,.mini-col.col-blocked .mini-col-header { color:#f87171; }
  .col-blocked .kanban-count { background:rgba(239,68,68,0.15); color:#f87171; }
  .col-done .kanban-col-header,.mini-col.col-done .mini-col-header { color:var(--muted); }
  .col-done .kanban-count { background:rgba(107,114,128,0.15); color:var(--muted); }

  /* Modal */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:500; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.15s ease; }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:var(--bg2); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:1.75rem; width:100%; max-width:480px; max-height:90vh; overflow-y:auto; }
  .modal-title { font-size:1rem; font-weight:600; margin-bottom:1.25rem; }
  .form-row { margin-bottom:0.85rem; }
  .form-label { font-size:0.72rem; color:var(--muted); margin-bottom:0.3rem; display:block; }
  .form-input { width:100%; background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.5rem 0.65rem; font-size:0.83rem; font-family:'Inter',sans-serif; transition:border-color 0.15s; }
  .form-input:focus { outline:none; border-color:var(--accent); }
  select.form-input { color-scheme:dark; }
  select.form-input option { background:#1a1a2e; color:#e2e8f0; }
  .form-row-2col { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; }
  .modal-footer { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1.25rem; }
  .btn-cancel { padding:0.45rem 1rem; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; font-size:0.82rem; }
  .btn-cancel:hover { background:rgba(255,255,255,0.04); }
  .inline-add { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; border:1px dashed rgba(255,255,255,0.1); border-radius:8px; cursor:pointer; color:var(--muted); font-size:0.78rem; transition:all 0.15s; margin-top:0.4rem; }
  .inline-add:hover { border-color:var(--accent); color:var(--accent); }
  /* ‚îÄ‚îÄ‚îÄ CONTACTS ‚îÄ‚îÄ‚îÄ */
  .contacts-header { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem; max-width:680px; }
  .contacts-header h2 { margin:0; flex:1; }
  .contacts-search-wrap { position:relative; flex:1; min-width:180px; max-width:320px; }
  .contacts-search { width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0.45rem 0.65rem 0.45rem 2rem; font-size:0.83rem; font-family:'Inter',sans-serif; }
  .contacts-search:focus { outline:none; border-color:var(--accent); }
  .contacts-search-icon { position:absolute; left:0.6rem; top:50%; transform:translateY(-50%); color:var(--muted); font-size:0.8rem; pointer-events:none; }
  .contacts-type-pills { display:flex; gap:0.35rem; flex-wrap:wrap; margin-bottom:1rem; max-width:680px; }
  .pill { display:inline-flex; align-items:center; padding:0.28rem 0.75rem; border-radius:20px; font-size:0.75rem; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s; white-space:nowrap; }
  .pill:hover { border-color:rgba(255,255,255,0.25); color:var(--text); }
  .pill.active            { border-color:var(--accent);           color:var(--accent);  background:rgba(249,115,22,0.12); }
  .pill-client.active     { border-color:#34d399; color:#34d399;  background:rgba(52,211,153,0.1); }
  .pill-sub.active        { border-color:var(--accent); color:var(--accent); background:rgba(249,115,22,0.12); }
  .pill-vendor.active     { border-color:#60a5fa; color:#60a5fa;  background:rgba(96,165,250,0.1); }
  .pill-personal.active   { border-color:#c084fc; color:#c084fc;  background:rgba(192,132,252,0.1); }
  .pill-professional.active{ border-color:#fbbf24; color:#fbbf24; background:rgba(251,191,36,0.1); }
  .contacts-list { display:flex; flex-direction:column; gap:0.55rem; max-width:680px; }
  .contact-card { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:border-color 0.15s; }
  .contact-card:hover { border-color:rgba(255,255,255,0.12); }
  .contact-card-header { display:flex; align-items:center; gap:0.75rem; padding:0.85rem 1rem; cursor:pointer; }
  .contact-avatar { width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,var(--accent),#c2410c); display:flex; align-items:center; justify-content:center; font-size:0.9rem; font-weight:600; flex-shrink:0; color:#fff; }
  .contact-card-name { font-size:0.88rem; font-weight:600; }
  .contact-card-sub { font-size:0.72rem; color:var(--muted); margin-top:0.1rem; }
  .contact-card-badges { display:flex; gap:0.25rem; flex-wrap:wrap; margin-top:0.3rem; }
  .contact-badge { font-size:0.6rem; padding:0.08rem 0.4rem; border-radius:20px; border:1px solid var(--border); color:var(--muted); white-space:nowrap; }
  .contact-badge.type-client       { border-color:rgba(16,185,129,0.4); color:#34d399; }
  .contact-badge.type-subcontractor{ border-color:rgba(249,115,22,0.4); color:#fb923c; }
  .contact-badge.type-vendor        { border-color:rgba(59,130,246,0.4); color:#60a5fa; }
  .contact-badge.type-personal      { border-color:rgba(168,85,247,0.4); color:#c084fc; }
  .contact-badge.type-professional  { border-color:rgba(234,179,8,0.4);  color:#fbbf24; }
  .contact-expand { display:none; padding:0 1rem 1rem; border-top:1px solid var(--border); }
  .contact-expand.open { display:block; }
  .contact-field { display:flex; align-items:center; gap:0; padding:0.35rem 0; border-bottom:1px solid rgba(255,255,255,0.04); }
  .contact-field:last-child { border-bottom:none; }
  .contact-field-label { font-size:0.65rem; color:var(--muted); width:72px; flex-shrink:0; text-transform:uppercase; letter-spacing:0.04em; }
  .contact-field-value { font-size:0.82rem; display:inline-flex; align-items:center; gap:0.4rem; flex-wrap:wrap; }
  .contact-field-value a { color:var(--text); text-decoration:none; }
  .contact-field-value a:hover { color:var(--accent); }
  .copy-btn { font-size:0.6rem; padding:0.08rem 0.3rem; border-radius:4px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; transition:all 0.15s; flex-shrink:0; line-height:1.4; }
  .copy-btn:hover { border-color:var(--accent); color:var(--accent); }
  .copy-btn.copied { border-color:var(--green); color:var(--green); }
  .contact-expand-actions { display:flex; gap:0.5rem; margin-top:0.85rem; }
  .contact-empty { text-align:center; color:var(--muted); padding:3rem 1rem; font-size:0.85rem; }
  .contacts-count { font-size:0.72rem; color:var(--muted); margin-bottom:0.75rem; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH GATE OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-logo">CDB <span>Mission Control</span></div>
    <h2 class="auth-title">Welcome back</h2>
    <p class="auth-subtitle">Enter your access code to continue</p>

    <div class="auth-field">
      <label for="auth-code-input">Access Code</label>
      <input
        type="password"
        id="auth-code-input"
        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        autocomplete="off"
        spellcheck="false"
        autofocus
      >
    </div>

    <button class="auth-btn" id="auth-submit-btn" onclick="submitAuth()">
      Request Access
    </button>

    <div class="auth-error" id="auth-error"></div>

    <div class="auth-footer">Cody Design Build Inc. ¬∑ Private System</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP (hidden until authed)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app" style="display:none">

<header>
  <div class="logo">CDB <span>Mission Control</span></div>
  <nav>
    <button class="active" onclick="showTab('dashboard',this)">üìä Dashboard</button>
    <button onclick="showTab('jobs',this)">üèóÔ∏è Jobs</button>
    <button onclick="showTab('inbox',this)">üì• Cost Inbox</button>
    <button onclick="showTab('revenue',this)">üí∞ Revenue</button>
    <button onclick="showTab('agents',this)">ü§ñ Agents</button>
    <button onclick="showTab('tasks',this)">‚úÖ Tasks</button>
    <button onclick="showTab('contacts',this)">üë• Contacts</button>
  </nav>
  <div class="header-right">
    <span id="clock"></span>
    <div class="status-dot"></div>
    <button id="signout-btn" onclick="signOut()" title="Sign out">Sign out</button>
  </div>
</header>

<main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-dashboard" class="tab-panel active">
  <div class="welcome">
    <h1 id="greeting">Good morning, David üëã</h1>
    <p id="date-line">Loading...</p>
  </div>

  <div id="last-updated"></div>

  <div class="metrics">
    <!-- Active Jobs -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      <div class="metric-icon">üèóÔ∏è</div>
      <div class="metric-label">Active Jobs</div>
      <div class="metric-value" id="metric-jobs-count">‚Äî</div>
      <div class="metric-sub" id="metric-jobs-value">loading‚Ä¶</div>
    </div>
    <!-- Cost Inbox -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">üì•</div>
      <div class="metric-label">Cost Inbox</div>
      <div class="metric-value" id="metric-inbox-count">‚Äî</div>
      <div class="metric-sub">transactions to code</div>
    </div>
    <!-- Open Invoices -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">üíµ</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="metric-invoices-owed">‚Äî</div>
      <div class="metric-sub" id="metric-invoices-sub">loading‚Ä¶</div>
    </div>
    <!-- Draft Bills (static) -->
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--purple),#c084fc)"></div>
      <div class="metric-icon">üìã</div>
      <div class="metric-label">Draft Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 vendor bills pending</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header">
        <span class="card-title">Top Priorities</span>
        <button class="btn btn-ghost" style="font-size:0.72rem;padding:0.25rem 0.6rem" onclick="addPriority()">+ Add</button>
      </div>
      <div id="priorities">
        <div class="priority-item"><input type="checkbox" id="p1" onchange="toggleDone(this)"><label for="p1">Fix Phil's pairing ‚Äî OpenClaw menubar app</label></div>
        <div class="priority-item"><input type="checkbox" id="p2" onchange="toggleDone(this)"><label for="p2">Code this week's Plaid transactions</label></div>
        <div class="priority-item"><input type="checkbox" id="p3" onchange="toggleDone(this)"><label for="p3">Send invoice to Balboa client</label></div>
        <div class="priority-item"><input type="checkbox" id="p4" onchange="toggleDone(this)"><label for="p4">Approve Graham Plastering bill ($9K)</label></div>
        <div class="priority-item"><input type="checkbox" id="p5" onchange="toggleDone(this)"><label for="p5">Invite assistant@codydesignbuild.com to Airtable</label></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><span class="card-title">Activity Feed</span></div>
      <div id="activity-feed" style="font-size:0.82rem;">
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Jerry pulled Plaid transactions</span><span style="color:var(--muted)">just now</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>JT API skill built + tested</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>Phil agent created (pairing pending)</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span>memory-lancedb enabled</span><span style="color:var(--muted)">today</span></div>
        <div style="display:flex;justify-content:space-between;padding:0.4rem 0"><span>Google Workspace connected</span><span style="color:var(--muted)">today</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JOBS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-jobs" class="tab-panel">
  <h2>Active Jobs</h2>
  <div id="jobs-list">
    <div class="state-loading">Loading jobs‚Ä¶</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COST INBOX TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-inbox" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
    <h2 style="margin:0">Cost Inbox ‚Äî Plaid Transactions</h2>
    <span class="badge badge-red" id="inbox-badge">‚Äî</span>
  </div>

  <div class="card" style="margin-bottom:1rem">
    <div style="font-size:0.82rem;color:var(--muted)">
      These are bank transactions pulled from <strong style="color:var(--text)">Business Checking ...4687</strong> via Plaid that haven't been coded to a job yet.
    </div>
  </div>

  <div id="inbox-list">
    <div class="state-loading">Loading transactions‚Ä¶</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVENUE TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-revenue" class="tab-panel">
  <h2>Revenue Overview</h2>
  <div class="metrics" style="grid-template-columns:repeat(3,1fr)">
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--green),#4ade80)"></div>
      <div class="metric-icon">üìä</div>
      <div class="metric-label">Total Pipeline</div>
      <div class="metric-value" id="rev-pipeline">‚Äî</div>
      <div class="metric-sub" id="rev-pipeline-sub">loading‚Ä¶</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--yellow),#fde047)"></div>
      <div class="metric-icon">üßæ</div>
      <div class="metric-label">Open Invoices</div>
      <div class="metric-value" id="rev-open-invoices">‚Äî</div>
      <div class="metric-sub" id="rev-invoices-sub">loading‚Ä¶</div>
    </div>
    <div class="metric-card">
      <div class="metric-bar" style="background:linear-gradient(90deg,var(--red),#f87171)"></div>
      <div class="metric-icon">üì§</div>
      <div class="metric-label">Draft Vendor Bills</div>
      <div class="metric-value">$41,000</div>
      <div class="metric-sub">2 bills to approve</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span class="card-title">Open Customer Invoices</span></div>
    <table>
      <thead><tr><th>Job</th><th>Invoice</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody id="invoice-rows">
        <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">Draft Vendor Bills</span></div>
    <table>
      <thead><tr><th>Vendor</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>Graham Plastering</td><td>$9,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
        <tr><td>Other</td><td>$32,000</td><td><span class="badge badge-yellow">Draft</span></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AGENTS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-agents" class="tab-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">
    <h2 style="margin:0">Agent Command Center</h2>
    <div class="agents-live-badge" id="agents-live-badge">
      <div class="dot dot-gray"></div><span>Connecting‚Ä¶</span>
    </div>
  </div>

  <div class="agent-grid" id="agent-grid">
    <div style="color:var(--muted);font-size:0.85rem;padding:2rem;grid-column:1/-1;text-align:center">Loading agents‚Ä¶</div>
  </div>

  <div class="card" id="system-status-card" style="margin-top:1rem">
    <div class="card-header"><span class="card-title">System Status</span></div>
    <table>
      <thead><tr><th>Component</th><th>Status</th><th>Detail</th></tr></thead>
      <tbody id="system-status-body">
        <tr><td>Gateway</td><td><span class="badge badge-muted">Checking‚Ä¶</span></td><td></td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTACTS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-contacts" class="tab-panel">
  <div class="contacts-header">
    <h2>üë• Contacts</h2>
    <div class="contacts-search-wrap">
      <span class="contacts-search-icon">üîç</span>
      <input class="contacts-search" id="contacts-search" placeholder="Search name, company, phone‚Ä¶" oninput="debounceContactSearch()" />
    </div>
    <button class="btn" onclick="openAddContact()">+ Add</button>
  </div>

  <div class="contacts-type-pills" id="contacts-type-pills">
    <button class="pill active"              onclick="setContactFilter('',this)">All</button>
    <button class="pill pill-client"         onclick="setContactFilter('client',this)">Clients</button>
    <button class="pill pill-sub"            onclick="setContactFilter('subcontractor',this)">Subs</button>
    <button class="pill pill-vendor"         onclick="setContactFilter('vendor',this)">Vendors</button>
    <button class="pill pill-personal"       onclick="setContactFilter('personal',this)">Personal</button>
    <button class="pill pill-professional"   onclick="setContactFilter('professional',this)">Professional</button>
  </div>

  <div class="contacts-count" id="contacts-count"></div>
  <div class="contacts-list" id="contacts-list">
    <div class="state-loading">Loading contacts‚Ä¶</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD/EDIT CONTACT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="contact-modal">
  <div class="modal-box" style="max-width:520px">
    <div class="modal-title" id="contact-modal-title">New Contact</div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">First name</label><input class="form-input" id="cm-first" placeholder="John" /></div>
      <div class="form-row"><label class="form-label">Last name</label><input class="form-input" id="cm-last" placeholder="Martinez" /></div>
    </div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">Phone</label><input class="form-input" id="cm-phone" placeholder="+1 415 555 1234" /></div>
      <div class="form-row"><label class="form-label">Email</label><input class="form-input" id="cm-email" placeholder="john@example.com" /></div>
    </div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">Company</label><input class="form-input" id="cm-company" placeholder="Coastal Plumbing" /></div>
      <div class="form-row"><label class="form-label">Title / Role</label><input class="form-input" id="cm-title" placeholder="Owner" /></div>
    </div>
    <div class="form-row">
      <label class="form-label">Types (comma-separated)</label>
      <input class="form-input" id="cm-types" placeholder="subcontractor, client, personal‚Ä¶" />
    </div>
    <div class="form-row">
      <label class="form-label">Trades / Specialty (comma-separated)</label>
      <input class="form-input" id="cm-trades" placeholder="Plumber, Electrician‚Ä¶" />
    </div>
    <div class="form-row-2col">
      <div class="form-row"><label class="form-label">Rating (1‚Äì5)</label><input class="form-input" id="cm-rating" type="number" min="1" max="5" /></div>
      <div class="form-row"><label class="form-label">Source</label><input class="form-input" id="cm-source" placeholder="referral, Google‚Ä¶" /></div>
    </div>
    <div class="form-row"><label class="form-label">Notes</label><textarea class="form-input" id="cm-notes" rows="2"></textarea></div>
    <div class="form-row" style="display:flex;align-items:center;gap:0.5rem">
      <input type="checkbox" id="cm-verified" style="accent-color:var(--accent)" />
      <label class="form-label" style="margin:0" for="cm-verified">Verified contact</label>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="cm-delete-btn" style="color:var(--red);border-color:rgba(239,68,68,0.3);display:none" onclick="deleteCurrentContact()">Delete</button>
      <button class="btn-cancel" onclick="closeContactModal()">Cancel</button>
      <button class="btn" id="cm-submit-btn" onclick="submitContactModal()">Add Contact</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TASKS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-tasks" class="tab-panel">

  <div class="tasks-header">
    <h2>‚úÖ Tasks</h2>
    <div class="view-toggle">
      <button class="view-btn active" id="view-kanban-btn" onclick="setTaskView('kanban')">‚¨ú Kanban</button>
      <button class="view-btn" id="view-list-btn" onclick="setTaskView('list')">‚ò∞ List</button>
    </div>
    <button class="btn" onclick="openAddTask()">+ Add Task</button>
  </div>

  <!-- Project switcher -->
  <div class="project-switcher" id="project-switcher"><!-- rendered by JS --></div>

  <!-- Content area -->
  <div id="tasks-content">
    <div class="state-loading">Loading tasks‚Ä¶</div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD / EDIT TASK MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="add-task-modal">
  <div class="modal-box">
    <div class="modal-title">New Task</div>
    <div class="form-row">
      <label class="form-label">Task name *</label>
      <input class="form-input" id="t-name" placeholder="What needs to be done?" />
    </div>
    <div class="form-row">
      <label class="form-label">Description</label>
      <textarea class="form-input" id="t-desc" rows="2" placeholder="Optional details‚Ä¶"></textarea>
    </div>
    <div class="form-row-2col">
      <div class="form-row">
        <label class="form-label">Status</label>
        <select class="form-input" id="t-status">
          <option value="To Do">To Do</option>
          <option value="In Progress">In Progress</option>
          <option value="Blocked">Blocked</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Priority</label>
        <select class="form-input" id="t-priority">
          <option value="Low">Low</option>
          <option value="Medium" selected>Medium</option>
          <option value="High">High</option>
          <option value="Urgent">Urgent</option>
        </select>
      </div>
    </div>
    <div class="form-row-2col">
      <div class="form-row">
        <label class="form-label">Project</label>
        <select class="form-input" id="t-project">
          <!-- populated by JS -->
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Assignee</label>
        <select class="form-input" id="t-assignee">
          <option value="">Unassigned</option>
          <option value="David">David</option>
          <option value="Jerry">Jerry</option>
          <option value="Phil">Phil</option>
          <option value="Bobby">Bobby</option>
          <option value="Mickey">Mickey</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">Due Date</label>
      <input class="form-input" type="date" id="t-due" style="max-width:200px" />
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="add-task-delete-btn" style="color:var(--red);border-color:rgba(239,68,68,0.3);display:none" onclick="deleteCurrentTask()">Delete</button>
      <button class="btn-cancel" onclick="closeAddTask()">Cancel</button>
      <button class="btn" id="add-task-submit-btn" onclick="submitAddTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW PROJECT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="new-project-modal">
  <div class="modal-box" style="max-width:380px">
    <div class="modal-title">New Project</div>
    <div class="form-row">
      <label class="form-label">Project name *</label>
      <input class="form-input" id="np-name" placeholder="e.g. Oakland Kitchen, Siri Shortcut" />
    </div>
    <div class="form-row">
      <label class="form-label">Type</label>
      <select class="form-input" id="np-type">
        <option value="jobs">üèóÔ∏è Construction Job</option>
        <option value="dev">üíª Dev / Tech</option>
        <option value="org">üè¢ Org / Admin</option>
        <option value="other">üìå Other</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeNewProject()">Cancel</button>
      <button class="btn" onclick="submitNewProject()">Create Project</button>
    </div>
  </div>
</div>

</main>
</div><!-- /#app -->

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TOKEN_KEY = 'mc_token';

function getToken() {
  return localStorage.getItem(TOKEN_KEY);
}

function showApp() {
  document.getElementById('auth-overlay').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
  loadData();
}

function showAuthOverlay() {
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('app').style.display = 'none';
  setTimeout(() => document.getElementById('auth-code-input').focus(), 100);
}

function setAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}

function clearAuthError() {
  document.getElementById('auth-error').classList.remove('show');
}

async function submitAuth() {
  const input = document.getElementById('auth-code-input');
  const btn   = document.getElementById('auth-submit-btn');
  const code  = input.value.trim();

  if (!code) { setAuthError('Please enter your access code.'); return; }

  clearAuthError();
  btn.disabled = true;
  btn.innerHTML = '<span class="auth-spinner"></span>Verifying‚Ä¶';

  try {
    const res  = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code }),
    });
    const data = await res.json();

    if (data.ok && data.token) {
      localStorage.setItem(TOKEN_KEY, data.token);
      input.value = '';
      showApp();
    } else {
      setAuthError(data.error || 'Access denied. Check your code and try again.');
      input.value = '';
      input.focus();
    }
  } catch (err) {
    setAuthError('Connection error ‚Äî please try again.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Request Access';
  }
}

function signOut() {
  localStorage.removeItem(TOKEN_KEY);
  showAuthOverlay();
}

// Allow Enter key on the access code input
document.getElementById('auth-code-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitAuth();
});

// Boot: check token
(function bootAuth() {
  const token = getToken();
  if (token) {
    // Token exists ‚Äî trust it and show app (server validates on every API call)
    showApp();
  } else {
    showAuthOverlay();
  }
})();


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CLOCK & GREETING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateClock() {
  const now = new Date();
  const clockEl = document.getElementById('clock');
  if (clockEl) {
    clockEl.textContent = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }
  const hour = now.getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  const greetEl = document.getElementById('greeting');
  if (greetEl) greetEl.textContent = `${greeting}, David üëã`;
  const dateEl = document.getElementById('date-line');
  if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' ¬∑ Cody Design Build Inc.';
}
updateClock();
setInterval(updateClock, 1000);


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB SWITCHING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'tasks') fetchTasks();
  if (name === 'agents') fetchAgents();
  if (name === 'contacts') fetchContacts(contactSearchTerm, contactFilter);
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRIORITIES (localStorage)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleDone(cb) {
  cb.nextElementSibling.classList.toggle('done', cb.checked);
  savePriorities();
}
function addPriority() {
  const text = prompt('New priority:');
  if (!text) return;
  const id  = 'p' + Date.now();
  const div = document.createElement('div');
  div.className = 'priority-item';
  div.innerHTML = `<input type="checkbox" id="${id}" onchange="toggleDone(this)"><label for="${id}">${text}</label>`;
  document.getElementById('priorities').appendChild(div);
  savePriorities();
}
function savePriorities() {
  const items = [...document.querySelectorAll('#priorities .priority-item')].map(el => ({
    text: el.querySelector('label').textContent,
    done: el.querySelector('input').checked,
  }));
  localStorage.setItem('mc_priorities', JSON.stringify(items));
}
function loadPriorities() {
  const saved = localStorage.getItem('mc_priorities');
  if (!saved) return;
  try {
    const items     = JSON.parse(saved);
    const container = document.getElementById('priorities');
    container.innerHTML = '';
    items.forEach((item, i) => {
      const id  = 'p' + i;
      const div = document.createElement('div');
      div.className = 'priority-item';
      div.innerHTML = `<input type="checkbox" id="${id}" ${item.done ? 'checked' : ''} onchange="toggleDone(this)"><label for="${id}" class="${item.done ? 'done' : ''}">${item.text}</label>`;
      container.appendChild(div);
    });
  } catch(e) {}
}
loadPriorities();


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CURRENCY FORMATTERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmtCurrency(n) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1_000_000) {
    return sign + '$' + (abs / 1_000_000).toFixed(2).replace(/\.?0+$/, '') + 'M';
  }
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function fmtCurrencyFull(n) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  return sign + '$' + abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtDate(str) {
  if (!str) return '‚Äî';
  try {
    return new Date(str).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
  } catch { return str; }
}

function progressColor(pct) {
  if (pct >= 90) return 'var(--red)';
  if (pct >= 70) return 'var(--yellow)';
  return 'var(--accent)';
}

function invoiceStatusBadge(status) {
  if (!status) return '<span class="badge badge-muted">Unknown</span>';
  const s = status.toLowerCase();
  if (s.includes('paid'))    return '<span class="badge badge-green">Paid</span>';
  if (s.includes('partial')) return '<span class="badge badge-blue">Partial</span>';
  if (s.includes('draft'))   return '<span class="badge badge-orange">Draft</span>';
  if (s.includes('void'))    return '<span class="badge badge-muted">Void</span>';
  return `<span class="badge badge-yellow">${status}</span>`;
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderJobs(data) {
  const container = document.getElementById('jobs-list');
  const jobs = data.jobs || [];

  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No active jobs found.</div>';
    return;
  }

  container.innerHTML = jobs.map(job => {
    const contractValue = Number(job.contractValue) || 0;
    const billed        = Number(job.billed)        || 0;
    const owed          = Number(job.owed)           || 0;
    const pct           = contractValue > 0 ? Math.min(100, Math.round((billed / contractValue) * 100)) : 0;
    const color         = progressColor(pct);
    const customer      = job.customer || '‚Äî';
    const jobNum        = job.number   ? `Job #${job.number}` : (job.id || '');

    return `
      <div class="job-card">
        <div class="job-header">
          <div>
            <div class="job-name">${escHtml(job.name || 'Untitled Job')}</div>
            <div class="job-number">${escHtml(jobNum)} ¬∑ ${escHtml(customer)}</div>
          </div>
          <span class="badge badge-green">Active</span>
        </div>
        <div class="job-budget-row"><span>Contract Value</span><strong>${fmtCurrency(contractValue)}</strong></div>
        <div class="job-budget-row"><span>Billed So Far</span><strong>${fmtCurrency(billed)}</strong></div>
        <div class="job-budget-row"><span>Outstanding</span><strong style="color:${owed > 0 ? 'var(--yellow)' : 'var(--muted)'}">${fmtCurrency(owed)}</strong></div>
        <div class="progress-bar" style="margin-top:0.6rem">
          <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.4rem">${pct}% billed of contract</div>
      </div>`;
  }).join('');
}

function renderInbox(data) {
  const transactions = data.transactions || [];
  const count        = data.count ?? transactions.length;
  const totalAmt     = data.totalAmount;

  // Update header badge
  document.getElementById('inbox-badge').textContent =
    count > 0 ? `${count} uncoded` : '0 uncoded';

  const container = document.getElementById('inbox-list');

  if (!transactions.length) {
    container.innerHTML = '<div class="state-loading">No uncoded transactions ‚Äî inbox is clear! ‚úÖ</div>';
    return;
  }

  container.innerHTML = transactions.map(tx => {
    const amount   = Number(tx.amount) || 0;
    const isDebit  = amount < 0;
    const cls      = isDebit ? 'debit' : 'credit';
    const dateStr  = fmtDate(tx.date);
    const account  = tx.account ? ` ¬∑ ${escHtml(tx.account)}` : '';

    return `
      <div class="inbox-item">
        <div class="inbox-left">
          <div class="inbox-vendor">${escHtml(tx.name || '‚Äî')}</div>
          <div class="inbox-desc">${dateStr}${account}</div>
        </div>
        <div class="inbox-amount ${cls}">${isDebit ? '-' : '+'}${fmtCurrency(Math.abs(amount))}</div>
      </div>`;
  }).join('');
}

function renderInvoices(data) {
  const invoices = data.invoices || [];
  const tbody    = document.getElementById('invoice-rows');

  if (!invoices.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">No open invoices.</td></tr>';
    return;
  }

  tbody.innerHTML = invoices.map(inv => {
    const jobName = inv.jobName || '‚Äî';
    const invName = inv.name   || (inv.number ? `Invoice #${inv.number}` : '‚Äî');
    const total   = fmtCurrency(Number(inv.total) || 0);
    const date    = fmtDate(inv.date);
    const badge   = invoiceStatusBadge(inv.status);
    return `<tr>
      <td>${escHtml(jobName)}</td>
      <td>${escHtml(invName)}</td>
      <td style="color:var(--muted);font-size:0.78rem">${date}</td>
      <td>${total}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE DATA LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadData() {
  const token = getToken();

  const headers = token
    ? { 'Authorization': `Bearer ${token}` }
    : {};

  let jobsData, inboxData, invoicesData;

  try {
    [jobsData, inboxData, invoicesData] = await Promise.all([
      fetch('/api/jobs',     { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/inbox',    { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch('/api/invoices', { headers }).then(r => r.ok ? r.json() : null).catch(() => null),
    ]);
  } catch (e) {
    console.error('loadData failed:', e);
  }

  // ‚îÄ‚îÄ JOBS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (jobsData) {
    const count = jobsData.total ?? (jobsData.jobs || []).length;
    const val   = Number(jobsData.totalValue) || 0;

    document.getElementById('metric-jobs-count').textContent = count !== null ? count : '‚Äî';
    document.getElementById('metric-jobs-value').textContent =
      val > 0 ? `${fmtCurrency(val)} total value` : 'no value data';

    // Revenue tab pipeline
    const revPipeline = document.getElementById('rev-pipeline');
    if (revPipeline) revPipeline.textContent = val > 0 ? fmtCurrency(val) : '‚Äî';
    const revPipelineSub = document.getElementById('rev-pipeline-sub');
    if (revPipelineSub) revPipelineSub.textContent = `${count} active job${count !== 1 ? 's' : ''}`;

    renderJobs(jobsData);
  } else {
    document.getElementById('metric-jobs-count').textContent = '‚Äî';
    document.getElementById('metric-jobs-value').textContent = 'failed to load';
    document.getElementById('jobs-list').innerHTML =
      '<div class="state-error">Could not load jobs ‚Äî API unavailable.</div>';
  }

  // ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (inboxData) {
    const count = inboxData.count ?? (inboxData.transactions || []).length;
    document.getElementById('metric-inbox-count').textContent = count;
    renderInbox(inboxData);
  } else {
    document.getElementById('metric-inbox-count').textContent = '‚Äî';
    document.getElementById('inbox-list').innerHTML =
      '<div class="state-error">Could not load inbox ‚Äî API unavailable.</div>';
    document.getElementById('inbox-badge').textContent = 'error';
  }

  // ‚îÄ‚îÄ INVOICES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (invoicesData) {
    const owed  = Number(invoicesData.totalOwed) || 0;
    const count = invoicesData.count ?? (invoicesData.invoices || []).length;

    document.getElementById('metric-invoices-owed').textContent = fmtCurrency(owed);
    document.getElementById('metric-invoices-sub').textContent =
      `${count} invoice${count !== 1 ? 's' : ''} outstanding`;

    // Revenue tab open invoices
    const revOwed = document.getElementById('rev-open-invoices');
    if (revOwed) revOwed.textContent = fmtCurrency(owed);
    const revInvSub = document.getElementById('rev-invoices-sub');
    if (revInvSub) revInvSub.textContent = `${count} invoice${count !== 1 ? 's' : ''} pending`;

    renderInvoices(invoicesData);
  } else {
    document.getElementById('metric-invoices-owed').textContent = '‚Äî';
    document.getElementById('metric-invoices-sub').textContent = 'failed to load';
    document.getElementById('invoice-rows').innerHTML =
      '<tr><td colspan="5" style="text-align:center;color:var(--red);padding:1.5rem">Could not load invoices ‚Äî API unavailable.</td></tr>';
  }

  // ‚îÄ‚îÄ LAST UPDATED TIMESTAMP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ts = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
  const lastUpdatedEl = document.getElementById('last-updated');
  if (lastUpdatedEl) {
    lastUpdatedEl.textContent = `Last updated: ${ts}`;
  }
}

// Auto-refresh every 5 minutes
setInterval(loadData, 5 * 60 * 1000);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AGENTS ‚Äî Live Status + Model Switcher
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LOCAL_API = 'http://127.0.0.1:18900';
const MODELS = [
  { id: 'anthropic/claude-sonnet-4-6',  label: 'Claude Sonnet 4.6 (default)' },
  { id: 'anthropic/claude-opus-4-5',    label: 'Claude Opus 4.5' },
  { id: 'anthropic/claude-haiku-4-5',   label: 'Claude Haiku 4.5' },
  { id: 'openai/gpt-4o',                label: 'GPT-4o' },
  { id: 'openai/gpt-4o-mini',           label: 'GPT-4o Mini' },
  { id: 'openai/o3-mini',               label: 'o3-mini' },
];

let agentsData = null;          // last fetched payload
let agentModelDraft = {};       // { agentId: selectedModel } ‚Äî unsaved changes
let localAvailable = false;

function fmtAgo(seconds) {
  if (!seconds) return 'never';
  if (seconds < 60) return `${seconds}s ago`;
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function statusMeta(agent) {
  if (!agent.gatewayUp) return { dot: 'dot-gray',   label: 'Offline',  color: 'var(--muted)' };
  if (agent.status === 'active')  return { dot: 'dot-green',  label: 'Active',   color: 'var(--green)' };
  if (agent.status === 'recent')  return { dot: 'dot-yellow', label: 'Idle',     color: 'var(--yellow)' };
  return { dot: 'dot-gray',   label: 'Idle',     color: 'var(--muted)' };
}

function renderAgentCard(agent) {
  const sm = statusMeta(agent);
  const draft = agentModelDraft[agent.id] ?? agent.model;
  const isDirty = draft !== agent.model;
  const channelStr = agent.channel ? ` ¬∑ ${agent.channel}` : '';

  const modelOptions = MODELS.map(m =>
    `<option value="${m.id}" ${draft === m.id ? 'selected' : ''}>${m.label}</option>`
  ).join('');

  const caps = (agent.capabilities || [])
    .map(c => `<span class="badge badge-muted">${c}</span>`)
    .join('');

  return `
  <div class="agent-card ${agent.status === 'active' ? 'agent-active' : ''}" id="card-${agent.id}">
    <div class="agent-header">
      <div class="agent-emoji">${agent.emoji}</div>
      <div>
        <div class="agent-name">${agent.name}</div>
        <div class="agent-role">${agent.role}</div>
      </div>
    </div>
    <div class="agent-status-row">
      <div class="dot ${sm.dot}"></div>
      <span style="color:${sm.color}">${sm.label}</span>
      <span style="color:var(--muted)">${channelStr}</span>
    </div>
    <div class="agent-last-active">Last active: ${fmtAgo(agent.lastActiveAgo)}</div>
    <div class="agent-caps">${caps}</div>
    <div class="agent-model-row">
      <span class="agent-model-label">Model</span>
      <select class="model-select" id="model-select-${agent.id}"
        onchange="onModelChange('${agent.id}', this.value)">
        ${modelOptions}
      </select>
      <button class="model-save-btn" id="model-save-${agent.id}"
        onclick="saveModel('${agent.id}')"
        ${isDirty ? '' : 'disabled'}>
        Save
      </button>
    </div>
  </div>`;
}

function renderAgents(data) {
  const grid = document.getElementById('agent-grid');
  if (!grid) return;
  grid.innerHTML = data.agents.map(renderAgentCard).join('');

  // System status table
  const tbody = document.getElementById('system-status-body');
  if (tbody) {
    const gw = data.gatewayStatus === 'running';
    tbody.innerHTML = `
      <tr><td>Gateway</td>
          <td><span class="badge ${gw ? 'badge-green' : 'badge-red'}">${gw ? 'Running' : 'Stopped'}</span></td>
          <td style="color:var(--muted);font-size:0.78rem">ws://127.0.0.1:18789 ¬∑ Telegram connected</td></tr>
      <tr><td>Memory</td>
          <td><span class="badge badge-green">Active</span></td>
          <td style="color:var(--muted);font-size:0.78rem">memory-lancedb ¬∑ text-embedding-3-small</td></tr>
      <tr><td>JT API</td>
          <td><span class="badge badge-green">Working</span></td>
          <td style="color:var(--muted);font-size:0.78rem">Pave ¬∑ grant key valid ¬∑ Org 22NeVb7CK2sW</td></tr>
      <tr><td>Google Workspace</td>
          <td><span class="badge badge-green">Connected</span></td>
          <td style="color:var(--muted);font-size:0.78rem">assistant@codydesignbuild.com</td></tr>
      <tr><td>Local Status API</td>
          <td><span class="badge badge-green">Online</span></td>
          <td style="color:var(--muted);font-size:0.78rem">127.0.0.1:18900 ¬∑ live data</td></tr>`;
  }
}

function renderAgentsFallback() {
  const grid = document.getElementById('agent-grid');
  if (grid) {
    grid.innerHTML = `<div style="color:var(--muted);font-size:0.82rem;padding:1.5rem;grid-column:1/-1;text-align:center">
      ‚ö†Ô∏è Local status server unreachable (port 18900).<br>
      Live status only available when on the Mac mini or local network.
    </div>`;
  }
}

function setLiveBadge(live) {
  const badge = document.getElementById('agents-live-badge');
  if (!badge) return;
  badge.innerHTML = live
    ? `<div class="dot dot-green"></div><span style="color:var(--green)">Live</span>`
    : `<div class="dot dot-gray"></div><span>Offline ‚Äî remote view</span>`;
}

async function fetchAgents() {
  try {
    const res = await fetch(`${LOCAL_API}/api/agents`, { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    agentsData = data;
    localAvailable = true;
    setLiveBadge(true);
    renderAgents(data);
  } catch {
    localAvailable = false;
    setLiveBadge(false);
    if (!agentsData) renderAgentsFallback();
  }
}

function onModelChange(agentId, value) {
  agentModelDraft[agentId] = value;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) btn.disabled = (value === (agentsData?.agents?.find(a => a.id === agentId)?.model));
}

async function saveModel(agentId) {
  const model = agentModelDraft[agentId];
  if (!model) return;
  const btn = document.getElementById(`model-save-${agentId}`);
  if (btn) { btn.disabled = true; btn.textContent = 'Saving‚Ä¶'; }
  try {
    const res = await fetch(`${LOCAL_API}/api/agents/${agentId}/model`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model }),
      signal: AbortSignal.timeout(5000),
    });
    const data = await res.json();
    if (data.ok) {
      delete agentModelDraft[agentId];
      if (btn) { btn.textContent = '‚úì Saved'; setTimeout(() => { if (btn) { btn.textContent = 'Save'; } }, 2000); }
      // Refresh agents after a tick
      setTimeout(fetchAgents, 300);
    } else {
      if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
    }
  } catch {
    if (btn) { btn.disabled = false; btn.textContent = 'Error'; }
  }
}

// Initial load + poll every 10 seconds
fetchAgents();
setInterval(fetchAgents, 10 * 1000);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TASKS ‚Äî Project-based Kanban
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ Project config (source of truth ‚Äî add new projects here) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROJECTS_CONFIG = [
  { id:'balboa',   name:'Balboa',             group:'jobs', icon:'üè†' },
  { id:'teresita', name:'Teresita',            group:'jobs', icon:'üè†' },
  { id:'25th-ave', name:'25th Ave',            group:'jobs', icon:'üè†' },
  { id:'mc-dev',   name:'Mission Control Dev', group:'dev',  icon:'üíª' },
  { id:'hytale',   name:'Hytale Mod',          group:'dev',  icon:'üéÆ' },
];

// User-added projects stored in localStorage
function getCustomProjects() {
  try { return JSON.parse(localStorage.getItem('mc_projects') || '[]'); } catch { return []; }
}
function saveCustomProjects(list) { localStorage.setItem('mc_projects', JSON.stringify(list)); }

function allProjects() {
  return [...PROJECTS_CONFIG, ...getCustomProjects()];
}

function projectByName(name) {
  return allProjects().find(p => p.name === name) || null;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allTasks    = [];
let taskView    = 'kanban';
let selProject  = null;    // null=All, '__jobs__', '__dev__', '__org__', or project id
let tasksLoaded = false;

const PRI_ORDER = { Urgent:0, High:1, Medium:2, Low:3 };
function priClass(p) {
  return { Urgent:'pri-urgent', High:'pri-high', Medium:'pri-medium', Low:'pri-low' }[p] || 'pri-low';
}
function fmtDateShort(d) {
  if (!d) return '';
  const [,m,day] = d.split('-');
  return `${parseInt(m)}/${parseInt(day)}`;
}

// ‚îÄ‚îÄ Project switcher rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProjectSwitcher() {
  const projs = allProjects();
  const jobs  = projs.filter(p => p.group === 'jobs');
  const devs  = projs.filter(p => p.group === 'dev');
  const orgs  = projs.filter(p => p.group === 'org' || p.group === 'other');

  function pill(id, label, extraClass='') {
    const active = selProject === id ? 'active' : '';
    return `<button class="proj-pill ${extraClass} ${active}" onclick="selectProject('${id}')">${label}</button>`;
  }

  let html = pill(null, 'üóÇÔ∏è All');
  html += '<div class="proj-sep"></div>';
  html += pill('__jobs__', 'üèóÔ∏è Jobs', 'group');
  jobs.forEach(p => { html += pill(p.id, p.name); });
  if (devs.length || orgs.filter(p=>p.group==='dev').length) {
    html += '<div class="proj-sep"></div>';
    html += pill('__dev__', 'üíª Dev', 'group');
    devs.forEach(p => { html += pill(p.id, p.name); });
  }
  html += '<div class="proj-sep"></div>';
  html += pill('__org__', 'üè¢ Org', 'group');
  orgs.filter(p => p.group === 'org').forEach(p => { html += pill(p.id, p.name); });
  html += '<div class="proj-sep"></div>';
  html += `<button class="proj-add" onclick="openNewProject()">+ New Project</button>`;

  document.getElementById('project-switcher').innerHTML = html;
}

function selectProject(id) {
  selProject = id === 'null' || id === null ? null : id;
  renderProjectSwitcher();
  renderTasks();
}

// ‚îÄ‚îÄ Task filtering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterByProject(tasks) {
  if (selProject === null) return tasks;
  if (selProject === '__jobs__') {
    const jobNames = allProjects().filter(p => p.group === 'jobs').map(p => p.name);
    return tasks.filter(t => jobNames.includes(t.job));
  }
  if (selProject === '__dev__') {
    const devNames = allProjects().filter(p => p.group === 'dev').map(p => p.name);
    return tasks.filter(t => devNames.includes(t.job));
  }
  if (selProject === '__org__') {
    const nonOrgNames = allProjects().filter(p => p.group !== 'org').map(p => p.name);
    return tasks.filter(t => !t.job || !nonOrgNames.includes(t.job));
  }
  // Specific project id
  const proj = allProjects().find(p => p.id === selProject);
  if (!proj) return tasks;
  return tasks.filter(t => t.job === proj.name);
}

// ‚îÄ‚îÄ Main render dispatcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTasks() {
  const content = document.getElementById('tasks-content');
  if (!content) return;

  const filtered = filterByProject(allTasks);

  // Jobs group ‚Üí multi-board
  if (selProject === '__jobs__') {
    renderMultiBoard(filtered, content);
    return;
  }

  if (taskView === 'kanban') {
    content.innerHTML = `<div class="kanban-board" id="tasks-kanban"></div>`;
    renderKanban(filtered, document.getElementById('tasks-kanban'));
  } else {
    content.innerHTML = `<div id="tasks-list"></div>`;
    renderList(filtered, document.getElementById('tasks-list'));
  }
}

function setTaskView(view) {
  taskView = view;
  document.getElementById('view-kanban-btn').classList.toggle('active', view === 'kanban');
  document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
  renderTasks();
}

// ‚îÄ‚îÄ Kanban ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NEXT_STATUS = {
  'To Do':       [{ label:'‚ñ∂ Start', status:'In Progress' }, { label:'‚úó Block', status:'Blocked' }],
  'In Progress': [{ label:'‚úì Done',  status:'Done'        }, { label:'‚úó Block', status:'Blocked' }],
  'Blocked':     [{ label:'‚ñ∂ Resume',status:'In Progress' }, { label:'‚úì Done',  status:'Done' }],
  'Done':        [{ label:'‚Ü© Reopen',status:'To Do'       }],
};

function renderKanban(tasks, container) {
  const cols = {
    'To Do':       { key:'col-todo',     label:'To Do',       cards:[] },
    'In Progress': { key:'col-progress', label:'In Progress', cards:[] },
    'Blocked':     { key:'col-blocked',  label:'Blocked',     cards:[] },
    'Done':        { key:'col-done',     label:'Done',        cards:[] },
  };
  tasks.forEach(t => { if (cols[t.status]) cols[t.status].cards.push(t); });

  container.innerHTML = Object.values(cols).map(col => {
    const cards = col.cards
      .sort((a,b) => (PRI_ORDER[a.priority]??3) - (PRI_ORDER[b.priority]??3))
      .map(t => buildCard(t, false)).join('');

    const addBtn = col.key !== 'col-done'
      ? `<div class="inline-add" onclick="openAddTask({status:'${col.label}'})"><span>+</span> Add</div>`
      : '';

    return `<div class="kanban-col ${col.key} kanban-drop-zone"
        data-status="${col.label}"
        ondragover="onColDragOver(event)" ondragenter="onColDragEnter(event)"
        ondragleave="onColDragLeave(event)" ondrop="onColDrop(event)">
      <div class="kanban-col-header">
        <span>${col.label}</span>
        <span class="kanban-count">${col.cards.length}</span>
      </div>
      ${cards}${addBtn}
    </div>`;
  }).join('');
}

function buildCard(t, mini) {
  const proj = projectByName(t.job);
  const showProject = (selProject === null || selProject === '__jobs__' || selProject === '__dev__') && t.job;
  const nextBtns = !mini ? (NEXT_STATUS[t.status] || [])
    .map(n => `<button class="status-btn" onclick="event.stopPropagation();quickComplete('${t.id}','${n.status}')">${n.label}</button>`)
    .join('') : '';

  if (mini) {
    return `<div class="mini-card" draggable="true"
        data-task-id="${t.id}" data-status="${escHtml(t.status)}"
        ondragstart="onCardDragStart(event)" ondragend="onCardDragEnd(event)"
        onclick="openEditTask('${t.id}')">
      ${escHtml(t.name)}
      <div class="mini-card-meta">
        <span class="badge pri-badge ${priClass(t.priority)}" style="font-size:0.58rem">${t.priority}</span>
        ${t.assignee ? `<span style="font-size:0.62rem;color:var(--muted)">${t.assignee}</span>` : ''}
      </div>
    </div>`;
  }

  return `<div class="task-card" draggable="true" data-task-id="${t.id}" data-status="${escHtml(t.status)}"
      ondragstart="onCardDragStart(event)" ondragend="onCardDragEnd(event)">
    <div class="task-card-name" onclick="openEditTask('${t.id}')">${escHtml(t.name)}</div>
    <div class="task-card-meta">
      <span class="badge pri-badge ${priClass(t.priority)}">${t.priority}</span>
      ${showProject ? `<span class="task-card-tag">${proj ? proj.icon : 'üìå'} ${escHtml(t.job)}</span>` : ''}
      ${t.assignee ? `<span class="task-card-tag">üë§ ${t.assignee}</span>` : ''}
      ${t.dueDate ? `<span class="task-card-tag">üìÖ ${fmtDateShort(t.dueDate)}</span>` : ''}
    </div>
    ${nextBtns ? `<div class="task-card-actions">${nextBtns}</div>` : ''}
  </div>`;
}

// ‚îÄ‚îÄ Multi-board (Jobs group) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMultiBoard(tasks, container) {
  const jobs = allProjects().filter(p => p.group === 'jobs');
  if (!jobs.length) {
    container.innerHTML = '<div class="state-loading">No job projects configured.</div>';
    return;
  }

  container.innerHTML = `<div class="multi-board">${jobs.map(proj => {
    const jobTasks = tasks.filter(t => t.job === proj.name);
    const statuses = ['To Do','In Progress','Blocked','Done'];
    const colKeys  = ['col-todo','col-progress','col-blocked','col-done'];
    const cols = statuses.map((s, i) => {
      const cards = jobTasks.filter(t => t.status === s);
      return `<div class="mini-col ${colKeys[i]} kanban-drop-zone" data-status="${s}"
            ondragover="onColDragOver(event)" ondragenter="onColDragEnter(event)"
            ondragleave="onColDragLeave(event)" ondrop="onColDrop(event)">
          <div class="mini-col-header">
            <span>${s}</span>
            <span class="kanban-count">${cards.length || ''}</span>
          </div>
          ${cards.map(t => buildCard(t, true)).join('') || `<div class="mini-empty">Empty</div>`}
        </div>`;
    }).join('');
    return `<div class="mini-board">
      <div class="mini-board-header">
        <span class="mini-board-title">${proj.icon} ${escHtml(proj.name)}</span>
        <button class="mini-board-add" onclick="openAddTask({project:'${proj.id}'})">+ Add task</button>
      </div>
      <div class="mini-kanban">${cols}</div>
    </div>`;
  }).join('')}</div>`;
}

// ‚îÄ‚îÄ List view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(tasks, container) {
  const groups = {};
  tasks.forEach(t => {
    const key = t.job || 'üè¢ Org';
    if (!groups[key]) groups[key] = [];
    groups[key].push(t);
  });

  const sortedKeys = Object.keys(groups).sort((a,b) => {
    if (a === 'üè¢ Org') return -1;
    if (b === 'üè¢ Org') return 1;
    return a.localeCompare(b);
  });

  container.innerHTML = sortedKeys.map(key => {
    const sorted = groups[key].sort((a,b) => (PRI_ORDER[a.priority]??3) - (PRI_ORDER[b.priority]??3));
    const rows = sorted.map(t => {
      const done = t.status === 'Done';
      return `<div class="task-row" onclick="openEditTask('${t.id}')">
        <div class="task-row-check ${done?'done':''}" onclick="event.stopPropagation();quickComplete('${t.id}','${done?'To Do':'Done'}')">${done?'‚úì':''}</div>
        <div class="task-row-name ${done?'done-text':''}">${escHtml(t.name)}</div>
        <div class="task-row-right">
          <span class="badge pri-badge ${priClass(t.priority)}">${t.priority}</span>
          ${t.assignee ? `<span style="font-size:0.72rem;color:var(--muted)">${t.assignee}</span>` : ''}
          ${t.dueDate ? `<span style="font-size:0.72rem;color:var(--muted)">üìÖ ${fmtDateShort(t.dueDate)}</span>` : ''}
        </div>
      </div>`;
    }).join('');
    const proj = projectByName(key);
    return `<div class="tasks-list-group">
      <div class="tasks-list-group-header">${proj ? proj.icon + ' ' : ''}${key}</div>
      ${rows}
    </div>`;
  }).join('') || '<div class="state-loading">No tasks found.</div>';
}

// ‚îÄ‚îÄ Drag and drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _dragTaskId = null;
function onCardDragStart(e) {
  _dragTaskId = e.currentTarget.dataset.taskId;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _dragTaskId);
}
function onCardDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.kanban-col,.mini-col').forEach(c => c.classList.remove('drag-over'));
  _dragTaskId = null;
}
function onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function onColDragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function onColDragLeave(e) { if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over'); }
function onColDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const taskId = e.dataTransfer.getData('text/plain') || _dragTaskId;
  const newStatus = e.currentTarget.dataset.status;
  if (taskId && newStatus) quickComplete(taskId, newStatus);
}

// ‚îÄ‚îÄ Fetch + quick complete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchTasks() {
  try {
    const res = await fetch('/api/tasks');
    const data = await res.json();
    if (data.tasks) {
      allTasks = data.tasks;
      tasksLoaded = true;
      renderProjectSwitcher();
      renderTasks();
    }
  } catch (err) {
    if (!tasksLoaded) {
      const c = document.getElementById('tasks-content');
      if (c) c.innerHTML = `<div class="state-error">Failed to load tasks: ${err.message}</div>`;
    }
  }
}
setInterval(fetchTasks, 30 * 1000);

async function quickComplete(id, newStatus) {
  const t = allTasks.find(x => x.id === id);
  if (t) t.status = newStatus;
  renderTasks();
  try {
    await fetch(`/api/tasks?id=${id}`, {
      method:'PATCH', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ status: newStatus })
    });
  } catch {}
}

// ‚îÄ‚îÄ Add / Edit modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _editTaskId = null;

function populateProjectDropdown(selectedName) {
  const sel = document.getElementById('t-project');
  if (!sel) return;
  const projs = allProjects();
  sel.innerHTML = `<option value="">‚Äî None (Org) ‚Äî</option>` +
    projs.map(p => `<option value="${escHtml(p.name)}" ${selectedName===p.name?'selected':''}>${p.icon} ${escHtml(p.name)}</option>`).join('');
}

function openAddTask(preset = {}) {
  _editTaskId = null;
  document.querySelector('#add-task-modal .modal-title').textContent = 'New Task';
  document.getElementById('add-task-submit-btn').textContent = 'Add Task';
  document.getElementById('add-task-submit-btn').onclick = submitAddTask;
  document.getElementById('add-task-delete-btn').style.display = 'none';

  document.getElementById('t-name').value     = preset.name     || '';
  document.getElementById('t-desc').value     = preset.desc     || '';
  document.getElementById('t-status').value   = preset.status   || 'To Do';
  document.getElementById('t-priority').value = preset.priority || 'Medium';
  document.getElementById('t-assignee').value = preset.assignee || '';
  document.getElementById('t-due').value      = preset.dueDate  || '';

  // Auto-fill project from current selection or preset
  let projName = preset.project
    ? (allProjects().find(p => p.id === preset.project)?.name || '')
    : (selProject && selProject !== '__jobs__' && selProject !== '__dev__' && selProject !== '__org__'
        ? (allProjects().find(p => p.id === selProject)?.name || '') : '');
  populateProjectDropdown(projName);

  document.getElementById('add-task-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('t-name').focus(), 80);
}

function closeAddTask() {
  _editTaskId = null;
  document.getElementById('add-task-modal').classList.add('hidden');
}

async function submitAddTask() {
  const name = document.getElementById('t-name').value.trim();
  if (!name) { document.getElementById('t-name').focus(); return; }
  const btn = document.getElementById('add-task-submit-btn');
  btn.disabled = true; btn.textContent = 'Adding‚Ä¶';
  const job = document.getElementById('t-project').value;
  try {
    const res = await fetch('/api/tasks', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name, description: document.getElementById('t-desc').value.trim(),
        status:   document.getElementById('t-status').value,
        priority: document.getElementById('t-priority').value,
        assignee: document.getElementById('t-assignee').value || null,
        dueDate:  document.getElementById('t-due').value || null,
        job: job || null,
        level: job ? 'Job' : 'Org',
      })
    });
    const data = await res.json();
    if (data.ok) { closeAddTask(); fetchTasks(); }
    else { btn.disabled = false; btn.textContent = 'Error ‚Äî retry'; }
  } catch { btn.disabled = false; btn.textContent = 'Error ‚Äî retry'; }
}

function openEditTask(id) {
  const t = allTasks.find(x => x.id === id);
  if (!t) return;
  _editTaskId = id;
  document.querySelector('#add-task-modal .modal-title').textContent = 'Edit Task';
  document.getElementById('add-task-submit-btn').textContent = 'Save Changes';
  document.getElementById('add-task-submit-btn').onclick = submitEditTask;
  document.getElementById('add-task-delete-btn').style.display = 'block';
  document.getElementById('t-name').value     = t.name || '';
  document.getElementById('t-desc').value     = t.description || '';
  document.getElementById('t-status').value   = t.status || 'To Do';
  document.getElementById('t-priority').value = t.priority || 'Medium';
  document.getElementById('t-assignee').value = t.assignee || '';
  document.getElementById('t-due').value      = t.dueDate || '';
  populateProjectDropdown(t.job || '');
  document.getElementById('add-task-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('t-name').focus(), 80);
}

async function submitEditTask() {
  if (!_editTaskId) return;
  const btn = document.getElementById('add-task-submit-btn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  const job = document.getElementById('t-project').value;
  try {
    const res = await fetch(`/api/tasks?id=${_editTaskId}`, {
      method:'PATCH', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name:        document.getElementById('t-name').value.trim(),
        description: document.getElementById('t-desc').value.trim(),
        status:      document.getElementById('t-status').value,
        priority:    document.getElementById('t-priority').value,
        assignee:    document.getElementById('t-assignee').value || null,
        dueDate:     document.getElementById('t-due').value || null,
        job: job || null,
        level: job ? 'Job' : 'Org',
      })
    });
    const data = await res.json();
    if (data.ok) { closeAddTask(); fetchTasks(); }
    else { btn.disabled = false; btn.textContent = 'Error'; }
  } catch { btn.disabled = false; btn.textContent = 'Error'; }
}

async function deleteCurrentTask() {
  if (!_editTaskId || !confirm('Delete this task?')) return;
  try {
    await fetch(`/api/tasks?id=${_editTaskId}`, { method:'DELETE' });
    closeAddTask(); fetchTasks();
  } catch {}
}

// ‚îÄ‚îÄ New Project modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNewProject() {
  document.getElementById('np-name').value = '';
  document.getElementById('np-type').value = 'jobs';
  document.getElementById('new-project-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('np-name').focus(), 80);
}
function closeNewProject() { document.getElementById('new-project-modal').classList.add('hidden'); }
function submitNewProject() {
  const name = document.getElementById('np-name').value.trim();
  const type = document.getElementById('np-type').value;
  if (!name) { document.getElementById('np-name').focus(); return; }
  const icons = { jobs:'üè†', dev:'üíª', org:'üè¢', other:'üìå' };
  const custom = getCustomProjects();
  const id = name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  if (!custom.find(p => p.id === id)) {
    custom.push({ id, name, group: type === 'org' || type === 'other' ? type : type, icon: icons[type] || 'üìå' });
    saveCustomProjects(custom);
  }
  closeNewProject();
  renderProjectSwitcher();
}

// Close modals on overlay click + Escape
['add-task-modal','new-project-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => { if (e.target.id === id) document.getElementById(id).classList.add('hidden'); });
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('add-task-modal').classList.add('hidden');
    document.getElementById('new-project-modal').classList.add('hidden');
  }
});

// Fetch tasks on load
fetchTasks();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONTACTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let allContacts = [];
let contactFilter = '';
let contactSearchTerm = '';
let _editContactId = null;
let _searchTimer = null;

const TYPE_COLORS = {
  client:'type-client', subcontractor:'type-subcontractor',
  vendor:'type-vendor', personal:'type-personal', professional:'type-professional',
  trade_partner:'type-vendor', lead:'type-professional',
};

function initials(c) {
  const f = c.first_name?.[0] || '';
  const l = c.last_name?.[0]  || '';
  return (f + l).toUpperCase() || (c.company?.[0] || '?').toUpperCase();
}

function copyField(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = '‚úì';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã'; btn.classList.remove('copied'); }, 1500);
  });
}

function renderContacts(contacts) {
  const list  = document.getElementById('contacts-list');
  const count = document.getElementById('contacts-count');
  if (!contacts.length) {
    list.innerHTML = '<div class="contact-empty">No contacts found.</div>';
    count.textContent = '';
    return;
  }
  count.textContent = `${contacts.length} contact${contacts.length !== 1 ? 's' : ''}`;

  list.innerHTML = contacts.map(c => {
    const name    = [c.first_name, c.last_name].filter(Boolean).join(' ') || c.company || '(unnamed)';
    const sub     = [c.company, c.title].filter(Boolean).join(' ¬∑ ');
    const types   = (c.types || []).map(t => `<span class="contact-badge ${TYPE_COLORS[t]||''}">${t}</span>`).join('');
    const trades  = (c.trades || []).map(t => `<span class="contact-badge">${t}</span>`).join('');

    const fields = [];
    if (c.phone)    fields.push({ label:'Phone',   value:`<a href="tel:${c.phone}">${c.phone}</a>`, copy: c.phone });
    if (c.phone_alt)fields.push({ label:'Phone 2', value:`<a href="tel:${c.phone_alt}">${c.phone_alt}</a>`, copy: c.phone_alt });
    if (c.email)    fields.push({ label:'Email',   value:`<a href="mailto:${c.email}">${c.email}</a>`, copy: c.email });
    if (c.company)  fields.push({ label:'Company', value:escHtml(c.company), copy: c.company });
    if (c.address)  fields.push({ label:'Address', value:escHtml([c.address,c.city,c.state,c.zip].filter(Boolean).join(', ')), copy:[c.address,c.city,c.state,c.zip].filter(Boolean).join(', ') });
    if (c.license_number) fields.push({ label:'License', value:escHtml(c.license_number) + (c.license_expiry?` <span style="color:var(--muted);font-size:0.7rem">exp ${c.license_expiry.slice(0,10)}</span>`:''), copy: c.license_number });
    if (c.coi_expiry) fields.push({ label:'COI Exp', value:c.coi_expiry.slice(0,10), copy: c.coi_expiry.slice(0,10) });
    if (c.rating)   fields.push({ label:'Rating',  value:'‚òÖ'.repeat(c.rating)+'‚òÜ'.repeat(5-c.rating), copy: String(c.rating) });
    if (c.notes)    fields.push({ label:'Notes',   value:`<span style="color:var(--muted)">${escHtml(c.notes)}</span>`, copy: c.notes });

    const fieldRows = fields.map(f => `
      <div class="contact-field">
        <span class="contact-field-label">${f.label}</span>
        <span class="contact-field-value">${f.value}${f.copy ? ` <button class="copy-btn" onclick="copyField(${JSON.stringify(f.copy)},this)">üìã</button>` : ''}</span>
      </div>`).join('');

    return `<div class="contact-card" id="cc-${c.id}">
      <div class="contact-card-header" onclick="toggleContact('${c.id}')">
        <div class="contact-avatar">${escHtml(initials(c))}</div>
        <div style="flex:1;min-width:0">
          <div class="contact-card-name">${escHtml(name)}</div>
          ${sub ? `<div class="contact-card-sub">${escHtml(sub)}</div>` : ''}
          <div class="contact-card-badges">${types}${trades}</div>
        </div>
        ${c.phone ? `<a href="tel:${c.phone}" onclick="event.stopPropagation()" style="font-size:1.1rem;text-decoration:none" title="${c.phone}">üìû</a>` : ''}
      </div>
      <div class="contact-expand" id="cx-${c.id}">
        ${fieldRows}
        <div class="contact-expand-actions">
          <button class="btn" style="font-size:0.75rem;padding:0.3rem 0.75rem" onclick="openEditContact('${c.id}')">Edit</button>
          ${c.phone ? `<button class="btn-cancel" style="font-size:0.75rem" onclick="copyField('${c.phone}',this)">üìã Copy Phone</button>` : ''}
          ${c.email ? `<a href="mailto:${c.email}" class="btn-cancel" style="font-size:0.75rem;text-decoration:none">‚úâÔ∏è Email</a>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleContact(id) {
  const el = document.getElementById(`cx-${id}`);
  if (!el) return;
  const isOpen = el.classList.contains('open');
  document.querySelectorAll('.contact-expand.open').forEach(e => e.classList.remove('open'));
  if (!isOpen) el.classList.add('open');
}

async function fetchContacts(search = '', type = '') {
  try {
    const params = new URLSearchParams({ limit: 500 });
    if (search) params.set('search', search);
    if (type)   params.set('type', type);
    const res = await fetch(`/api/contacts?${params}`);
    const data = await res.json();
    allContacts = data.contacts || [];
    renderContacts(allContacts);
  } catch (err) {
    document.getElementById('contacts-list').innerHTML = `<div class="state-error">Failed to load: ${err.message}</div>`;
  }
}

function setContactFilter(type, btn) {
  contactFilter = type;
  document.querySelectorAll('.contacts-type-pills .pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  fetchContacts(contactSearchTerm, contactFilter);
}

function debounceContactSearch() {
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(() => {
    contactSearchTerm = document.getElementById('contacts-search').value.trim();
    fetchContacts(contactSearchTerm, contactFilter);
  }, 300);
}

// ‚îÄ‚îÄ Add/Edit modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddContact() {
  _editContactId = null;
  document.getElementById('contact-modal-title').textContent = 'New Contact';
  document.getElementById('cm-submit-btn').textContent = 'Add Contact';
  document.getElementById('cm-delete-btn').style.display = 'none';
  ['first','last','phone','email','company','title','types','trades','rating','source','notes'].forEach(f => {
    const el = document.getElementById(`cm-${f}`);
    if (el) el.value = '';
  });
  document.getElementById('cm-verified').checked = false;
  document.getElementById('contact-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('cm-first').focus(), 80);
}

function openEditContact(id) {
  const c = allContacts.find(x => x.id === id);
  if (!c) return;
  _editContactId = id;
  document.getElementById('contact-modal-title').textContent = 'Edit Contact';
  document.getElementById('cm-submit-btn').textContent = 'Save Changes';
  document.getElementById('cm-delete-btn').style.display = 'block';
  document.getElementById('cm-first').value   = c.first_name || '';
  document.getElementById('cm-last').value    = c.last_name  || '';
  document.getElementById('cm-phone').value   = c.phone      || '';
  document.getElementById('cm-email').value   = c.email      || '';
  document.getElementById('cm-company').value = c.company    || '';
  document.getElementById('cm-title').value   = c.title      || '';
  document.getElementById('cm-types').value   = (c.types  || []).join(', ');
  document.getElementById('cm-trades').value  = (c.trades || []).join(', ');
  document.getElementById('cm-rating').value  = c.rating     || '';
  document.getElementById('cm-source').value  = c.source     || '';
  document.getElementById('cm-notes').value   = c.notes      || '';
  document.getElementById('cm-verified').checked = !!c.is_verified;
  document.getElementById('contact-modal').classList.remove('hidden');
}

function closeContactModal() {
  _editContactId = null;
  document.getElementById('contact-modal').classList.add('hidden');
}

function parseTags(str) {
  return str.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
}

async function submitContactModal() {
  const btn = document.getElementById('cm-submit-btn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  const body = {
    first_name:   document.getElementById('cm-first').value.trim()   || null,
    last_name:    document.getElementById('cm-last').value.trim()    || null,
    phone:        document.getElementById('cm-phone').value.trim()   || null,
    email:        document.getElementById('cm-email').value.trim()   || null,
    company:      document.getElementById('cm-company').value.trim() || null,
    title:        document.getElementById('cm-title').value.trim()   || null,
    types:        parseTags(document.getElementById('cm-types').value),
    trades:       parseTags(document.getElementById('cm-trades').value),
    rating:       parseInt(document.getElementById('cm-rating').value) || null,
    source:       document.getElementById('cm-source').value.trim()  || null,
    notes:        document.getElementById('cm-notes').value.trim()   || null,
    is_verified:  document.getElementById('cm-verified').checked,
  };
  try {
    const method = _editContactId ? 'PATCH' : 'POST';
    const url    = _editContactId ? `/api/contacts?id=${_editContactId}` : '/api/contacts';
    const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json();
    if (data.ok) { closeContactModal(); fetchContacts(contactSearchTerm, contactFilter); }
    else { btn.disabled = false; btn.textContent = 'Error ‚Äî retry'; }
  } catch { btn.disabled = false; btn.textContent = 'Error ‚Äî retry'; }
}

async function deleteCurrentContact() {
  if (!_editContactId || !confirm('Archive this contact?')) return;
  await fetch(`/api/contacts?id=${_editContactId}`, { method:'DELETE' });
  closeContactModal();
  fetchContacts(contactSearchTerm, contactFilter);
}

// Close on overlay click / Escape
document.getElementById('contact-modal').addEventListener('click', e => {
  if (e.target.id === 'contact-modal') closeContactModal();
});

// Contacts load triggered by showTab above
</script>
</body>
</html>
