name: Deploy to Vercel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel (Production)
        id: deploy
        run: |
          OUTPUT=$(vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes 2>&1)
          echo "$OUTPUT"
          DEPLOY_URL=$(echo "$OUTPUT" | grep -oE 'https://mission-control-[a-z0-9]+-jerry-ocs-projects\.vercel\.app' | tail -1)
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Re-alias to custom domain
        if: steps.deploy.outputs.deploy_url != ''
        run: |
          vercel alias set "${{ steps.deploy.outputs.deploy_url }}" cdb-mission-control.vercel.app \
            --token ${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
